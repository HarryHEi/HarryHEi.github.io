<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Ben Wong,wenbinben@gmail.com"><title>C++ Primer · Harryx</title><meta name="description" content="拷贝控制拷贝赋值和销毁拷贝构造函数13.5
12345678910111213141516171819202122232425262728293031//注意，这里省略了 std::class HasPtr&amp;#123;public:    HasPtr(const string &amp;amp;s = s"><meta name="keywords" content="Hexo,HTML,Ben,CSS,安卓,android,Linux,linuxdeepin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Harryx</a></h3><div class="description"><p>good good study good good play~</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/harryx520"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/Booooyakasha"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="http://7xrooc.com1.z0.glb.clouddn.com/avatar.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>C++ Primer</a></h3></div><div class="post-content"><h1 id="拷贝控制"><a href="#拷贝控制" class="headerlink" title="拷贝控制"></a>拷贝控制</h1><h2 id="拷贝赋值和销毁"><a href="#拷贝赋值和销毁" class="headerlink" title="拷贝赋值和销毁"></a>拷贝赋值和销毁</h2><h3 id="拷贝构造函数"><a href="#拷贝构造函数" class="headerlink" title="拷贝构造函数"></a>拷贝构造函数</h3><p>13.5</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">//注意，这里省略了 std::</div><div class="line">class HasPtr</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    HasPtr(const string &amp;s = string()) : </div><div class="line">        ps(new string(s)), i(0) &#123;&#125;</div><div class="line">    HasPtr(const HasPtr &amp;hp);</div><div class="line">    void print() &#123;cout &lt;&lt; *ps &lt;&lt; endl;&#125;</div><div class="line">    void change(const string s) &#123;*ps = s;&#125;</div><div class="line">private:</div><div class="line">    string *ps;</div><div class="line">    int i;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">HasPtr::HasPtr(const HasPtr &amp;hp) :</div><div class="line">    ps(new string(*hp.ps)),</div><div class="line">    i(hp.i) &#123;&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    HasPtr a(&quot;hello&quot;);</div><div class="line">    HasPtr b = a;</div><div class="line">    a.print(); //hello</div><div class="line">    b.print(); // hello</div><div class="line">    a.change(&quot;world&quot;);</div><div class="line">    a.print(); // world</div><div class="line">    b.print(); // hello</div><div class="line">    b.change(&quot;asd&quot;);</div><div class="line">    a.print(); // world</div><div class="line">    b.print(); //asd</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="拷贝赋值运算符"><a href="#拷贝赋值运算符" class="headerlink" title="拷贝赋值运算符"></a>拷贝赋值运算符</h3><p>13.8</p>
<p>重载赋值运算符，返回类型是当前对象的引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">class HasPtr</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    HasPtr(const string &amp;s = string()) : </div><div class="line">        ps(new string(s)), i(0) &#123;&#125;</div><div class="line">    HasPtr(const HasPtr &amp;hp);</div><div class="line">    HasPtr &amp;operator=(const HasPtr &amp;hp);</div><div class="line">    void print() &#123;cout &lt;&lt; *ps &lt;&lt; endl;&#125;</div><div class="line">    void change(const string s) &#123;*ps = s;&#125;</div><div class="line">private:</div><div class="line">    string *ps;</div><div class="line">    int i;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">HasPtr::HasPtr(const HasPtr &amp;hp) :</div><div class="line">    ps(new string(*hp.ps)),</div><div class="line">    i(hp.i) &#123;&#125;</div><div class="line"></div><div class="line">//重载赋值运算符，返回类型是当前对象的引用</div><div class="line">HasPtr &amp;HasPtr::operator=(const HasPtr &amp;hp)</div><div class="line">&#123;</div><div class="line">    //防止hp和ps指向同一对象</div><div class="line">    auto newp = new string(*hp.ps); //存到临时变量</div><div class="line">    delete ps; //释放旧内存</div><div class="line">    ps = newp; //拷贝到本地</div><div class="line">    i = hp.i;</div><div class="line">    return *this;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    HasPtr a(&quot;hello&quot;);</div><div class="line">    HasPtr b;</div><div class="line">    b = a;</div><div class="line">    a.print(); //hello</div><div class="line">    b.print(); // hello</div><div class="line">    a.change(&quot;world&quot;);</div><div class="line">    a.print(); // world</div><div class="line">    b.print(); // hello</div><div class="line">    b.change(&quot;asd&quot;);</div><div class="line">    a.print(); // world</div><div class="line">    b.print(); //asd</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h3><p>初始化对象非static成员，释放对象使用的资源，销毁非static数据成员</p>
<p>没有返回值，不接收参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">class HasPtr</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    HasPtr(const string &amp;s = string()) : </div><div class="line">        ps(new string(s)), i(0) &#123;&#125;</div><div class="line">    ~HasPtr() &#123;delete ps;&#125; //析构函数</div><div class="line">    HasPtr(const HasPtr &amp;hp);</div><div class="line">    HasPtr &amp;operator=(const HasPtr &amp;hp);</div><div class="line">    string *val()&#123;return ps;&#125;</div><div class="line">    void print() &#123;cout &lt;&lt; *ps &lt;&lt; endl;&#125;</div><div class="line">    void change(const string s) &#123;*ps = s;&#125;</div><div class="line">private:</div><div class="line">    string *ps;</div><div class="line">    int i;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">HasPtr::HasPtr(const HasPtr &amp;hp) :</div><div class="line">    ps(new string(*hp.ps)),</div><div class="line">    i(hp.i) &#123;&#125;</div><div class="line"></div><div class="line">HasPtr &amp;HasPtr::operator=(const HasPtr &amp;hp)</div><div class="line">&#123;</div><div class="line">    auto newp = new string(*hp.ps);</div><div class="line">    delete ps;</div><div class="line">    ps = newp;</div><div class="line">    i = hp.i;</div><div class="line">    return *this;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回一个指针，指向string</div><div class="line">string *fun()</div><div class="line">&#123;</div><div class="line">    HasPtr hp(&quot;hello&quot;);</div><div class="line">    return hp.val();</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    string *p = fun(); //p指向一个已经被释放的string</div><div class="line">    cout &lt;&lt; *p &lt;&lt; endl; //报错，因为指针已经悬空</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="阻止拷贝"><a href="#阻止拷贝" class="headerlink" title="阻止拷贝"></a>阻止拷贝</h3><p>13.18</p>
<p>利用<code>static</code>数据成员给每个对象生成唯一的递增的数据成员</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">class Employee</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    Employee(const string s) : name(s),num(count)</div><div class="line">        &#123;count = count + 1;&#125;</div><div class="line">    void print() &#123;cout &lt;&lt; num &lt;&lt; &quot; : &quot; &lt;&lt; name &lt;&lt; endl;&#125;</div><div class="line">private:</div><div class="line">    string name;</div><div class="line">    int num;</div><div class="line">    static int count; //内部声明</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//static外部定义，注意没有static关键字</div><div class="line">int Employee::count = 0;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    Employee e1(&quot;a&quot;);</div><div class="line">    Employee e2(&quot;b&quot;);</div><div class="line">    Employee e3(&quot;c&quot;);</div><div class="line">    e1.print(); // 0 : a</div><div class="line">    e2.print(); // 1 : b</div><div class="line">    e3.print(); // 2 : c</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="拷贝控制和资源管理ka"><a href="#拷贝控制和资源管理ka" class="headerlink" title="拷贝控制和资源管理ka"></a>拷贝控制和资源管理ka</h2><h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>13.27</p>
<p>计数器保存在动态内存中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">class HasPtr</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    HasPtr(const string &amp;s = string()) : </div><div class="line">        ps(new string(s)), i(0), use(new size_t(0)) &#123;++ *use;&#125;</div><div class="line">    ~HasPtr(); </div><div class="line">    HasPtr(const HasPtr &amp;hp);</div><div class="line">    HasPtr &amp;operator=(const HasPtr &amp;hp);</div><div class="line">    string *val()&#123;return ps;&#125;</div><div class="line">    void print() &#123;cout &lt;&lt; *use &lt;&lt; &quot; &quot; &lt;&lt; *ps &lt;&lt; endl;&#125;</div><div class="line">    void change(const string s) &#123;*ps = s;&#125;</div><div class="line">private:</div><div class="line">    string *ps;</div><div class="line">    int i;</div><div class="line">    size_t *use;</div><div class="line">&#125;;</div><div class="line">//拷贝初始化，自增计数器</div><div class="line">HasPtr::HasPtr(const HasPtr &amp;hp) :</div><div class="line">    ps(new string(*hp.ps)),</div><div class="line">    i(hp.i), use(hp.use) &#123;++*use;&#125;</div><div class="line">//析构函数，自减计数器，计数器为0释放内存</div><div class="line">HasPtr::~HasPtr()</div><div class="line">&#123;</div><div class="line">    if (-- *use == 0)</div><div class="line">    &#123;</div><div class="line">        delete ps;</div><div class="line">        delete use;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//拷贝赋值运算符，右值自增，左值自减计数器</div><div class="line">HasPtr &amp;HasPtr::operator=(const HasPtr &amp;hp)</div><div class="line">&#123;</div><div class="line">    ++ *hp.use; //先自增，防止指向的是同一对象</div><div class="line">    if(-- *use == 0)</div><div class="line">    &#123;</div><div class="line">        delete ps;</div><div class="line">        delete use;</div><div class="line">    &#125;</div><div class="line">    ps = hp.ps;</div><div class="line">    i = hp.i;</div><div class="line">    use = hp.use;</div><div class="line">    return *this;</div><div class="line">&#125;</div><div class="line">//查看引用计数</div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    HasPtr a1(&quot;hello&quot;);</div><div class="line">    a1.print(); // 1</div><div class="line">    HasPtr a2(&quot;world&quot;);</div><div class="line">    a1.print(); // 1</div><div class="line">    a2.print(); // 1</div><div class="line">    HasPtr a3 = a1;</div><div class="line">    a1.print(); // 2</div><div class="line">    a2.print(); // 1</div><div class="line">    a3.print(); // 2</div><div class="line">    a3 = a2;</div><div class="line">    a1.print(); // 1</div><div class="line">    a2.print(); // 2</div><div class="line">    a3.print(); // 2</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="交换操作"><a href="#交换操作" class="headerlink" title="交换操作"></a>交换操作</h2><p>13.31</p>
<p>在赋值运算中调用swap</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">class HasPtr</div><div class="line">&#123;</div><div class="line">friend void swap(HasPtr &amp;hp1, HasPtr &amp;hp2);</div><div class="line">public:</div><div class="line">    HasPtr(const string &amp;s = string()) : </div><div class="line">        ps(new string(s)), i(0), use(new size_t(0)) &#123;++ *use;&#125;</div><div class="line">    ~HasPtr(); </div><div class="line">    HasPtr(const HasPtr &amp;hp);</div><div class="line">    HasPtr &amp;operator=(HasPtr hp);</div><div class="line">    bool operator&lt;(const HasPtr &amp;hp) const;</div><div class="line">    string *val()&#123;return ps;&#125;</div><div class="line">    void print() &#123;cout &lt;&lt; *ps &lt;&lt; endl;&#125;</div><div class="line">    void change(const string s) &#123;*ps = s;&#125;</div><div class="line">private:</div><div class="line">    string *ps;</div><div class="line">    int i;</div><div class="line">    size_t *use;</div><div class="line">&#125;;</div><div class="line">//拷贝初始化，同上</div><div class="line">HasPtr::HasPtr(const HasPtr &amp;hp) :</div><div class="line">    ps(new string(*hp.ps)),</div><div class="line">    i(hp.i), use(hp.use) &#123;++*use;&#125;</div><div class="line">//析构函数，同上</div><div class="line">HasPtr::~HasPtr()</div><div class="line">&#123;</div><div class="line">    if (-- *use == 0)</div><div class="line">    &#123;</div><div class="line">        delete ps;</div><div class="line">        delete use;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//使用swap重写拷贝赋值操作</div><div class="line">HasPtr &amp;HasPtr::operator=(HasPtr hp)</div><div class="line">&#123;  </div><div class="line">     //副本在脱离代码块时，自动调用析构函数释放内存</div><div class="line">    swap(*this, hp); //当前对象于一个副本交换</div><div class="line">    return *this;</div><div class="line">&#125;</div><div class="line">//&lt; 运算符，在调用sort时需要</div><div class="line">bool HasPtr::operator&lt;(const HasPtr &amp;hp) const</div><div class="line">&#123;</div><div class="line">    cout &lt;&lt; &quot;operator &lt; ...&quot; &lt;&lt; endl;</div><div class="line">    return *this -&gt; ps &lt; *hp.ps;</div><div class="line">&#125;</div><div class="line">//swap操作</div><div class="line">inline</div><div class="line">void swap(HasPtr &amp;hp1, HasPtr &amp;hp2)</div><div class="line">&#123;</div><div class="line">    //如果类没有自己的swap调用标准库的swap</div><div class="line">    //如果类有自己的swap，不会隐藏自己的swap</div><div class="line">    using std::swap; </div><div class="line">    swap(hp1.ps, hp2.ps);</div><div class="line">    swap(hp1.i, hp2.i);</div><div class="line">    cout &lt;&lt; &quot;swaped...&quot; &lt;&lt; endl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    HasPtr a1(&quot;hello&quot;);</div><div class="line">    HasPtr a2(&quot;world&quot;);</div><div class="line">    HasPtr a3(&quot;byebye&quot;);</div><div class="line">    vector&lt;HasPtr&gt; vhp&#123;a1, a2, a3&#125;;</div><div class="line">    sort(vhp.begin(), vhp.end()); //排序</div><div class="line">    /*</div><div class="line">        输出：这里调用了三次比较，四次swap拷贝赋值</div><div class="line">        operator &lt; ...</div><div class="line">        operator &lt; ...</div><div class="line">        swaped...</div><div class="line">        operator &lt; ...</div><div class="line">        swaped...</div><div class="line">        swaped...</div><div class="line">        swaped...</div><div class="line">    */</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="重载运算和类型转换"><a href="#重载运算和类型转换" class="headerlink" title="重载运算和类型转换"></a>重载运算和类型转换</h1><h2 id="重载运算符"><a href="#重载运算符" class="headerlink" title="重载运算符"></a>重载运算符</h2><p>14.2</p>
<p>重载Sales_data的输入、输出、加法和复合赋值运算符<br>重载相等运算符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">class Sales_data</div><div class="line">&#123;</div><div class="line">friend std::istream &amp;operator&gt;&gt;(std::istream &amp;is, Sales_data &amp;sd);</div><div class="line">friend std::ostream &amp;operator&lt;&lt;(std::ostream &amp;os, const Sales_data &amp;sd);</div><div class="line">friend Sales_data operator+(const Sales_data &amp;sd1, const Sales_data &amp;sd2);</div><div class="line">friend bool operator==(const Sales_data &amp;sd1, const Sales_data &amp;sd2);</div><div class="line">friend bool operator!=(const Sales_data &amp;sd1, const Sales_data &amp;sd2);</div><div class="line">//...省略...</div><div class="line">public:</div><div class="line">    Sales_data &amp;operator+=(const Sales_data&amp;);</div><div class="line">//...省略...</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//成员函数</div><div class="line">inline</div><div class="line">Sales_data&amp; Sales_data::operator+=(const Sales_data &amp;sd)</div><div class="line">&#123;</div><div class="line">    unit += sd.unit;</div><div class="line">    revenue += sd.revenue;</div><div class="line">    return *this;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//非成员函数</div><div class="line">istream &amp;operator&gt;&gt;(istream &amp;is, Sales_data &amp;sd)</div><div class="line">&#123;</div><div class="line">    double price = 0;</div><div class="line">    is &gt;&gt; sd.name &gt;&gt; sd.unit &gt;&gt; price;</div><div class="line">    if(is) //判断流是否发生错误</div><div class="line">        sd.revenue = price * sd.unit;</div><div class="line">    else //如果错误，赋值为默认状态</div><div class="line">        sd = Sales_data();</div><div class="line">    return is;</div><div class="line">&#125;</div><div class="line">ostream &amp;operator&lt;&lt;(ostream &amp;os, const Sales_data &amp;sd)</div><div class="line">&#123;</div><div class="line">    os &lt;&lt; sd.getname() &lt;&lt; &quot; &quot; &lt;&lt; sd.unit &lt;&lt; &quot; &quot;</div><div class="line">        &lt;&lt; sd.revenue &lt;&lt; &quot; &quot; &lt;&lt; sd.avg_price() &lt;&lt; &quot; num: &quot; &lt;&lt; sd.num;</div><div class="line">    return os;</div><div class="line">&#125;</div><div class="line">Sales_data operator+(const Sales_data &amp;sd1, const Sales_data &amp;sd2)</div><div class="line">&#123;</div><div class="line">    Sales_data sum = sd1;</div><div class="line">    sum += sd2;</div><div class="line">    return sum;</div><div class="line">&#125;</div><div class="line">bool operator==(const Sales_data &amp;sd1, const Sales_data &amp;sd2)</div><div class="line">&#123;</div><div class="line">    return sd1.name == sd2.name &amp;&amp;</div><div class="line">        sd1.unit == sd2.unit &amp;&amp;</div><div class="line">        sd1.revenue == sd2.revenue;</div><div class="line">&#125;</div><div class="line">bool operator!=(const Sales_data &amp;sd1, const Sales_data &amp;sd2)</div><div class="line">&#123;</div><div class="line">    return !(sd1 == sd2);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    Sales_data sd1, sd2;</div><div class="line">    cin &gt;&gt; sd1; //输入</div><div class="line">    cin &gt;&gt; sd2;</div><div class="line">    Sales_data sd3 = sd1 + sd2; //加</div><div class="line">    sd3 += sd1; //复合赋值</div><div class="line">    cout &lt;&lt; sd3 &lt;&lt; endl; //输出</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>14.18</p>
<p>比较运算符根据实际情况选择是否添加<br>给StrBlob添加比较运算符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">class StrBlob</div><div class="line">&#123;</div><div class="line">friend bool operator&lt;(const StrBlob &amp;sb1, const StrBlob &amp;sb2);</div><div class="line">//...</div><div class="line">&#125;;</div><div class="line">//非成员函数</div><div class="line">bool operator&lt;(const StrBlob &amp;sb1, const StrBlob &amp;sb2)</div><div class="line">&#123;</div><div class="line">    auto b1 = sb1.data -&gt; begin(), e1 = sb1.data -&gt; end();</div><div class="line">    auto b2 = sb2.data -&gt; begin(), e2 = sb2.data -&gt; end();</div><div class="line">    while (b1 != e1 &amp;&amp; b2 != e2)</div><div class="line">    &#123;</div><div class="line">        if (*b1 != *b2)</div><div class="line">            return *b1 &lt; *b2;</div><div class="line">        ++b1;</div><div class="line">        ++b2;</div><div class="line">    &#125;</div><div class="line">    return sb1.data -&gt; size() &lt; sb2.data -&gt; size();</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    StrBlob b1&#123;&quot;abc&quot;,&quot;afd&quot;&#125;;</div><div class="line">    StrBlob b2&#123;&quot;abc&quot;,&quot;afd&quot;,&quot;asd&quot;&#125;;</div><div class="line">    cout &lt;&lt; (b1 &lt; b2) &lt;&lt; endl; // 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>14.26</p>
<p>下标运算符通常定义两个版本，一个返回普通的引用，另一个是常量成员并且返回常量引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">class StrBlob</div><div class="line">&#123;</div><div class="line">//...</div><div class="line">    string &amp;operator[](size_t n);</div><div class="line">    const string &amp;operator[](size_t n) const;</div><div class="line">//...</div><div class="line">&#125;;</div><div class="line">//成员函数</div><div class="line">//普通版本</div><div class="line">string &amp;StrBlob::operator[](size_t n)</div><div class="line">&#123;</div><div class="line">    return (*data)[n];</div><div class="line">&#125;</div><div class="line">//常量版本</div><div class="line">const string &amp;StrBlob::operator[](size_t n) const</div><div class="line">&#123;</div><div class="line">    return (*data)[n];</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    StrBlob b&#123;&quot;abc&quot;,&quot;afd&quot;&#125;;</div><div class="line">    const StrBlob a(b);</div><div class="line">    a[1] = &quot;world&quot;; //错误，常量引用只读</div><div class="line">    b[1] = &quot;hello&quot;;</div><div class="line">    cout &lt;&lt; b[1] &lt;&lt; endl; // hello</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>14.30</p>
<p>给StrBlobPtr添加自增、自减和解引用运算符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">//先申明</div><div class="line">class StrBlobPtr;</div><div class="line">class StrBlob</div><div class="line">&#123;</div><div class="line">friend class StrBlobPtr; //申明为友元</div><div class="line">public:</div><div class="line">    typedef vector&lt;string&gt;::size_type size_type;</div><div class="line">    //构造函数</div><div class="line">    StrBlob():data(make_shared&lt;vector&lt;string&gt;&gt;())&#123;&#125;</div><div class="line">    StrBlob(initializer_list&lt;string&gt; ils)://多个字符串参数</div><div class="line">        data(make_shared&lt;vector&lt;string&gt;&gt;(ils)) &#123;&#125;</div><div class="line">    //成员函数</div><div class="line">    StrBlobPtr begin();</div><div class="line">    StrBlobPtr end();</div><div class="line">    size_type size() const &#123;return data -&gt; size();&#125;</div><div class="line">    bool empty() const &#123;return data -&gt; empty();&#125;</div><div class="line">    void push_back(const string &amp;t) &#123;data -&gt; push_back(t);&#125;</div><div class="line">    void pop_back() &#123;check(0, &quot;empty&quot;); data -&gt; front();&#125;</div><div class="line">    string&amp; front() &#123;check(0, &quot;empty&quot;); return data -&gt; front();&#125;</div><div class="line">    string&amp; back() &#123;check(0, &quot;empty&quot;); return data -&gt; back();&#125;</div><div class="line"></div><div class="line">private:</div><div class="line">    shared_ptr&lt;vector&lt;string&gt;&gt; data;//vec的指针</div><div class="line">    //检测异常</div><div class="line">    void check(size_type i, const string &amp;msg) const </div><div class="line">        &#123;if (i &gt;= data -&gt; size()) throw out_of_range(msg);&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class StrBlobPtr</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    //构造函数</div><div class="line">    StrBlobPtr() : curr(0) &#123;&#125;</div><div class="line">    StrBlobPtr(StrBlob &amp;a, size_t sz=0):</div><div class="line">        wptr(a.data), curr(sz) &#123;&#125; //用shared_ptr初始化弱指针</div><div class="line">    //成员函数</div><div class="line">    string &amp;operator*() const; //解引用</div><div class="line">    string *operator-&gt;() const;</div><div class="line">    StrBlobPtr &amp;operator++(); //递增</div><div class="line">    StrBlobPtr &amp;operator--(); //递增</div><div class="line">    StrBlobPtr operator++(int i); //递增</div><div class="line">    StrBlobPtr operator--(int i); //递增</div><div class="line">private:</div><div class="line">    //检查vector是否被释放，索引是否合法</div><div class="line">    shared_ptr&lt;vector&lt;string&gt;&gt; check(size_t sz, const string &amp;msg) const;</div><div class="line">    weak_ptr&lt;vector&lt;string&gt;&gt; wptr; //一个弱指针</div><div class="line">    size_t curr; //位置</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//返回一个指向第一个元素的StrBlobPtr</div><div class="line">StrBlobPtr StrBlob::begin()</div><div class="line">&#123;</div><div class="line">    return StrBlobPtr(*this);</div><div class="line">&#125;</div><div class="line">//最后一个元素后一个位置</div><div class="line">StrBlobPtr StrBlob::end()</div><div class="line">&#123;</div><div class="line">    auto ret = StrBlobPtr(*this, data -&gt; size());</div><div class="line">    return ret;</div><div class="line">&#125;</div><div class="line">shared_ptr&lt;vector&lt;string&gt;&gt; </div><div class="line">StrBlobPtr::check(size_t sz, const string &amp;msg) const</div><div class="line">&#123;</div><div class="line">    auto ret = wptr.lock(); //如果不存在返回空</div><div class="line">    if (!ret)</div><div class="line">        throw runtime_error(&quot;unbond StrBlob&quot;);</div><div class="line">    if (sz &gt;= ret -&gt; size())</div><div class="line">        throw out_of_range(msg);</div><div class="line">    return ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//解引用</div><div class="line">string &amp;StrBlobPtr::operator*() const</div><div class="line">&#123;</div><div class="line">    auto p = check(curr, &quot;dereference past end&quot;); //检查索引</div><div class="line">    return (*p) [curr]; //取vector元素</div><div class="line">&#125;</div><div class="line">string *StrBlobPtr::operator-&gt;() const</div><div class="line">&#123;</div><div class="line">    return &amp; this -&gt; operator*(); //返回解引用结果的地址</div><div class="line">&#125;</div><div class="line"></div><div class="line">//前置版本</div><div class="line">StrBlobPtr &amp;StrBlobPtr::operator++()</div><div class="line">&#123;</div><div class="line">    check(curr, &quot;increment past end of StrBlobPtr&quot;); //检查索引</div><div class="line">    ++curr; //自增移动</div><div class="line">    return *this;</div><div class="line">&#125;</div><div class="line">StrBlobPtr &amp;StrBlobPtr::operator--()</div><div class="line">&#123;</div><div class="line">    --curr;//自减移动，如果为0，产生无效下标</div><div class="line">    check(curr, &quot;increment past end of StrBlobPtr&quot;); //检查索引</div><div class="line">    return *this;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//后置版本用一个不被使用的 int 形参与前置版本区分</div><div class="line">//后置版本返回的值应该与之前的值保持一致</div><div class="line">//返回的是值，而不是引用</div><div class="line">StrBlobPtr StrBlobPtr::operator++(int i)</div><div class="line">&#123;</div><div class="line">    StrBlobPtr ret = *this;</div><div class="line">    ++*this; //自增移动</div><div class="line">    return ret; //返回原值</div><div class="line">&#125;</div><div class="line">StrBlobPtr StrBlobPtr::operator--(int i)</div><div class="line">&#123;</div><div class="line">    StrBlobPtr ret = *this;</div><div class="line">    --*this;</div><div class="line">    return ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    StrBlob b&#123;&quot;a&quot;,&quot;aa&quot;,&quot;aaa&quot;&#125;;</div><div class="line">    StrBlobPtr bp = b.begin(), be = b.end();</div><div class="line">    cout &lt;&lt; *bp++ &lt;&lt; endl; //a</div><div class="line">    cout &lt;&lt; *++bp &lt;&lt; endl;//aaa</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="OOP"><a href="#OOP" class="headerlink" title="OOP"></a>OOP</h1><h2 id="定义基类和派生类"><a href="#定义基类和派生类" class="headerlink" title="定义基类和派生类"></a>定义基类和派生类</h2><p>15.3</p>
<p>定义一个基类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">class myquote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    myquote() = default;</div><div class="line">    myquote(const std::string &amp;bookname, double source_price) :</div><div class="line">        name(bookname), price(source_price) &#123;&#125;</div><div class="line">    std::string getname() const &#123;return name;&#125;</div><div class="line">    //需要派生类自己定义的函数声明为虚函数</div><div class="line">    virtual double getprice() const &#123;return price;&#125;</div><div class="line">    virtual ~myquote() = default; //基类需要定义一个虚解析函数</div><div class="line">private: //私有成员，用户和派生类都不能访问</div><div class="line">    std::string name;</div><div class="line">protected: // 受保护的成员，派生类可以访问，用户不能访问</div><div class="line">    double price;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>定义一个打印函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//这里的mq可以是基类或者派生类</div><div class="line">void print_total(ostream &amp;os, MyQuote &amp;mq, size_t num)</div><div class="line">&#123;</div><div class="line">    double total_price = mq.getprice() * num;</div><div class="line">    os &lt;&lt; mq.getname() &lt;&lt; &quot; : &quot; &lt;&lt; total_price &lt;&lt; endl;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>15.5</p>
<p>定义一个派生类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">class CutQuote : public MyQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    CutQuote() = default;</div><div class="line">    CutQuote(const std::string &amp;bookname, double source_price, int cut) : </div><div class="line">        MyQuote(bookname, source_price), discount(cut) &#123;&#125;</div><div class="line">    double getprice() const override &#123;return price/discount;&#125; //重写虚函数</div><div class="line">private:</div><div class="line">    int discount; //新增数据成员表示折扣</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>15.11</p>
<p>定义一个输出成员值的debug()函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">class MyQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    //....</div><div class="line">    virtual void debug()</div><div class="line">    &#123; //输出自己的元素</div><div class="line">        std::cout &lt;&lt; &quot;name : &quot; &lt;&lt; name &lt;&lt; std::endl </div><div class="line">            &lt;&lt; &quot;price : &quot; &lt;&lt; price &lt;&lt; std::endl;</div><div class="line">    &#125;</div><div class="line">//...</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class CutQuote : public MyQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    //....</div><div class="line">    void debug()</div><div class="line">    &#123; //显式调用基类的debug函数，否则会陷入无限递归</div><div class="line">        MyQuote::debug(); </div><div class="line">        std::cout &lt;&lt; &quot;discount : &quot; &lt;&lt; discount &lt;&lt; std::endl;</div><div class="line">    &#125;</div><div class="line">//...</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>15.15</p>
<p>抽象基类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">class MyQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    MyQuote() = default;</div><div class="line">    MyQuote(const std::string &amp;bookname, double source_price) :</div><div class="line">        name(bookname), price(source_price) &#123;&#125;</div><div class="line">    std::string getname() const &#123;return name;&#125;</div><div class="line">    virtual double getprice() const &#123;return price;&#125;</div><div class="line">    virtual ~MyQuote() = default;</div><div class="line">private: //私有成员，用户和派生类都不能访问</div><div class="line">    std::string name;</div><div class="line">protected: // 受保护的成员，派生类可以访问，用户不能访问</div><div class="line">    double price;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//继承基类的抽象基类</div><div class="line">class DiscQuote : public MyQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    DiscQuote() = default;</div><div class="line">    DiscQuote(const std::string &amp;bookname, double source_price, int cut) : </div><div class="line">        MyQuote(bookname, source_price), discount(cut) &#123;&#125;</div><div class="line">    double getprice() const = 0; //声明为纯虚函数</div><div class="line">protected:</div><div class="line">    int discount; //新增数据成员表示折扣</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//从抽象基类继承</div><div class="line">class CutQuote : public DiscQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    CutQuote() = default;</div><div class="line">    CutQuote(const std::string &amp;bookname, double source_price, int cut) :</div><div class="line">        DiscQuote(bookname, source_price, cut) &#123;&#125;</div><div class="line">    //覆盖抽象基类的getprice()函数</div><div class="line">    double getprice() const override &#123;return price/discount;&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">void print_total(std::ostream &amp;os, MyQuote &amp;mq, std::size_t num);</div></pre></td></tr></table></figure>
<h2 id="构造函数和派生类"><a href="#构造函数和派生类" class="headerlink" title="构造函数和派生类"></a>构造函数和派生类</h2><p>15.26</p>
<p>定义拷贝构造函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">class MyQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    MyQuote() = default;</div><div class="line">    MyQuote(const std::string &amp;bookname, double source_price) :</div><div class="line">        name(bookname), price(source_price) &#123;&#125;</div><div class="line">    std::string getname() const &#123;return name;&#125;</div><div class="line">    MyQuote(const MyQuote &amp;mq) : name(mq.name), price(mq.price)</div><div class="line">    &#123; //输出表示调用这个拷贝构造函数</div><div class="line">        std::cout &lt;&lt; &quot;MyQuote&apos;s copy..&quot; &lt;&lt; std::endl;</div><div class="line">    &#125;</div><div class="line">    virtual double getprice() const &#123;return price;&#125;</div><div class="line">    virtual ~MyQuote() = default;</div><div class="line">private: //私有成员，用户和派生类都不能访问</div><div class="line">    std::string name;</div><div class="line">protected: // 受保护的成员，派生类可以访问，用户不能访问</div><div class="line">    double price;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class DiscQuote : public MyQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    DiscQuote() = default;</div><div class="line">    DiscQuote(const std::string &amp;bookname, double source_price, int cut) : </div><div class="line">        MyQuote(bookname, source_price), discount(cut) &#123;&#125;</div><div class="line">    //先调用基类拷贝构造，然后构造自己的成员</div><div class="line">    DiscQuote(const DiscQuote &amp;dq) : MyQuote(dq), discount(dq.discount)</div><div class="line">    &#123;</div><div class="line">        std::cout &lt;&lt; &quot;DiscQuote&apos;s copy..&quot; &lt;&lt; std::endl;</div><div class="line">    &#125;</div><div class="line">    double getprice() const = 0; //声明为纯虚函数</div><div class="line">protected:</div><div class="line">    int discount; //新增数据成员表示折扣</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class CutQuote : public DiscQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    CutQuote() = default;</div><div class="line">    CutQuote(const std::string &amp;bookname, double source_price, int cut) :</div><div class="line">        DiscQuote(bookname, source_price, cut) &#123;&#125;</div><div class="line">    // 不用构造自己的成员，向上调用</div><div class="line">    CutQuote(const CutQuote &amp;cq) : DiscQuote(cq)</div><div class="line">    &#123;</div><div class="line">        std::cout &lt;&lt; &quot;CutQuote&apos;s copy&quot; &lt;&lt; std::endl;</div><div class="line">    &#125;</div><div class="line">    double getprice() const override &#123;return price/discount;&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">void print_total(std::ostream &amp;os, MyQuote &amp;mq, std::size_t num);</div><div class="line"></div><div class="line">//在主文件调用</div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    CutQuote q1(&quot;hello world&quot;, 10, 3);</div><div class="line">    CutQuote  q2(q1);</div><div class="line">    print_total(cout, q2, 1);</div><div class="line">    /*</div><div class="line">        输出说明是自顶而下的构造</div><div class="line">        MyQuote&apos;s copy..</div><div class="line">        DiscQuote&apos;s copy..</div><div class="line">        CutQuote&apos;s copy</div><div class="line">        hello world : 3.33333</div><div class="line">    */</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="继承构造函数"><a href="#继承构造函数" class="headerlink" title="继承构造函数"></a>继承构造函数</h2><p>15.27</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class CutQuote : public DiscQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    using DiscQuote::DiscQuote; //继承DiscQuote的构造函数</div><div class="line">    double getprice() const override &#123;return price/discount;&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="容器和继承"><a href="#容器和继承" class="headerlink" title="容器和继承"></a>容器和继承</h2><p>15.28</p>
<p>如果在基类类型容器放置派生类对象，派生类那部分会被切掉<br>因此，在容器中放置（智能）指针而不是对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    CutQuote q1(&quot;hello world&quot;, 10, 3);</div><div class="line">    MyQuote q2(&quot;hello world&quot;, 10);</div><div class="line">    vector&lt;shared_ptr&lt;MyQuote&gt;&gt; basket;</div><div class="line">    //派生类的智能指针隐式转化为基类智能指针</div><div class="line">    basket.push_back(make_shared&lt;CutQuote&gt;(q1));</div><div class="line">    basket.push_back(make_shared&lt;MyQuote&gt;(q2)); </div><div class="line">    for(auto i : basket)</div><div class="line">    &#123;</div><div class="line">        print_total(cout, *i, 1);</div><div class="line">    &#125;</div><div class="line">    /*</div><div class="line">        输出：</div><div class="line">        hello world : 3.33333</div><div class="line">        hello world : 10</div><div class="line">    */</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>15.30</p>
<p>编写一个Basket类<br>如果要改变add_item的接口，直接传入对象，让类自己判断调用什么拷贝方式<br>需要创建虚拟拷贝</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">class MyQuote</div><div class="line">&#123;</div><div class="line">//...</div><div class="line">    //虚拟拷贝，在程序运行的时候觉得调用哪个类的拷贝函数</div><div class="line">    //左值，返回基类指针</div><div class="line">    virtual MyQuote *clone() const &amp; &#123;return new MyQuote(*this);&#125; </div><div class="line">    //右值，基类指针</div><div class="line">    virtual MyQuote *clone() &amp;&amp; &#123;return new MyQuote(std::move(*this));&#125; </div><div class="line">//...</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class CutQuote : public DiscQuote</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    using DiscQuote::DiscQuote;</div><div class="line">    //左值，派生类指针</div><div class="line">    CutQuote *clone() const &amp; &#123;return new CutQuote(*this);&#125;</div><div class="line">    //右值，派生类指针</div><div class="line">    CutQuote *clone() &amp;&amp; &#123;return new CutQuote(std::move(*this));&#125;</div><div class="line">    double getprice() const override &#123;return price/discount;&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class Basket</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    void add_item(const MyQuote &amp;mq)</div><div class="line">    &#123; //添加到容器内</div><div class="line">        items.push_back(std::shared_ptr&lt;MyQuote&gt;(mq.clone()));</div><div class="line">    &#125;</div><div class="line">    void add_item(MyQuote &amp;&amp;mq)</div><div class="line">    &#123; //尽管参数是右值，mq本身却是个左值，所以需要再次调用move</div><div class="line">        items.push_back(std::shared_ptr&lt;MyQuote&gt;(std::move(mq).clone()));</div><div class="line">    &#125;</div><div class="line">    double total_price()</div><div class="line">    &#123; //遍历求和</div><div class="line">        double sum(0.0);</div><div class="line">        for(auto i : items)</div><div class="line">        &#123;</div><div class="line">            sum += i -&gt; getprice();</div><div class="line">        &#125;</div><div class="line">        return sum;</div><div class="line">    &#125;</div><div class="line">private:</div><div class="line">    //存放指针的容器</div><div class="line">    std::vector&lt;std::shared_ptr&lt;MyQuote&gt;&gt; items;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    CutQuote q1(&quot;hello world&quot;, 10, 3);</div><div class="line">    MyQuote q2(&quot;hello world&quot;, 10);</div><div class="line">    Basket bk;</div><div class="line">    bk.add_item(q1);</div><div class="line">    bk.add_item(q2);</div><div class="line">    cout &lt;&lt; bk.total_price() &lt;&lt; endl; //13.3333</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>15.39</p>
<p>文件查询程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div></pre></td><td class="code"><pre><div class="line">#ifndef MYSEARCH_H</div><div class="line">#define MYSEARCH_H</div><div class="line"></div><div class="line">#include &lt;memory&gt;</div><div class="line">#include &lt;string&gt;</div><div class="line">#include &lt;map&gt;</div><div class="line">#include &lt;vector&gt;</div><div class="line">#include &lt;set&gt;</div><div class="line">#include &lt;fstream&gt;</div><div class="line">#include &lt;iostream&gt;</div><div class="line">#include &lt;sstream&gt;</div><div class="line"></div><div class="line">#include &quot;mysearch.h&quot;</div><div class="line"></div><div class="line">class QueryResult;</div><div class="line">class TextQuery</div><div class="line">&#123;</div><div class="line">friend class QueryResult;</div><div class="line">public:</div><div class="line">    TextQuery(std::ifstream &amp;infile);</div><div class="line">    QueryResult query(std::string s) const;</div><div class="line">private:</div><div class="line">   std::shared_ptr&lt;std::vector&lt;std::string&gt;&gt; ifile; //指向存放每行文本的vector</div><div class="line">    std::map&lt;std::string, std::shared_ptr&lt;std::set&lt;int&gt;&gt;&gt; wm; //单词到存放行数的set的映射</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class QueryResult</div><div class="line">&#123;</div><div class="line">friend std::ostream &amp;operator&lt;&lt;(std::ostream &amp;os, const QueryResult &amp;qr);</div><div class="line">public:</div><div class="line">    QueryResult(std::string s, std::shared_ptr&lt;std::set&lt;int&gt;&gt; lp, std::shared_ptr&lt;std::vector&lt;std::string&gt;&gt; fp) : </div><div class="line">        world(s), linep(lp), file(fp)&#123;&#125;</div><div class="line">    std::set&lt;int&gt;::iterator begin()</div><div class="line">    &#123;</div><div class="line">        return linep -&gt; begin();</div><div class="line">    &#125;</div><div class="line">    std::set&lt;int&gt;::iterator end()</div><div class="line">    &#123;</div><div class="line">        return linep -&gt; end();</div><div class="line">    &#125;</div><div class="line">    std::shared_ptr&lt;std::vector&lt;std::string&gt;&gt; &amp;get_file()</div><div class="line">    &#123;</div><div class="line">        return file;</div><div class="line">    &#125;</div><div class="line">private:</div><div class="line">    std::string world;</div><div class="line">    std::shared_ptr&lt;std::set&lt;int&gt;&gt; linep;</div><div class="line">    std::shared_ptr&lt;std::vector&lt;std::string&gt;&gt; file;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//构造函数，在构造函数里储存将单词到行号的隐射</div><div class="line">TextQuery::TextQuery(std::ifstream &amp;infile) : ifile(new std::vector&lt;std::string&gt;) //初始化infile</div><div class="line">&#123;</div><div class="line">    std::string s,world;</div><div class="line">    int num(0);</div><div class="line">    while(getline(infile, s))</div><div class="line">    &#123;</div><div class="line">        ++num;</div><div class="line">        ifile -&gt; push_back(s);</div><div class="line">        std::istringstream line(s);</div><div class="line">        while(line &gt;&gt; world)</div><div class="line">        &#123;</div><div class="line">            if(!wm[world]) //如果set还没有创建</div><div class="line">                wm[world].reset(new std::set&lt;int&gt;); //创建一个set</div><div class="line">            wm[world] -&gt; insert(num); //行号插入到set</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//查找</div><div class="line">//返回一个QueryResult类</div><div class="line">QueryResult TextQuery::query(std::string s) const</div><div class="line">&#123;</div><div class="line">    std::shared_ptr&lt;std::set&lt;int&gt;&gt; nodata(new std::set&lt;int&gt;); //一个空set</div><div class="line">    auto res = wm.find(s); //查找函数的本体，查找map对应字符串的行号set</div><div class="line">    if (res == wm.end()) //无内容返回空set</div><div class="line">        return QueryResult(s, nodata, ifile);</div><div class="line">    else //有内容返回set，访问map 的 second成员</div><div class="line">        return QueryResult(s, res -&gt; second, ifile);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//用&lt;&lt;操作符打印QueryResult的内容</div><div class="line">std::ostream &amp;operator&lt;&lt;(std::ostream &amp;os, const QueryResult &amp;qr)</div><div class="line">&#123;</div><div class="line">    os &lt;&lt; qr.world &lt;&lt; &quot;: \n&quot;;</div><div class="line">    for (auto num:*qr.linep) //对每个指针解引用然后遍历</div><div class="line">    &#123;</div><div class="line">        os &lt;&lt; num &lt;&lt; &quot; &quot;; //行号</div><div class="line">        os &lt;&lt; *(qr.file -&gt; begin() + num - 1) &lt;&lt; &quot;\n&quot;; //用迭代器输出vector的行文本</div><div class="line">    &#125;</div><div class="line">    return os;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//一个抽象基类，继承查询类型</div><div class="line">class Query_base</div><div class="line">&#123;</div><div class="line">friend class Query;</div><div class="line">protected:</div><div class="line">    virtual ~Query_base() = default;</div><div class="line">private:</div><div class="line">    virtual QueryResult eval(const TextQuery &amp;t) const = 0;</div><div class="line">    virtual std::string rep() const = 0;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class Query</div><div class="line">&#123;</div><div class="line">friend Query operator~(const Query &amp;q);</div><div class="line">friend Query operator&amp;(const Query &amp;q1, const Query &amp;q2);</div><div class="line">friend Query operator|(const Query &amp;q1, const Query &amp;q2);</div><div class="line">public:</div><div class="line">    //构造一个WordQuery</div><div class="line">    Query(const std::string &amp;s);</div><div class="line">    QueryResult eval(const TextQuery &amp;t) const</div><div class="line">    &#123;</div><div class="line">        return q -&gt; eval(t); //虚调用</div><div class="line">    &#125;</div><div class="line">    std::string rep() const</div><div class="line">    &#123;</div><div class="line">        return q -&gt; rep(); //虚调用</div><div class="line">    &#125;</div><div class="line">private:</div><div class="line">    Query(std::shared_ptr&lt;Query_base&gt; sq) : q(sq) &#123;&#125;</div><div class="line">    std::shared_ptr&lt;Query_base&gt; q;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"> //继承查询基类</div><div class="line">class WordQuery : public Query_base</div><div class="line">&#123;</div><div class="line">    //默认都是私有成员，由友元Query（用户借口类）访问</div><div class="line">    friend class Query;</div><div class="line">    //保存要查询的词</div><div class="line">    WordQuery(const std::string &amp;s) : query_world(s) &#123;&#125;</div><div class="line">    QueryResult eval(const TextQuery &amp;t) const override</div><div class="line">    &#123;</div><div class="line">        return t.query(query_world); </div><div class="line">    &#125;</div><div class="line">    std::string rep() const override &#123;return query_world;&#125;</div><div class="line">    std::string query_world; //查询的词</div><div class="line">&#125;;</div><div class="line"></div><div class="line">inline</div><div class="line">Query::Query(const std::string &amp;s) : q(new WordQuery(s)) &#123;&#125;</div><div class="line"></div><div class="line">class NotQuery : public Query_base</div><div class="line">&#123;</div><div class="line">    friend Query operator~(const Query  &amp;q);</div><div class="line">    NotQuery(const Query &amp;q) : query(q) &#123;&#125;;</div><div class="line">    std::string rep() const override</div><div class="line">    &#123; //输出要查询的词，附带~符号和括号</div><div class="line">        return &quot;~(&quot; + query.rep() + &quot;)&quot;; </div><div class="line">    &#125;</div><div class="line">    QueryResult eval(const TextQuery &amp;t) const override;</div><div class="line">    Query query; //保存传递的query参数</div><div class="line">&#125;;</div><div class="line"></div><div class="line">inline</div><div class="line">Query operator~(const Query &amp;q)</div><div class="line">&#123;//返回一个shared_ptr</div><div class="line">    return std::shared_ptr&lt;Query_base&gt; (new NotQuery(q));</div><div class="line">&#125;</div><div class="line"></div><div class="line">class BinaryQuery : public Query_base</div><div class="line">&#123;</div><div class="line">protected:</div><div class="line">    BinaryQuery(const Query &amp;l, const Query &amp;r, std::string s) : </div><div class="line">        lq(l), rq(r), ops(s) &#123;&#125;</div><div class="line">    std::string rep() const override</div><div class="line">    &#123; //输出查找的词和符号</div><div class="line">        return &quot;(&quot; + lq.rep() + &quot; &quot; </div><div class="line">            + ops + &quot; &quot; </div><div class="line">            + rq.rep() + &quot;)&quot;;</div><div class="line">    &#125;</div><div class="line">    //没有覆盖eval()，仍是抽象基类</div><div class="line">    Query lq, rq; //左右操作数</div><div class="line">    std::string ops; //运算符</div><div class="line">&#125;;</div><div class="line"></div><div class="line">//&amp;运算和|运算相似</div><div class="line">class AndQuery : public BinaryQuery</div><div class="line">&#123;</div><div class="line">    friend Query operator&amp;(const Query &amp;q1, const Query &amp;q2);</div><div class="line">    AndQuery(const Query &amp;q1, const Query &amp;a2) : </div><div class="line">        BinaryQuery(q1, a2, &quot;&amp;&quot;) &#123;&#125;</div><div class="line">    QueryResult eval(const TextQuery &amp;t) const;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">inline</div><div class="line">Query operator&amp;(const   Query &amp;q1,const Query &amp;q2)</div><div class="line">&#123;</div><div class="line">    return std::shared_ptr&lt;Query_base&gt; (new AndQuery(q1, q2));</div><div class="line">&#125;</div><div class="line"></div><div class="line">class OrQuery : public BinaryQuery</div><div class="line">&#123;</div><div class="line">    friend Query operator|(const Query &amp;q1, const Query &amp;q2);</div><div class="line">    OrQuery(const Query &amp;q1, const Query &amp;a2) : </div><div class="line">        BinaryQuery(q1, a2, &quot;|&quot;) &#123;&#125;</div><div class="line">    QueryResult eval(const TextQuery &amp;t) const;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">inline</div><div class="line">Query operator|(const   Query &amp;q1,const Query &amp;q2)</div><div class="line">&#123;</div><div class="line">    return std::shared_ptr&lt;Query_base&gt; (new OrQuery(q1, q2));</div><div class="line">&#125;</div><div class="line"></div><div class="line">// &apos;|&apos; 操作</div><div class="line">QueryResult</div><div class="line">OrQuery::eval(const TextQuery &amp;t) const</div><div class="line">&#123;</div><div class="line">    QueryResult lqr = lq.eval(t), rqr = rq.eval(t);</div><div class="line">    //左QueryResult的行号or上右QueryResult行号</div><div class="line">    auto ret_lines = std::make_shared&lt;std::set&lt;int&gt;&gt;(lqr.begin(), lqr.end());</div><div class="line">    ret_lines -&gt; insert(rqr.begin(), rqr.end());</div><div class="line">    //初始化一个新QueryResult</div><div class="line">    return QueryResult(rep(), ret_lines, lqr.get_file());</div><div class="line">&#125;</div><div class="line"></div><div class="line">// &apos;&amp;&apos;操作</div><div class="line">QueryResult</div><div class="line">AndQuery::eval(const TextQuery &amp;t) const</div><div class="line">&#123;</div><div class="line">    QueryResult lqr = lq.eval(t), rqr = rq.eval(t);</div><div class="line">    //一个指向空set的指针</div><div class="line">    auto ret_lines = std::make_shared&lt;std::set&lt;int&gt;&gt;();</div><div class="line">    ret_lines -&gt; insert(rqr.begin(), rqr.end());</div><div class="line">    //使用标准库算法求并集</div><div class="line">    set_intersection(lqr.begin(), lqr.end(),</div><div class="line">            rqr.begin(), rqr.end(),</div><div class="line">            inserter(*ret_lines, ret_lines -&gt; begin()));</div><div class="line">    return QueryResult(rep(), ret_lines, lqr.get_file());</div><div class="line">&#125;</div><div class="line"></div><div class="line">// &apos;~&apos;操作</div><div class="line">QueryResult</div><div class="line">NotQuery::eval(const TextQuery &amp;t) const</div><div class="line">&#123;</div><div class="line">    QueryResult qr = query.eval(t);</div><div class="line">    //一个指向空set的指针</div><div class="line">    auto ret_lines = std::make_shared&lt;std::set&lt;int&gt;&gt;();</div><div class="line">    auto qrb = qr.begin(), qre = qr.end();</div><div class="line">    auto sz = qr.get_file() -&gt; size();</div><div class="line">    for (auto n = 0; n != sz; ++n)</div><div class="line">    &#123;</div><div class="line">        if (*qrb != n + 1)</div><div class="line">            //如果行号不在查询结果里面，插入到set中</div><div class="line">            ret_lines -&gt; insert(n+1);</div><div class="line">        else if(qrb != qre)</div><div class="line">            ++qrb;</div><div class="line">    &#125;</div><div class="line">    return QueryResult(rep(), ret_lines, qr.get_file());</div><div class="line">&#125;</div><div class="line"></div><div class="line">#endif</div><div class="line"></div><div class="line"></div><div class="line">//主函数调用</div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    ifstream infile(&quot;text.txt&quot;);</div><div class="line">    TextQuery tq(infile);</div><div class="line">    auto res = Query(&quot;harry&quot;) &amp; Query(&quot;my&quot;) | ~Query(&quot;haha&quot;);</div><div class="line">    cout &lt;&lt; res.eval(tq);</div><div class="line">/*</div><div class="line">    ((harry &amp; my) | ~(haha)): </div><div class="line">    ...</div><div class="line">    ...</div><div class="line">    ..</div><div class="line">*/</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h1><p>16.19</p>
<p>输出容器内容的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">template &lt;typename T&gt;</div><div class="line">void my_print(const vector&lt;T&gt; &amp;ve)</div><div class="line">&#123;</div><div class="line">    //typename指定成员类型</div><div class="line">    typename vector&lt;T&gt;::size_type sz = ve.size(), i;</div><div class="line">    for(i=0; i != sz; ++i)</div><div class="line">    &#123;</div><div class="line">        cout &lt;&lt; ve[i];</div><div class="line">    &#125;</div><div class="line">    cout &lt;&lt; endl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    vector&lt;int&gt; vec=&#123;1,2,3,4,5,6&#125;;</div><div class="line">    my_print(vec);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>16.20</p>
<p>使用迭代器的版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">template &lt;typename T&gt;</div><div class="line">void my_print(const vector&lt;T&gt; &amp;ve)</div><div class="line">&#123;</div><div class="line">    typename vector&lt;T&gt;::const_iterator bg = ve.begin(), be = ve.end();</div><div class="line">    while(bg != be)</div><div class="line">    &#123;</div><div class="line">        cout &lt;&lt; *bg++;</div><div class="line">    &#125;</div><div class="line">    cout &lt;&lt; endl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    vector&lt;int&gt; vec=&#123;1,2,3,4,5,6&#125;;</div><div class="line">    my_print(vec);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外一个版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">template &lt;typename T&gt;</div><div class="line">ostream  &amp;my_print(ostream &amp;os, const T &amp;ve)</div><div class="line">&#123;</div><div class="line">    typename T::const_iterator bg = ve.begin(), be = ve.end();</div><div class="line">    while(bg != be)</div><div class="line">    &#123;</div><div class="line">        os &lt;&lt; *bg++;</div><div class="line">    &#125;</div><div class="line">    return os;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () </div><div class="line">&#123;</div><div class="line">    vector&lt;int&gt; vec=&#123;1,2,3,4,5,6&#125;;</div><div class="line">    my_print(cout, vec) &lt;&lt; endl;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-11-26</span><i class="fa fa-tag"></i><a href="/tags/c/" title="c++" class="tag">c++ </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2016/11/26/C3/,Harryx,C++ Primer,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/03/14/hello-world/" title="Hello World" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2016/11/05/deploy/" title="flask部署" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>