<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Ben Wong,wenbinben@gmail.com"><title>myblog-07 用户资料 · Harryx</title><meta name="description" content="用户资料更新数据库编写用户模板在用户模板中添加所在地、个性签名、注册日期和最后访问日期数据库以datetime格式存储UTC时间，Flask-Moment自动更具时区渲染时间首先引入moment.js库文件：app/templates/base.html
12345&amp;#123;% block scr"><meta name="keywords" content="Hexo,HTML,Ben,CSS,安卓,android,Linux,linuxdeepin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">Harryx</a></h3><div class="description"><p>good good study good good play~</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/harryx520"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/Booooyakasha"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/avator.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>myblog-07 用户资料</a></h3></div><div class="post-content"><h1 id="用户资料"><a href="#用户资料" class="headerlink" title="用户资料"></a>用户资料</h1><h2 id="更新数据库"><a href="#更新数据库" class="headerlink" title="更新数据库"></a>更新数据库</h2><h3 id="编写用户模板"><a href="#编写用户模板" class="headerlink" title="编写用户模板"></a>编写用户模板</h3><p>在用户模板中添加所在地、个性签名、注册日期和最后访问日期<br>数据库以datetime格式存储UTC时间，Flask-Moment自动更具时区渲染时间<br>首先引入moment.js库<br>文件：<strong>app/templates/base.html</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block scripts %&#125;</span><br><span class="line">&#123;&#123; super() &#125;&#125;</span><br><span class="line">&#123;&#123; moment.include_moment() &#125;&#125;</span><br><span class="line">&#123;&#123; moment.lang(&quot;zh-CN&quot;) &#125;&#125; </span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>渲染时间<br>文件：<strong>app/templates/user.html</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;Member since &#123;&#123; moment(user.member_since).format(&apos;LL&apos;) &#125;&#125;.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;Last seen &#123;&#123; moment(user.last_seen).fromNow() &#125;&#125;.&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>db.String()和db.Text()的区别是后者不需要指定长度<br>这里的member_since和last_seen分别是注册日期和最后访问日期，默认值都是now函数的值<br>如果数据库提交时，没有赋值，则提交默认值，而不是NULL<br>文件：<strong>app/models.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line">class User(UserMixin, db.Model):</span><br><span class="line"></span><br><span class="line">    #...</span><br><span class="line">    location = db.Column(db.String(64))</span><br><span class="line">    about_me = db.Column(db.Text())</span><br><span class="line">    member_since = db.Column(db.DateTime(), default=datetime.now)</span><br><span class="line">    last_seen = db.Column(db.DateTime(), default=datetime.now)</span><br></pre></td></tr></table></figure>

<h3 id="刷新最后访问日期"><a href="#刷新最后访问日期" class="headerlink" title="刷新最后访问日期"></a>刷新最后访问日期</h3><p>添加用户刷新时间功能<br>文件：<strong>app/models.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class User(UserMixin, db.Model):</span><br><span class="line"></span><br><span class="line">    #...</span><br><span class="line">    def ping(self):</span><br><span class="line">        self.last_seen = datetime.now()</span><br><span class="line">        db.session.add(self)</span><br></pre></td></tr></table></figure>

<p>auth蓝本中的before_app_request处理程序会在用户每次请求之前运行<br>文件：<strong>app/auth/views.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@auth.before_app_request</span><br><span class="line">def before_request():</span><br><span class="line">    if current_user.is_authenticated:</span><br><span class="line">        current_user.ping()</span><br><span class="line">        #...</span><br></pre></td></tr></table></figure>

<h2 id="用户资料页面"><a href="#用户资料页面" class="headerlink" title="用户资料页面"></a>用户资料页面</h2><h3 id="编写路由"><a href="#编写路由" class="headerlink" title="编写路由"></a>编写路由</h3><p>从URL接收参数name，如果用户不存在，返回404错误<br>文件：<strong>app/main/views.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@main.route(&apos;/user/&lt;name&gt;&apos;)</span><br><span class="line">def user(name):</span><br><span class="line">    user = User.query.filter_by(name=name).first_or_404()</span><br><span class="line">    return render_template(&apos;user.html&apos;, user=user)</span><br></pre></td></tr></table></figure>

<h3 id="资料页面模板"><a href="#资料页面模板" class="headerlink" title="资料页面模板"></a>资料页面模板</h3><p>只有管理员可以看到邮件地址<br>文件：<strong>app/templates/user.html</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;&#123;&#123; user.name &#125;&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line">&lt;div class=&quot;page-header&quot;&gt;</span><br><span class="line">    &lt;h1&gt;&#123;&#123; user.name &#125;&#125;&lt;/h1&gt;</span><br><span class="line">    &#123;% if user.name or user.location %&#125;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &#123;% if user.location %&#125;</span><br><span class="line">            From &lt;a href=&quot;http://maps.google.com/?q=&#123;&#123; user.location &#125;&#125;&quot;&gt;&#123;&#123; user.location &#125;&#125;&lt;/a&gt;</span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    &#123;% if current_user.is_administrator() %&#125;</span><br><span class="line">    &lt;p&gt;&#123;&#123; user.email &#125;&#125;&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    &#123;% if user.about_me %&#125;&lt;p&gt;&#123;&#123; user.about_me &#125;&#125;&lt;/p&gt;&#123;% endif %&#125;</span><br><span class="line">    &lt;p&gt;Member since &#123;&#123; moment(user.member_since).format(&apos;LL&apos;) &#125;&#125;.&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;Last seen &#123;&#123; moment(user.last_seen).fromNow() &#125;&#125;.&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查看个人资料"><a href="#查看个人资料" class="headerlink" title="查看个人资料"></a>查看个人资料</h3><p>在导航条创建一个链接，用于访问自己的资料<br>文件：<strong>app/templates/base.html</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if current_user.is_authenticated %&#125;</span><br><span class="line">&lt;li class=&quot;dropdown&quot;&gt;</span><br><span class="line">    &lt;a href=&quot;#&quot; class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;Account &lt;b class=&quot;caret&quot;&gt;&lt;/b&gt;&lt;/a&gt;</span><br><span class="line">    &lt;ul class=&quot;dropdown-menu&quot;&gt;</span><br><span class="line">        &lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;main.user&apos;, name=current_user.name) &#125;&#125;&quot;&gt;Profile&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">        #...</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">&lt;/li&gt;</span><br><span class="line">&#123;% else %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="资料编辑器"><a href="#资料编辑器" class="headerlink" title="资料编辑器"></a>资料编辑器</h2><p>用户可以通过资料编辑器更改自己的资料<br>管理员可以通过资料编辑器更改所有用户资料和角色<br>针对两个角色创建不同的表单</p>
<h3 id="用户级别的资料编辑器"><a href="#用户级别的资料编辑器" class="headerlink" title="用户级别的资料编辑器"></a>用户级别的资料编辑器</h3><p>这个表单中的所有字段都是可选的，可以不填<br>文件：<strong>app/main/forms.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class EditProfileForm(Form):</span><br><span class="line">    location = StringField(&apos;Location&apos;, validators=[Length(0, 64)])</span><br><span class="line">    about_me = TextAreaField(&apos;About me&apos;)</span><br><span class="line">    submit = SubmitField(&apos;Submit&apos;)</span><br></pre></td></tr></table></figure>

<p>渲染表单<br>文件：<strong>app/templates/edit_profile.html</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Edit Profile&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line">&lt;div class=&quot;page-header&quot;&gt;</span><br><span class="line">    &lt;h1&gt;Edit Your Profile&lt;/h1&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;col-md-4&quot;&gt;</span><br><span class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>编辑路由<br>在显示表单之前，存下初始值，如果没有提交更改，返回默认值<br>文件：<strong>app/main/views.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@main.route(&apos;/edit-profile&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">@login_required</span><br><span class="line">def edit_profile():</span><br><span class="line">    form = EditProfileForm()</span><br><span class="line">    if form.validate_on_submit():</span><br><span class="line">        current_user.location = form.location.data</span><br><span class="line">        current_user.about_me = form.about_me.data</span><br><span class="line">        db.session.add(current_user)</span><br><span class="line">        flash(&apos;Your profile has been updated.&apos;)</span><br><span class="line">        return redirect(url_for(&apos;.user&apos;, name=current_user.name))</span><br><span class="line">    form.location.data = current_user.location</span><br><span class="line">    form.about_me.data = current_user.about_me</span><br><span class="line">    return render_template(&apos;edit_profile.html&apos;, form=form)</span><br></pre></td></tr></table></figure>

<p>添加到编辑页面的链接<br>文件：<strong>app/templates/user.html</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;</span><br><span class="line">    &#123;% if user == current_user %&#125;</span><br><span class="line">        &lt;a class=&quot;btn btn-default&quot; href=&quot;&#123;&#123; url_for(&apos;.edit_profile&apos;) &#125;&#125;&quot;&gt;Edit Profile&lt;/a&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>关于数据库中文乱码的问题，创建表的时候，指定编码格式：<strong>default charset=utf8</strong></p>
<h3 id="管理员级别的资料编辑器"><a href="#管理员级别的资料编辑器" class="headerlink" title="管理员级别的资料编辑器"></a>管理员级别的资料编辑器</h3><p>管理员使用的表单比普通用户复杂，除了地点、个性签名还有用户名、电子邮件、确认状态和角色<br>SelectField实例必须在choice属性中设置各选项，选项是一个元组组成的列表<br>这里使用一个查询按照角色名的字母排序的所有角色<br>SelectField构造函数中添加coerce=int参数，从而把字段值转化为整数，而不使用字符串<br>email和name字段的构造方式和认证表单中一样<br>文件：<strong>app/main/forms.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class EditProfileAdminForm(Form):</span><br><span class="line">    email = StringField(&apos;Email&apos;, validators=[Required(), Length(1, 64),</span><br><span class="line">                                             Email()])</span><br><span class="line">    confirmed = BooleanField(&apos;Confirmed&apos;)</span><br><span class="line">    name = StringField(&apos;Name&apos;, validators=[</span><br><span class="line">        Required(), Length(1, 64), Regexp(&apos;^[A-Za-z][A-Za-z0-9_.]*$&apos;, 0,</span><br><span class="line">                                          &apos;Names must have only letters, &apos;</span><br><span class="line">                                          &apos;numbers, dots or underscores&apos;)])</span><br><span class="line">    role = SelectField(&apos;Role&apos;, coerce=int)</span><br><span class="line">    location = StringField(&apos;Location&apos;, validators=[Length(0, 64)])</span><br><span class="line">    about_me = TextAreaField(&apos;About me&apos;)</span><br><span class="line">    submit = SubmitField(&apos;Submit&apos;)</span><br><span class="line"></span><br><span class="line">    def __init__(self, user, *args, **kwargs):</span><br><span class="line">        super(EditProfileAdminForm, self).__init__(*args, **kwargs)</span><br><span class="line">        self.role.choices = [(role.id, role.name)</span><br><span class="line">                             for role in Role.query.order_by(Role.name).all()]</span><br><span class="line">        self.user = user</span><br><span class="line"></span><br><span class="line">    def validate_email(self, field):</span><br><span class="line">        if field.data != self.user.email and \</span><br><span class="line">                User.query.filter_by(email=field.data).first():</span><br><span class="line">            raise ValidationError(&apos;Email already registered.&apos;)</span><br><span class="line"></span><br><span class="line">    def validate_name(self, field):</span><br><span class="line">        if field.data != self.user.name and \</span><br><span class="line">                User.query.filter_by(name=field.data).first():</span><br><span class="line">            raise ValidationError(&apos;Name already in use.&apos;)</span><br></pre></td></tr></table></figure>

<p>视图函数，通过URL获得用户id，如果用户不存在，返回404<br>user.role是通过Role查询赋值<br>文件：<strong>app/main/views.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@main.route(&apos;/edit-profile/&lt;int:id&gt;&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">@login_required</span><br><span class="line">@admin_required</span><br><span class="line">def edit_profile_admin(id):</span><br><span class="line">    user = User.query.get_or_404(id)</span><br><span class="line">    form = EditProfileAdminForm(user=user)</span><br><span class="line">    if form.validate_on_submit():</span><br><span class="line">        user.email = form.email.data</span><br><span class="line">        user.name = form.name.data</span><br><span class="line">        user.confirmed = form.confirmed.data</span><br><span class="line">        user.role = Role.query.get(form.role.data)</span><br><span class="line">        user.location = form.location.data</span><br><span class="line">        user.about_me = form.about_me.data</span><br><span class="line">        db.session.add(user)</span><br><span class="line">        flash(&apos;The profile has been updated.&apos;)</span><br><span class="line">        return redirect(url_for(&apos;.user&apos;, name=user.name))</span><br><span class="line">    form.email.data = user.email</span><br><span class="line">    form.confirmed.data = user.confirmed</span><br><span class="line">    form.role.data = user.role_id</span><br><span class="line">    form.name.data = user.name</span><br><span class="line">    form.location.data = user.location</span><br><span class="line">    form.about_me.data = user.about_me</span><br><span class="line">    return render_template(&apos;edit_profile.html&apos;, form=form, user=user)</span><br></pre></td></tr></table></figure>

<p>在用户的资料页面添加管理员管理链接<br>文件：<strong>app/templates/user.html</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if current_user.is_administrator() %&#125;</span><br><span class="line">    &lt;a class=&quot;btn btn-danger&quot; href=&quot;&#123;&#123; url_for(&apos;.edit_profile_admin&apos;, id=user.id) &#125;&#125;&quot;&gt;Edit Profile [Admin]&lt;/a&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="用户头像"><a href="#用户头像" class="headerlink" title="用户头像"></a>用户头像</h2><p>这里使用的是将图片的URL储存在数据库，需要更新用户模型<br>文件：<strong>app/models.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class User(UserMixin, db.Model):  </span><br><span class="line">    #...</span><br><span class="line">    avatar = db.Column(db.String(128))</span><br><span class="line">    #...</span><br></pre></td></tr></table></figure>

<p>视图函数也稍微修改<br>文件：<strong>app/main/views.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@main.route(&apos;/edit-profile&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">@login_required</span><br><span class="line">def edit_profile():</span><br><span class="line">    if form.validate_on_submit():</span><br><span class="line">        current_user.avatar = form.avatar.data</span><br><span class="line">        #...</span><br><span class="line">        return redirect(url_for(&apos;.user&apos;, name=current_user.name))</span><br><span class="line">    form.avatar.data = current_user.avatar</span><br><span class="line">    #...</span><br><span class="line"></span><br><span class="line">@main.route(&apos;/edit-profile/&lt;int:id&gt;&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">@login_required</span><br><span class="line">@admin_required</span><br><span class="line">def edit_profile_admin(id):</span><br><span class="line">    user = User.query.get_or_404(id)</span><br><span class="line">    form = EditProfileAdminForm(user=user)</span><br><span class="line">    if form.validate_on_submit():</span><br><span class="line">        user.avatar = form.avatar.data</span><br><span class="line">        #...</span><br><span class="line">        return redirect(url_for(&apos;.user&apos;, name=user.name))</span><br><span class="line">    form.avatar.data = user.avatar</span><br><span class="line">    #...</span><br></pre></td></tr></table></figure>

<p>然后在用户资料页面渲染<br>文件：<strong>app/templates/user.html</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if user.avatar %&#125;</span><br><span class="line">    &lt;img class=&quot;img-rounded profile-thumbnail&quot; src=&quot;&#123;&#123; user.avatar &#125;&#125;&quot; width=&quot;200px&quot; height=&quot;200px&quot;&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-04-17</span><i class="fa fa-tag"></i><a href="/tags/flask/" title="flask" class="tag">flask </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2016/04/17/Note/python/library/web/flask/flask-7/,Harryx,myblog-07 用户资料,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2016/04/18/Note/python/library/web/flask/flask-8/" title="myblog-08 博客文章" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2016/04/16/Note/python/library/web/flask/flask-6/" title="myblog-06 角色和权限" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>