<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>myblog-0d API | Harryx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="应用编程接口业务逻辑越来越多的移动到了客户端一侧，开创出一种称为RIA(富互联网应用 Rich Internet Application)的架构，服务器主要功能是提供数据存取服务。在这种模式下，服务器变成了Web服务或者应用编程接口(API Application Programming Interface)。 REST简介REST(表现层状态转移, Representational State">
<meta name="keywords" content="flask">
<meta property="og:type" content="article">
<meta property="og:title" content="myblog-0d API">
<meta property="og:url" content="http://yoursite.com/2016/04/23/myblog-0d/index.html">
<meta property="og:site_name" content="Harryx">
<meta property="og:description" content="应用编程接口业务逻辑越来越多的移动到了客户端一侧，开创出一种称为RIA(富互联网应用 Rich Internet Application)的架构，服务器主要功能是提供数据存取服务。在这种模式下，服务器变成了Web服务或者应用编程接口(API Application Programming Interface)。 REST简介REST(表现层状态转移, Representational State">
<meta property="og:updated_time" content="2017-03-15T04:50:21.618Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="myblog-0d API">
<meta name="twitter:description" content="应用编程接口业务逻辑越来越多的移动到了客户端一侧，开创出一种称为RIA(富互联网应用 Rich Internet Application)的架构，服务器主要功能是提供数据存取服务。在这种模式下，服务器变成了Web服务或者应用编程接口(API Application Programming Interface)。 REST简介REST(表现层状态转移, Representational State">
  
    <link rel="alternate" href="/atom.xml" title="Harryx" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Harryx</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-myblog-0d" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/23/myblog-0d/" class="article-date">
  <time datetime="2016-04-23T09:00:37.000Z" itemprop="datePublished">2016-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      myblog-0d API
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="应用编程接口"><a href="#应用编程接口" class="headerlink" title="应用编程接口"></a>应用编程接口</h1><p>业务逻辑越来越多的移动到了客户端一侧，开创出一种称为RIA(富互联网应用 Rich Internet Application)的架构，服务器主要功能是提供数据存取服务。<br>在这种模式下，服务器变成了Web服务或者应用编程接口(API Application Programming Interface)。</p>
<h2 id="REST简介"><a href="#REST简介" class="headerlink" title="REST简介"></a>REST简介</h2><p>REST(表现层状态转移, Representational State Transfer)架构特征</p>
<ul>
<li>客户端-服务器<br>客户端和服务器之间必须有明确的界线。</li>
<li>无状态<br>客户端发出的请求中必须包含所有必要的信息。服务器不能在两次请求之间保存客户端的任何状态。</li>
<li>缓存<br>服务器发出的响应可以标记为可缓存或不可缓存,这样出于优化目的,客户端(或客户端和服务器之间的中间服务)可以使用缓存。</li>
<li>接口统一<br>客户端访问服务器资源时使用的协议必须一致,定义良好,且已经标准化。REST Web服务最常使用的统一接口是 HTTP 协议。</li>
<li>系统分层<br>在客户端和服务器之间可以按需插入代理服务器、缓存或网关,以提高性能、稳定性和伸缩性。</li>
<li>按需代码<br>客户端可以选择从服务器上下载代码,在客户端的环境中执行。<h2 id="使用flask提供REST-Web服务"><a href="#使用flask提供REST-Web服务" class="headerlink" title="使用flask提供REST Web服务"></a>使用flask提供REST Web服务</h2><h3 id="API蓝本结构"><a href="#API蓝本结构" class="headerlink" title="API蓝本结构"></a>API蓝本结构</h3>API包的名字中有一个版本号，如果需要向前兼容，需要添加一个版本号的不同的包<br>在API蓝本中，各资源在不同模块实现<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">|-myblog</div><div class="line">    |-app/</div><div class="line">        |-api_1_0</div><div class="line">            |-__init__.py</div><div class="line">            |-users.py</div><div class="line">            |-posts.py</div><div class="line">            |-comments.py</div><div class="line">            |-authentication.py</div><div class="line">            |-errors.py</div><div class="line">            |-decorators.py</div></pre></td></tr></table></figure>
</li>
</ul>
<p>API蓝本构造文件<br>文件：<strong>app/api_1_0/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from flask import Blueprint</div><div class="line"></div><div class="line">api = Blueprint(&apos;api&apos;, __name__)</div><div class="line"></div><div class="line">from . import authentication, posts, users, comments, errors</div></pre></td></tr></table></figure></p>
<p>注册API蓝本<br>文件：<strong>app/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">def create_app(config_name):</div><div class="line">    #...</div><div class="line">    from .api_1_0 import api as api_1_0_blueprint</div><div class="line">    app.register_blueprint(api_1_0_blueprint, url_prefix=&apos;/api/v1.0&apos;)</div><div class="line">    #...</div></pre></td></tr></table></figure></p>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>在错误处理程序中根据客户端请求的格式改写响应，这种技术称为<strong>内容协商</strong><br>它向Web服务端发送JSON格式响应<br>文件：<strong>app/main/errors.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">from flask import render_template, request, jsonify</div><div class="line"></div><div class="line">from . import main</div><div class="line"></div><div class="line">@main.app_errorhandler(404)</div><div class="line">def page_not_found(e):</div><div class="line">    if request.accept_mimetypes.accept_json and \</div><div class="line">            not request.accept_mimetypes.accept_html:</div><div class="line">        response = jsonify(&#123;&apos;error&apos;: &apos;not found&apos;&#125;)</div><div class="line">        response.status_code = 404</div><div class="line">        return response</div><div class="line">    return render_template(&apos;404.html&apos;), 404</div><div class="line"></div><div class="line">@main.app_errorhandler(403)</div><div class="line">def forbidden(e):</div><div class="line">    if request.accept_mimetypes.accept_json and \</div><div class="line">            not request.accept_mimetypes.accept_html:</div><div class="line">        response = jsonify(&#123;&apos;error&apos;: &apos;forbidden&apos;&#125;)</div><div class="line">        response.status_code = 403</div><div class="line">        return response</div><div class="line">    return render_template(&apos;403.html&apos;), 403</div><div class="line"></div><div class="line">@main.app_errorhandler(500)</div><div class="line">def internal_server_error(e):</div><div class="line">    if request.accept_mimetypes.accept_json and \</div><div class="line">            not request.accept_mimetypes.accept_html:</div><div class="line">        response = jsonify(&#123;&apos;error&apos;: &apos;internal server error&apos;&#125;)</div><div class="line">        response.status_code = 500</div><div class="line">        return response</div><div class="line">    return render_template(&apos;500.html&apos;), 500</div></pre></td></tr></table></figure></p>
<p>API蓝本中错误处理程序，Web服务的视图函数可以调用这些辅助函数生成错误响应<br>文件：<strong>app/api_1_0/errors.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">from flask import jsonify</div><div class="line"></div><div class="line">def bad_request(message):</div><div class="line">    response = jsonify(&#123;&apos;error&apos;: &apos;bad request&apos;, &apos;message&apos;: message&#125;)</div><div class="line">    response.status_code = 400</div><div class="line">    return response</div><div class="line"></div><div class="line">def unauthorized(message):</div><div class="line">    response = jsonify(&#123;&apos;error&apos;: &apos;unauthorized&apos;, &apos;message&apos;: message&#125;)</div><div class="line">    response.status_code = 401</div><div class="line">    return response</div><div class="line"></div><div class="line">def forbidden(message):</div><div class="line">    response = jsonify(&#123;&apos;error&apos;: &apos;forbidden&apos;, &apos;message&apos;: message&#125;)</div><div class="line">    response.status_code = 403</div><div class="line">    return response</div></pre></td></tr></table></figure></p>
<h3 id="使用-Flask-HTTPAuth-认证用户"><a href="#使用-Flask-HTTPAuth-认证用户" class="headerlink" title="使用 Flask-HTTPAuth 认证用户"></a>使用 Flask-HTTPAuth 认证用户</h3><p>Web浏览器外的客户端很难提供对cookie的支持<br>因为REST架构基于HTTP协议，所以发送密令的最佳方式是使用HTTP认证<br>在HTTP认证中，用户密令包含在请求的Authorization首部中<br>Flask-HTTPAuth扩展提供了一个便利的包装，可以把协议的细节隐藏在修饰器之中<br>类似于Flask-Login提供的login_required修饰器<br>因为这种用户认证方法只在API蓝本中使用，所以Flask-HTTPAuth扩展只在蓝本包中初始化<br>验证回调函数把通过认证的用户保存在Flask的全局对象g中<br>文件：<strong>app/api_1_0/authentication.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">from flask.ext.httpauth import HTTPBasicAuth</div><div class="line">from flask import g, jsonify</div><div class="line"></div><div class="line">from ..models import User, AnonymousUser</div><div class="line">from . import api</div><div class="line"></div><div class="line">auth = HTTPBasicAuth()</div><div class="line"></div><div class="line">@auth.verify_password</div><div class="line">def verify_password(email, password):</div><div class="line">    if email == &apos;&apos;: #匿名登录</div><div class="line">        g.current_user = AnonymousUser()</div><div class="line">        return True</div><div class="line">    user = User.query.filter_by(email=email_or_token).first()</div><div class="line">    if not user:</div><div class="line">        return False</div><div class="line">    g.current_user = user</div><div class="line">    return user.verify_password(password)</div></pre></td></tr></table></figure></p>
<p>如果认证密令不正确，服务器向客户端返回401错误，默认情况下，Flask-HTTPAuth自动生成这个状态码<br>为了和API返回的其他错误保持一致，可以自定义这个错误响应<br>由于这个蓝本的所有路由都要使用相同方式进行保护，可以在before_request处理程序中使用一次login_required修饰器，应用到整个蓝本<br>文件：<strong>app/api_1_0/authentication.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">from .errors import unauthorized, forbidden</div><div class="line"></div><div class="line">@auth.error_handler</div><div class="line">def auth_error():</div><div class="line">    return unauthorized(&apos;Invalid credentials&apos;)</div><div class="line"></div><div class="line">@api.before_request</div><div class="line">@auth.login_required</div><div class="line">def before_request():</div><div class="line">    if not g.current_user.is_anonymous and \</div><div class="line">            not g.current_user.confirmed:</div><div class="line">        return forbidden(&apos;Unconfirmed account&apos;)</div></pre></td></tr></table></figure></p>
<h3 id="基于令牌的认证"><a href="#基于令牌的认证" class="headerlink" title="基于令牌的认证"></a>基于令牌的认证</h3><p>客户端首先把登录密令发送给一个特殊的URL，从而生成认证令牌<br>一旦用户获得令牌，就可用令牌代替登录密令的认证请求，处于安全考虑，令牌有过期时间<br>User模型添加新方法，generate_auth_token()使用编码后的用户id字段值生成一个签名令牌，还指定了以秒为单位的过期时间<br>verify_auth_token()接收参数是一个令牌，如果令牌可用就返回对应的用户<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):</div><div class="line">    #....</div><div class="line">    def generate_auth_token(self, expiration):</div><div class="line">        s = Serializer(current_app.config[&apos;SECRET_KEY&apos;],</div><div class="line">                       expires_in=expiration)</div><div class="line">        return s.dumps(&#123;&apos;id&apos;: self.id&#125;).decode(&apos;ascii&apos;)</div><div class="line"></div><div class="line">    @staticmethod</div><div class="line">    def verify_auth_token(token):</div><div class="line">        s = Serializer(current_app.config[&apos;SECRET_KEY&apos;])</div><div class="line">        try:</div><div class="line">            data = s.loads(token)</div><div class="line">        except:</div><div class="line">            return None</div><div class="line">        return User.query.get(data[&apos;id&apos;])</div></pre></td></tr></table></figure></p>
<p>更改回调函数，支持令牌<br>文件：<strong>app/api_1_0/authentication.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@auth.verify_password</div><div class="line">def verify_password(email_or_token, password):</div><div class="line">    if email_or_token == &apos;&apos;:</div><div class="line">        g.current_user = AnonymousUser()</div><div class="line">        return True</div><div class="line">    if password == &apos;&apos;:</div><div class="line">        g.current_user = User.verify_auth_token(email_or_token)</div><div class="line">        g.token_used = True</div><div class="line">        return g.current_user is not None</div><div class="line">    user = User.query.filter_by(email=email_or_token).first()</div><div class="line">    if not user:</div><div class="line">        return False</div><div class="line">    g.current_user = user</div><div class="line">    g.token_used = False</div><div class="line">    return user.verify_password(password)</div></pre></td></tr></table></figure></p>
<p>生成认证令牌，为了避免客户端使用旧令牌申请新令牌,要在视图函数中检查 g.token_used 变量的值,如果使用令牌进行认证就拒绝请求。<br>这个视图函数返回 JSON 格式的响应,其中包含了过期时间为 1 小时的令牌。JSON 格式的响应也包含过期时间。<br>文件：<strong>app/api_1_0/authentication.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/token&apos;)</div><div class="line">def get_token():</div><div class="line">    if g.current_user.is_anonymous or g.token_used:</div><div class="line">        return unauthorized(&apos;Invalid credentials&apos;)</div><div class="line">    return jsonify(&#123;&apos;token&apos;: g.current_user.generate_auth_token(</div><div class="line">        expiration=3600), &apos;expiration&apos;: 3600&#125;)</div></pre></td></tr></table></figure></p>
<h3 id="资源和JSON的序列化转换"><a href="#资源和JSON的序列化转换" class="headerlink" title="资源和JSON的序列化转换"></a>资源和JSON的序列化转换</h3><p>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):</div><div class="line">    #...</div><div class="line">    def to_json(self):</div><div class="line">        json_user = &#123;</div><div class="line">            &apos;url&apos;: url_for(&apos;api.get_post&apos;, id=self.id, _external=True),</div><div class="line">            &apos;name&apos;: self.name,</div><div class="line">            &apos;member_since&apos;: self.member_since,</div><div class="line">            &apos;last_seen&apos;: self.last_seen,</div><div class="line">            &apos;posts&apos;: url_for(&apos;api.get_user_posts&apos;, id=self.id, _external=True),</div><div class="line">            &apos;followed_posts&apos;: url_for(&apos;api.get_user_followed_posts&apos;,</div><div class="line">                                      id=self.id, _external=True),</div><div class="line">            &apos;post_count&apos;: self.posts.count()</div><div class="line">        &#125;</div><div class="line">        return json_user</div><div class="line"></div><div class="line">class Post(db.Model):</div><div class="line">    #...</div><div class="line">    def to_json(self):</div><div class="line">        json_post = &#123;</div><div class="line">            &apos;url&apos;: url_for(&apos;api.get_post&apos;, id=self.id, _external=True),</div><div class="line">            &apos;body&apos;: self.body,</div><div class="line">            &apos;body_html&apos;: self.body_html,</div><div class="line">            &apos;timestamp&apos;: self.timestamp,</div><div class="line">            &apos;author&apos;: url_for(&apos;api.get_user&apos;, id=self.author_id,</div><div class="line">                              _external=True),</div><div class="line">            &apos;comments&apos;: url_for(&apos;api.get_post_comments&apos;, id=self.id,</div><div class="line">                                _external=True),</div><div class="line">            &apos;comment_count&apos;: self.comments.count()</div><div class="line">        &#125;</div><div class="line">        return json_post</div></pre></td></tr></table></figure></p>
<p>从JSON格式数据创建一篇博客文章<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class Post(db.Model):</div><div class="line">    #...</div><div class="line">    @staticmethod</div><div class="line">    def from_json(json_post):</div><div class="line">        body = json_post.get(&apos;body&apos;)</div><div class="line">        if body is None or body == &apos;&apos;:</div><div class="line">            raise ValidationError(&apos;post does not have a body&apos;)</div><div class="line">        return Post(body=body)</div></pre></td></tr></table></figure></p>
<p>文件：<strong>app/exceptions.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">class ValidationError(ValueError):</div><div class="line">    pass</div></pre></td></tr></table></figure></p>
<p>创建一个全局异常处理程序<br>文件：<strong>app/api_1_0/errors.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@api.errorhandler(ValidationError)</div><div class="line">def validation_error(e):</div><div class="line">    return bad_request(e.args[0])</div></pre></td></tr></table></figure></p>
<p>第一个路由处理获取文章集合的请求<br>第二个路由返回单个博客文章<br>文件：<strong>app/api_1_0/posts.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/posts/&apos;)</div><div class="line">@auth.login_required</div><div class="line">def get_posts():</div><div class="line">    posts = Post.query.all()</div><div class="line">    return jsonify(&#123; &apos;posts&apos;: [post.to_json() for post in posts] &#125;)</div><div class="line"></div><div class="line">@api.route(&apos;/posts/&lt;int:id&gt;&apos;)</div><div class="line">def get_post(id):</div><div class="line">    post = Post.query.get_or_404(id)</div><div class="line">    return jsonify(post.to_json())</div></pre></td></tr></table></figure></p>
<p>POST请求处理程序把一篇新博客文章插入数据库<br>文件：<strong>app/api_1_0/posts.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/posts/&apos;, methods=[&apos;POST&apos;])</div><div class="line">@permission_required(Permission.WRITE_ARTICLES)</div><div class="line">def new_post():</div><div class="line">    post = Post.from_json(request.json)</div><div class="line">    post.author = g.current_user</div><div class="line">    db.session.add(post)</div><div class="line">    db.session.commit()</div><div class="line">    return jsonify(post.to_json()), 201, \</div><div class="line">        &#123;&apos;Location&apos;: url_for(&apos;api.get_post&apos;, id=post.id, _external=True)&#125;</div></pre></td></tr></table></figure></p>
<p>permission_required修饰器和程序中使用的类似，但会针对API蓝本进行自定义<br>文件：<strong>app/api_1_0/decorators.oy</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">from functools import wraps</div><div class="line">from flask import g</div><div class="line"></div><div class="line">from .errors import forbidden</div><div class="line"></div><div class="line">def permission_required(permission):</div><div class="line">    def decorator(f):</div><div class="line">        @wraps(f)</div><div class="line">        def decorated_function(*args, **kwargs):</div><div class="line">            if not g.current_user.can(permission):</div><div class="line">                return forbidden(&apos;Insufficient permissions&apos;)</div><div class="line">            return f(*args, **kwargs)</div><div class="line">        return decorated_function</div><div class="line">    return decorator</div></pre></td></tr></table></figure></p>
<p>PUT请求处理程序，修饰器用来检查用户是否有写博客文章的权限<br>文件：<strong>app/api_1_0/posts.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/posts/&lt;int:id&gt;&apos;, methods=[&apos;PUT&apos;])</div><div class="line">@permission_required(Permission.WRITE_ARTICLES)</div><div class="line">def edit_post(id):</div><div class="line">    post = Post.query.get_or_404(id)</div><div class="line">    if g.current_user != post.author and \</div><div class="line">            not g.current_user.can(Permission.ADMINISTER):</div><div class="line">        return forbidden(&apos;Insufficient permissions&apos;)</div><div class="line">    post.body = request.json.get(&apos;body&apos;, post.body)</div><div class="line">    db.session.add(post)</div><div class="line">    return jsonify(post.to_json())</div></pre></td></tr></table></figure></p>
<p>API资源</p>
<table>
<thead>
<tr>
<th>/users/<int:id></int:id></th>
<th>GET</th>
<th>一个用户</th>
</tr>
</thead>
<tbody>
<tr>
<td>/users/<int:id>/posts/</int:id></td>
<td>GET</td>
<td>一个用户发布的博客文章</td>
</tr>
<tr>
<td>/users/<int:id>/timeline/</int:id></td>
<td>GET</td>
<td>一个用户所关注用户发布的文章</td>
</tr>
<tr>
<td>/posts/</td>
<td>GET 、POST</td>
<td>所有博客文章</td>
</tr>
<tr>
<td>/posts/<int:id></int:id></td>
<td>GET 、PUT</td>
<td>一篇博客文章</td>
</tr>
<tr>
<td>/posts/<int:id>comments/</int:id></td>
<td>GET 、POST</td>
<td>一篇博客文章中的评论</td>
</tr>
<tr>
<td>/comments/</td>
<td>GET</td>
<td>所有评论</td>
</tr>
<tr>
<td>/comments/<int:id></int:id></td>
<td>GET</td>
<td>一篇评论</td>
</tr>
</tbody>
</table>
<h3 id="分页大型资源集合"><a href="#分页大型资源集合" class="headerlink" title="分页大型资源集合"></a>分页大型资源集合</h3><p>分页文章资源，JSON格式响应中的posts字段依旧包含各篇文章，但这只是完整集合的一部分<br>文件：<strong>app/api_1_0/posts.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/posts/&apos;)</div><div class="line">def get_posts():</div><div class="line">    page = request.args.get(&apos;page&apos;, 1, type=int)</div><div class="line">    pagination = Post.query.paginate(</div><div class="line">        page, per_page=current_app.config[&apos;FLASKY_POSTS_PER_PAGE&apos;],</div><div class="line">        error_out=False)</div><div class="line">    posts = pagination.items</div><div class="line">    prev = None</div><div class="line">    if pagination.has_prev:</div><div class="line">        prev = url_for(&apos;api.get_posts&apos;, page=page-1, _external=True)</div><div class="line">    next = None</div><div class="line">    if pagination.has_next:</div><div class="line">        next = url_for(&apos;api.get_posts&apos;, page=page+1, _external=True)</div><div class="line">    return jsonify(&#123;</div><div class="line">        &apos;posts&apos;: [post.to_json() for post in posts],</div><div class="line">        &apos;prev&apos;: prev,</div><div class="line">        &apos;next&apos;: next,</div><div class="line">        &apos;count&apos;: pagination.total</div><div class="line">    &#125;)</div></pre></td></tr></table></figure></p>
<h3 id="使用HTTPie测试Web服务"><a href="#使用HTTPie测试Web服务" class="headerlink" title="使用HTTPie测试Web服务"></a>使用HTTPie测试Web服务</h3><p>用户登录发送GET请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth &lt;email&gt;:&lt;password&gt; GET http://localhost:5000/api/v1.0/posts/</div></pre></td></tr></table></figure></p>
<p>匿名用户发送GET请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth  :  GET http://localhost:5000/api/v1.0/posts/</div></pre></td></tr></table></figure></p>
<p>使用POST请求添加一篇新文章<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth harryx520@qq.com:admin POST http://localhost:5000/api/v1.0/posts/ &quot;body=lalala,post from json&quot;</div></pre></td></tr></table></figure></p>
<p>如果要使用认证令牌，可向/api/v1.0/token发送请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth &lt;email&gt;:&lt;password&gt; http://localhost:5000/api/v1.0/token</div></pre></td></tr></table></figure></p>
<p>在有效时间内，这里是一小时，这个令牌可用于访问API<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth eyJhbG...:  GET http://localhost:5000/api/v1.0/posts/</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/23/myblog-0d/" data-id="cj5c7k42d003ym0u4qxfmq0ty" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/04/24/myblog-0e/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Nieuwer</strong>
      <div class="article-nav-title">
        
          myblog-0e 部署
        
      </div>
    </a>
  
  
    <a href="/2016/04/23/myblog-0c/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ouder</strong>
      <div class="article-nav-title">myblog-0c 评论</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Labels</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/acg/">acg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/basic/">basic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bb/">bb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/haskell/">haskell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jquery/">jquery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sicp/">sicp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/soket/">soket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spider/">spider</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 10px;">C#</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/acg/" style="font-size: 10px;">acg</a> <a href="/tags/basic/" style="font-size: 10px;">basic</a> <a href="/tags/bb/" style="font-size: 10px;">bb</a> <a href="/tags/c/" style="font-size: 12.86px;">c++</a> <a href="/tags/django/" style="font-size: 12.86px;">django</a> <a href="/tags/flask/" style="font-size: 20px;">flask</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/haskell/" style="font-size: 10px;">haskell</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/javascript/" style="font-size: 17.14px;">javascript</a> <a href="/tags/jquery/" style="font-size: 15.71px;">jquery</a> <a href="/tags/linux/" style="font-size: 11.43px;">linux</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mysql/" style="font-size: 12.86px;">mysql</a> <a href="/tags/python/" style="font-size: 18.57px;">python</a> <a href="/tags/sicp/" style="font-size: 10px;">sicp</a> <a href="/tags/socket/" style="font-size: 11.43px;">socket</a> <a href="/tags/soket/" style="font-size: 10px;">soket</a> <a href="/tags/spider/" style="font-size: 14.29px;">spider</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archieven</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recente berichten</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/03/effective-C/">effective_C++</a>
          </li>
        
          <li>
            <a href="/2017/04/01/traceback/">异常处理</a>
          </li>
        
          <li>
            <a href="/2017/04/01/logging/">打印日志</a>
          </li>
        
          <li>
            <a href="/2017/04/01/construct/">二进制数据处理</a>
          </li>
        
          <li>
            <a href="/2017/03/29/Csharp/">C#面向对象</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 HeRui<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>