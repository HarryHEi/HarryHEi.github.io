<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="HeRui"><title>myblog-06 角色和权限 · Harryx</title><meta name="description" content="角色和权限角色在数据库中的表示常见的角色为用户和管理员，他们拥有不同的权限在数据库模型中添加一个角色模型，针对不同角色给与不同权限flag标识为True时，表示该角色为默认角色，只能有一个角色为TrueRole通过relationship()与User关联
用户角色数据库模型文件：app/model"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Harryx</a></h3></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>myblog-06 角色和权限</a></h3></div><div class="post-content"><h1 id="角色和权限"><a href="#角色和权限" class="headerlink" title="角色和权限"></a>角色和权限</h1><h2 id="角色在数据库中的表示"><a href="#角色在数据库中的表示" class="headerlink" title="角色在数据库中的表示"></a>角色在数据库中的表示</h2><p>常见的角色为用户和管理员，他们拥有不同的权限<br>在数据库模型中添加一个角色模型，针对不同角色给与不同权限<br>flag标识为True时，表示该角色为默认角色，只能有一个角色为True<br>Role通过relationship()与User关联</p>
<h3 id="用户角色数据库模型"><a href="#用户角色数据库模型" class="headerlink" title="用户角色数据库模型"></a>用户角色数据库模型</h3><p>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">class Role(db.Model):</div><div class="line">    __tablename__=&quot;roles&quot;</div><div class="line">    id = db.Column(db.Integer, primary_key=True)</div><div class="line">    name = db.Column(db.String(64), unique=True, index=True)</div><div class="line">    flag = db.Column(db.Boolean, default=False, index=True)</div><div class="line">    permissions = db.Column(db.Integer)</div><div class="line">    users = db.relationship(&apos;User&apos;, backref=&apos;role&apos;, lazy=&apos;dynamic&apos;)</div><div class="line"></div><div class="line">#...</div><div class="line"></div><div class="line">class User(UserMixin, db.Model):</div><div class="line">    __tablename__ = &apos;users&apos;</div><div class="line">    id = db.Column(db.Integer, primary_key=True)</div><div class="line">    email = db.Column(db.String(64), unique=True, index=True)</div><div class="line">    name = db.Column(db.String(64), unique=True, index=True)</div><div class="line">    password_hash = db.Column(db.String(128))</div><div class="line">    role_id = db.Column(db.Integer, db.ForeignKey(&apos;roles.id&apos;))</div><div class="line">    confirmed = db.Column(db.Boolean, default=False)</div></pre></td></tr></table></figure></p>
<h3 id="mysql数据库表属性"><a href="#mysql数据库表属性" class="headerlink" title="mysql数据库表属性"></a>mysql数据库表属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">mysql&gt; desc users;</div><div class="line">+---------------+------------+------+-----+---------+----------------+</div><div class="line">| Field         | Type       | Null | Key | Default | Extra          |</div><div class="line">+---------------+------------+------+-----+---------+----------------+</div><div class="line">| id            | int(32)    | NO   | PRI | NULL    | auto_increment |</div><div class="line">| email         | char(64)   | YES  | UNI | NULL    |                |</div><div class="line">| name          | char(64)   | YES  | UNI | NULL    |                |</div><div class="line">| password_hash | char(128)  | YES  |     | NULL    |                |</div><div class="line">| confirmed     | tinyint(1) | YES  |     | NULL    |                |</div><div class="line">| role_id       | int(32)    | YES  |     | NULL    |                |</div><div class="line">+---------------+------------+------+-----+---------+----------------+</div><div class="line"></div><div class="line">mysql&gt; desc roles;</div><div class="line">+-------------+------------+------+-----+---------+----------------+</div><div class="line">| Field       | Type       | Null | Key | Default | Extra          |</div><div class="line">+-------------+------------+------+-----+---------+----------------+</div><div class="line">| id          | int(32)    | NO   | PRI | NULL    | auto_increment |</div><div class="line">| name        | char(64)   | YES  | UNI | NULL    |                |</div><div class="line">| permissions | int(32)    | YES  |     | NULL    |                |</div><div class="line">| flag        | tinyint(1) | YES  |     | NULL    |                |</div><div class="line">+-------------+------------+------+-----+---------+----------------+</div></pre></td></tr></table></figure>
<h2 id="权限设置"><a href="#权限设置" class="headerlink" title="权限设置"></a>权限设置</h2><h3 id="程序的权限"><a href="#程序的权限" class="headerlink" title="程序的权限"></a>程序的权限</h3><table>
<thead>
<tr>
<th>操作</th>
<th>位值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>关注用户</td>
<td>0x01</td>
<td>关注其他用户</td>
</tr>
<tr>
<td>评论</td>
<td>0x02</td>
<td>在他人的文章中发表评论</td>
</tr>
<tr>
<td>写文章</td>
<td>0x04</td>
<td>自己写原创文章</td>
</tr>
<tr>
<td>管理他人评论</td>
<td>0x08</td>
<td>查处他人发表的不当评论</td>
</tr>
<tr>
<td>管理员</td>
<td>0x80</td>
<td>管理网站</td>
</tr>
</tbody>
</table>
<h3 id="代码表示权限"><a href="#代码表示权限" class="headerlink" title="代码表示权限"></a>代码表示权限</h3><p>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class Permission:</div><div class="line">    FOLLOW = 0x01</div><div class="line">    COMMENT = 0x02</div><div class="line">    WRITE_ARTICLES = 0x04</div><div class="line">    MODERATE_COMMENTS = 0x08</div><div class="line">    ADMINISTER = 0x80</div></pre></td></tr></table></figure></p>
<h3 id="拥有不同权限的角色"><a href="#拥有不同权限的角色" class="headerlink" title="拥有不同权限的角色"></a>拥有不同权限的角色</h3><table>
<thead>
<tr>
<th>角色</th>
<th>权限</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>匿名</td>
<td>0x00</td>
<td>没有登录的用户，只有阅读权限</td>
</tr>
<tr>
<td>用户</td>
<td>0x07</td>
<td>正常用户，拥有管理以外的权限</td>
</tr>
<tr>
<td>协管员</td>
<td>0x0f</td>
<td>具有审查评论的权限</td>
</tr>
<tr>
<td>管理员</td>
<td>0xff</td>
<td>拥有所有权限</td>
</tr>
</tbody>
</table>
<h2 id="在数据库中创建角色"><a href="#在数据库中创建角色" class="headerlink" title="在数据库中创建角色"></a>在数据库中创建角色</h2><p>自动添加角色<br>roles字典内容有两个参数，一个参数是对应的权限相或(加)，另一个参数是flag，表示是否为默认角色<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">class Role(db.Model):</div><div class="line">    </div><div class="line">    #...</div><div class="line">    @staticmethod</div><div class="line">    def insert_roles():</div><div class="line">        roles = &#123;</div><div class="line">            &apos;User&apos;: (Permission.FOLLOW |</div><div class="line">                     Permission.COMMENT |</div><div class="line">                     Permission.WRITE_ARTICLES, True),</div><div class="line">            &apos;Moderator&apos;: (Permission.FOLLOW |</div><div class="line">                          Permission.COMMENT |</div><div class="line">                          Permission.WRITE_ARTICLES |</div><div class="line">                          Permission.MODERATE_COMMENTS, False),</div><div class="line">            &apos;Administrator&apos;: (0xff, False)</div><div class="line">        &#125;</div><div class="line">        for r in roles:</div><div class="line">            role = Role.query.filter_by(name=r).first()</div><div class="line">            if role is None:</div><div class="line">                role = Role(name=r)</div><div class="line">            role.permissions = roles[r][0]</div><div class="line">            role.flag = roles[r][1]</div><div class="line">            db.session.add(role)</div><div class="line">        db.session.commit()</div></pre></td></tr></table></figure></p>
<p>通过shell会话把角色加入数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(venv) $ python manage.py shell</div><div class="line">&gt;&gt;&gt; Role.insert_roles()</div><div class="line">&gt;&gt;&gt; Role.query.all()</div><div class="line">[&lt;Role u&apos;Administrator&apos;&gt;, &lt;Role u&apos;User&apos;&gt;, &lt;Role u&apos;Moderator&apos;&gt;]</div></pre></td></tr></table></figure></p>
<h2 id="赋予角色"><a href="#赋予角色" class="headerlink" title="赋予角色"></a>赋予角色</h2><p>在用户注册时赋予用户角色，通过环境变量读取<strong>FLASKY_ADMIN</strong>获得管理员电子邮件<br>如果注册的是管理员，则拥有管理员权限，否则为设置的默认角色<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    def __init__(self, **kwargs):</div><div class="line">        super(User, self).__init__(**kwargs)</div><div class="line">        if self.role is None:</div><div class="line">            if self.email == current_app.config[&apos;FLASKY_ADMIN&apos;]:</div><div class="line">                self.role = Role.query.filter_by(permissions=0xff).first()</div><div class="line">            if self.role is None:</div><div class="line">                self.role = Role.query.filter_by(flag=True).first()</div></pre></td></tr></table></figure></p>
<h2 id="角色验证"><a href="#角色验证" class="headerlink" title="角色验证"></a>角色验证</h2><h3 id="检查角色权限的函数"><a href="#检查角色权限的函数" class="headerlink" title="检查角色权限的函数"></a>检查角色权限的函数</h3><p>AnonymousUser类表示未登录的用户，所以不用检查用户是否登录，可以直接调用<strong>current_user.can()</strong><br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">from flask.ext.login import UserMixin, AnonymousUserMixin</div><div class="line"></div><div class="line">class User(UserMixin, db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    def can(self, permissions):</div><div class="line">        return self.role is not None and \</div><div class="line">            (self.role.permissions &amp; permissions) == permissions</div><div class="line"></div><div class="line">    def is_administrator(self):</div><div class="line">        return self.can(Permission.ADMINISTER)</div><div class="line"></div><div class="line">class AnonymousUser(AnonymousUserMixin):</div><div class="line">    def can(self, permissions):</div><div class="line">        return False</div><div class="line"></div><div class="line">    def is_administrator(self):</div><div class="line">        return False</div></pre></td></tr></table></figure></p>
<h3 id="检查用户权限的修饰器"><a href="#检查用户权限的修饰器" class="headerlink" title="检查用户权限的修饰器"></a>检查用户权限的修饰器</h3><p>两个修饰器都使用Python标准库的functools包<br>如果用户不具有指定权限，则返回403错误码<br>需要添加403.html文件和相应路由<br>文件：<strong>app/decorators.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">from functools import wraps</div><div class="line">from flask import abort</div><div class="line">from flask.ext.login import current_user</div><div class="line"></div><div class="line">from .models import Permission</div><div class="line"></div><div class="line"></div><div class="line">def permission_required(permission):</div><div class="line">    def decorator(f):</div><div class="line">        @wraps(f)</div><div class="line">        def decorated_function(*args, **kwargs):</div><div class="line">            if not current_user.can(permission):</div><div class="line">                abort(403)</div><div class="line">            return f(*args, **kwargs)</div><div class="line">        return decorated_function</div><div class="line">    return decorator</div><div class="line"></div><div class="line"></div><div class="line">def admin_required(f):</div><div class="line">    return permission_required(Permission.ADMINISTER)(f)</div></pre></td></tr></table></figure></p>
<p>用法如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">from decorators import admin_required, permission_required</div><div class="line">from .models import Permission</div><div class="line"></div><div class="line">@main.route(&apos;/admin&apos;)</div><div class="line">@login_required</div><div class="line">@admin_required</div><div class="line">def for_admins_only():</div><div class="line">    return &quot;For administrators!&quot;</div><div class="line"></div><div class="line">@main.route(&apos;/moderator&apos;)</div><div class="line">@login_required</div><div class="line">@permission_required(Permission.MODERATE_COMMENTS)</div><div class="line">def for_moderators_only():</div><div class="line">    return &quot;For comment moderators!&quot;</div></pre></td></tr></table></figure></p>
<p>Permission类加入模板上下文<br>文件：<strong>app/main/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from ..models import Permission</div><div class="line"></div><div class="line">@main.app_context_processor</div><div class="line">def inject_permissions():</div><div class="line">    return dict(Permission=Permission)</div></pre></td></tr></table></figure></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-04-16</span><i class="fa fa-tag"></i><a href="/tags/flask/" title="flask" class="tag">flask </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2016/04/16/myblog-06/,Harryx,myblog-06 角色和权限,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2016/04/17/myblog-07/" title="myblog-07 用户资料" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2016/04/15/myblog-05/" title="myblog-05 管理账户" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>