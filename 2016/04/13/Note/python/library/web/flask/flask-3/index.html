<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Ben Wong,wenbinben@gmail.com"><title>myblog-03 数据库和用户认证 · Harryx</title><meta name="description" content="Flask-SQLAlchemy管理数据库初始化一个数据库1234567from flask.ext.sqlalchemy import SQLAlchemyapp.config[&amp;quot;SQLALCHEMY_TRACK_MODIFICATIONS&amp;quot;] = Trueapp.config"><meta name="keywords" content="Hexo,HTML,Ben,CSS,安卓,android,Linux,linuxdeepin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">Harryx</a></h3><div class="description"><p>good good study good good play~</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/harryx520"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/Booooyakasha"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="http://beian.miit.gov.cn/" target="_blank">苏ICP备19072417号-1</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/avator.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>myblog-03 数据库和用户认证</a></h3></div><div class="post-content"><h1 id="Flask-SQLAlchemy管理数据库"><a href="#Flask-SQLAlchemy管理数据库" class="headerlink" title="Flask-SQLAlchemy管理数据库"></a>Flask-SQLAlchemy管理数据库</h1><h2 id="初始化一个数据库"><a href="#初始化一个数据库" class="headerlink" title="初始化一个数据库"></a>初始化一个数据库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask.ext.sqlalchemy import SQLAlchemy</span><br><span class="line"></span><br><span class="line">app.config[&quot;SQLALCHEMY_TRACK_MODIFICATIONS&quot;] = True</span><br><span class="line">app.config[&apos;SQLALCHEMY_DATABASE_URI&apos;] =&apos;mysql://username:password@hostname/database&apos;</span><br><span class="line">app.config[&apos;SQLALCHEMY_COMMIT_ON_TEARDOWN&apos;] = True</span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br></pre></td></tr></table></figure>
<h2 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h2><p>模型表示程序使用的持久化实体，在<strong>ORM</strong>（对象关系映射：Object Relation Mapping）中，模型一般是一个python类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class User(db.Model):</span><br><span class="line">    __tablename__ = &apos;users&apos;</span><br><span class="line">    id = db.Column(db.Integer, primary_key=True)</span><br><span class="line">    name = db.Column(db.String(20), unique=True)</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return &apos;&lt;User %r&gt;&apos; % self.name</span><br></pre></td></tr></table></figure></p>
<p><a href="http://harryhei.github.io/2016/03/12/flask-mysql/" target="_blank" rel="noopener">详细指令</a></p>
<h2 id="数据库创建一个表"><a href="#数据库创建一个表" class="headerlink" title="数据库创建一个表"></a>数据库创建一个表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table users(</span><br><span class="line">    -&gt; id int(32) primary key auto_increment,</span><br><span class="line">    -&gt; name char(20) unique);</span><br></pre></td></tr></table></figure>
<h2 id="插入一个数据"><a href="#插入一个数据" class="headerlink" title="插入一个数据"></a>插入一个数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert users</span><br><span class="line">    -&gt; (id,name)</span><br><span class="line">    -&gt; values (1,harry);</span><br></pre></td></tr></table></figure>
<h2 id="集成Python-Shell"><a href="#集成Python-Shell" class="headerlink" title="集成Python Shell"></a>集成Python Shell</h2><p>注册一个<strong>make_shell_context()</strong>回调函数<br>不用每次都从Shell导入模型和实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from flask.ext.script import Shell</span><br><span class="line"></span><br><span class="line">def make_shell_context():</span><br><span class="line">    return dict(app=app, db=db, User=User)</span><br><span class="line">manager.add_command(&quot;shell&quot;, Shell(make_context=make_shell_context))</span><br></pre></td></tr></table></figure></p>
<h2 id="视图函数操作"><a href="#视图函数操作" class="headerlink" title="视图函数操作"></a>视图函数操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def index():</span><br><span class="line">    form = NameForm()</span><br><span class="line">    if form.validate_on_submit():</span><br><span class="line">        user = User.query.filter_by(name=form.name.data).first()</span><br><span class="line">        if user is None:</span><br><span class="line">            flash(&quot;I think you are new here~&quot;)</span><br><span class="line">            user = User(name = form.name.data)</span><br><span class="line">            db.session.add(user)</span><br><span class="line">        session[&apos;name&apos;] = form.name.data</span><br><span class="line">        form.name.data = &apos;&apos;</span><br><span class="line">        return redirect(url_for(&apos;index&apos;))</span><br><span class="line">    return render_template(&apos;index.html&apos;, form=form, name=session.get(&apos;name&apos;))</span><br></pre></td></tr></table></figure>
<h2 id="创建迁移仓库"><a href="#创建迁移仓库" class="headerlink" title="创建迁移仓库"></a>创建迁移仓库</h2><h3 id="配置Flask-Migrate"><a href="#配置Flask-Migrate" class="headerlink" title="配置Flask-Migrate"></a>配置Flask-Migrate</h3><p>Flask-Migrate提供了一个MigrateCommand类，可以附加到Flask-Script的manager对象上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from flask.ext.migrate import Migrate, MigrateCommand</span><br><span class="line"></span><br><span class="line"># ...</span><br><span class="line"></span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line">manager.add_command(&apos;db&apos;, MigrateCommand)</span><br></pre></td></tr></table></figure></p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>如果已经初始化过，需要删除之前的版本，并且要删除之前创建migrations文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; DROP TABLE alembic_version;</span><br></pre></td></tr></table></figure></p>
<p>初始化会创建migrations文件，所有迁移脚本都存放其中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(venv)$ python blog.py db init</span><br><span class="line">  Creating directory /home/herui/myblog/migrations ... done</span><br><span class="line">  Creating directory /home/herui/myblog/migrations/versions ... done</span><br><span class="line">  Generating /home/herui/myblog/migrations/alembic.ini ... done</span><br><span class="line">  Generating /home/herui/myblog/migrations/env.pyc ... done</span><br><span class="line">  Generating /home/herui/myblog/migrations/script.py.mako ... done</span><br><span class="line">  Generating /home/herui/myblog/migrations/env.py ... done</span><br><span class="line">  Generating /home/herui/myblog/migrations/README ... done</span><br><span class="line">  Please edit configuration/connection/logging settings in</span><br><span class="line">  &apos;/home/herui/myblog/migrations/alembic.ini&apos; before proceeding.</span><br></pre></td></tr></table></figure></p>
<h3 id="创建迁移脚本"><a href="#创建迁移脚本" class="headerlink" title="创建迁移脚本"></a>创建迁移脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(venv)$ python blog.py db migrate -m &quot;initial migration&quot;</span><br><span class="line">INFO  [alembic.runtime.migration] Context impl MySQLImpl.</span><br><span class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</span><br><span class="line">INFO  [alembic.env] No changes in schema detected.</span><br></pre></td></tr></table></figure>
<h3 id="更新数据库"><a href="#更新数据库" class="headerlink" title="更新数据库"></a>更新数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(venv)$ python blog.py db upgrade</span><br><span class="line">INFO  [alembic.runtime.migration] Context impl MySQLImpl.</span><br><span class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</span><br></pre></td></tr></table></figure>
<h1 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h1><h2 id="密码散列值"><a href="#密码散列值" class="headerlink" title="密码散列值"></a>密码散列值</h2><p>使用Werkzeug实现密码散列</p>
<ul>
<li><strong>generate_password_hash(password, method= pbkdf2:sha1 , salt_length=8)</strong>：<br>这个函数将原始密码作为输入，以字符串形式输出密码散列值，method，salt_length默认值能满足大部分需求</li>
<li><strong>check_password_hash(hash, password)</strong>：<br>这个函数参数是从数据库读回的密码散列值和用户输入的密码，返回值为True表示密码正确</li>
</ul>
<p>生成散列值后不能还原成原来的密码<br>在User模型中加入密码散列<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from werkzeug.security import generate_password_hash, check_password_hash</span><br><span class="line"></span><br><span class="line">@property</span><br><span class="line">def password(self):</span><br><span class="line">    raise AttributeError(&apos;password is not a readable attribute&apos;)</span><br><span class="line"></span><br><span class="line">@password.setter</span><br><span class="line">def password(self, password):</span><br><span class="line">    self.password_hash = generate_password_hash(password)</span><br><span class="line"></span><br><span class="line">def verify_password(self, password):</span><br><span class="line">    return check_password_hash(self.password_hash, password)</span><br></pre></td></tr></table></figure></p>
<h2 id="创建认证蓝本"><a href="#创建认证蓝本" class="headerlink" title="创建认证蓝本"></a>创建认证蓝本</h2><p>对于不同的程序功能使用不同的蓝本<br>文件：<strong>app/auth/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from flask import Blueprint</span><br><span class="line"></span><br><span class="line">auth = Blueprint(&apos;auth&apos;, __name__)</span><br><span class="line"></span><br><span class="line">from . import views</span><br></pre></td></tr></table></figure></p>
<p>添加路由和视图函数<br>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import render_template</span><br><span class="line"></span><br><span class="line">from . import auth</span><br><span class="line"></span><br><span class="line">@auth.route(&apos;/login&apos;)</span><br><span class="line">def login():</span><br><span class="line">    return render_template(&apos;auth/login.html&apos;)</span><br></pre></td></tr></table></figure></p>
<p>文件：<strong>app/auth/login.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;login&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line">&lt;div class=&quot;page-header&quot;&gt;</span><br><span class="line">    &lt;h1&gt;Login&lt;/h1&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></p>
<p>在<strong>create_app()</strong>工厂函数中附加auth蓝本<br>url_prefix是可选参数，如果使用了这个参数，注册后蓝本中定义的所有路由都会加上前缀，这个例子为即/auth<br>文件：<strong>app/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def create_app(config_name):</span><br><span class="line"></span><br><span class="line">    #...</span><br><span class="line"></span><br><span class="line">    from .auth import auth as auth_blueprint</span><br><span class="line">    app.register_blueprint(auth_blueprint, url_prefix=&apos;/auth&apos;)</span><br><span class="line"></span><br><span class="line">    return app</span><br></pre></td></tr></table></figure></p>
<h2 id="使用Flask-Login认证用户"><a href="#使用Flask-Login认证用户" class="headerlink" title="使用Flask-Login认证用户"></a>使用Flask-Login认证用户</h2><h3 id="准备用于登录的用户模型"><a href="#准备用于登录的用户模型" class="headerlink" title="准备用于登录的用户模型"></a>准备用于登录的用户模型</h3><p>Flask-Login提供了一个UserMixin类，包含一些方法的默认实现<br>文件：app/models.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask.ext.login import UserMixin</span><br><span class="line"></span><br><span class="line">class User(UserMixin, db.Model):</span><br><span class="line">    __tablename__ = &apos;users&apos;</span><br><span class="line">    id = db.Column(db.Integer, primary_key = True)</span><br><span class="line">    email = db.Column(db.String(64), unique=True, index=True)</span><br><span class="line">    name = db.Column(db.String(64), unique=True, index=True)</span><br><span class="line">    password_hash = db.Column(db.String(128))</span><br></pre></td></tr></table></figure></p>
<h3 id="Flask-Login在工厂函数中初始化"><a href="#Flask-Login在工厂函数中初始化" class="headerlink" title="Flask-Login在工厂函数中初始化"></a>Flask-Login在工厂函数中初始化</h3><p>login_manager对象的session_protection可以设置为None、’basic’、’strong’，以提供不同的安全等级防止用户会话遭篡改<br>Flask-Login会记录客户端IP地址和浏览器的用户代理信息，如果发现异动就登出用户<br>login_view属性设置登录页面的端点，登录路由在蓝本中定义，要在前面加上蓝本名字(auth)<br>文件：<strong>app/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from flask.ext.login import LoginManager</span><br><span class="line"></span><br><span class="line">login_manager = LoginManager()</span><br><span class="line">login_manager.session_protection = &apos;strong&apos;</span><br><span class="line">login_manager.login_view = &apos;auth.login&apos;</span><br><span class="line"></span><br><span class="line">def create_app(config_name):</span><br><span class="line">    # ...</span><br><span class="line">    login_manager.init_app(app)</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure></p>
<p>回调函数，使用指定标识符加载用户，返回用户对象或者None<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from . import login_manager</span><br><span class="line"></span><br><span class="line">@login_manager.user_loader</span><br><span class="line">def load_user(user_id):</span><br><span class="line">    return User.query.get(int(user_id))</span><br></pre></td></tr></table></figure></p>
<h3 id="保护路由"><a href="#保护路由" class="headerlink" title="保护路由"></a>保护路由</h3><p>为了保护路由只让认证用户访问，Flask-Login提供了一个login_require修饰器<br>如果没有认证的用户访问这个路由，会拦截请求，把用户发往登录页面<br>用法如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from flask.ext.login import login_required</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/secret&apos;)</span><br><span class="line">@login_required</span><br><span class="line">def secret():</span><br><span class="line">    return &apos;Only authenticated users are allowed!&apos;</span><br></pre></td></tr></table></figure></p>
<h3 id="添加登录表单"><a href="#添加登录表单" class="headerlink" title="添加登录表单"></a>添加登录表单</h3><p>包含输入邮件、密码、记住无复选框和提交按钮<br>文件：<strong>app/auth/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask.ext.wtf import Form</span><br><span class="line">from wtforms import StringField, PasswordField, BooleanField, SubmitField</span><br><span class="line">from wtforms.validators import Required, Length, Email</span><br><span class="line"></span><br><span class="line">class LoginForm(Form):</span><br><span class="line">    email = StringField(&apos;Email&apos;, validators=[Required(), Length(1, 64),Email()])</span><br><span class="line">    password = PasswordField(&apos;Password&apos;, validators=[Required()])</span><br><span class="line">    remember_me = BooleanField(&apos;Keep me logged in&apos;)</span><br><span class="line">    submit = SubmitField(&apos;Log In&apos;)</span><br></pre></td></tr></table></figure></p>
<h3 id="登录页面：auth-login-html"><a href="#登录页面：auth-login-html" class="headerlink" title="登录页面：auth/login.html"></a>登录页面：auth/login.html</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Login&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line">&lt;div class=&quot;page-header&quot;&gt;</span><br><span class="line">    &lt;h1&gt;Login&lt;/h1&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;col-md-4&quot;&gt;</span><br><span class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在导航条中添加Sign-In和Sign-Out链接"><a href="#在导航条中添加Sign-In和Sign-Out链接" class="headerlink" title="在导航条中添加Sign In和Sign Out链接"></a>在导航条中添加Sign In和Sign Out链接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;</span><br><span class="line">&#123; % if current_user.is_authenticated() % &#125;</span><br><span class="line">&lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;auth.logout&apos;) &#125;&#125;&quot;&gt;Sign Out&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">&#123; % else % &#125;</span><br><span class="line">&lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;auth.login&apos;) &#125;&#125;&quot;&gt;Sign In&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">&#123; % endif % &#125;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<h3 id="登入用户"><a href="#登入用户" class="headerlink" title="登入用户"></a>登入用户</h3><p>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">from flask import render_template, redirect, request, url_for, flash</span><br><span class="line">from flask.ext.login import login_user, logout_user</span><br><span class="line"></span><br><span class="line">from . import auth</span><br><span class="line">from ..models import User</span><br><span class="line">from .forms import LoginForm</span><br><span class="line"></span><br><span class="line">@auth.route(&apos;/login&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def login():</span><br><span class="line">    #创建一个**LoginForm()**对象</span><br><span class="line">    form = LoginForm()</span><br><span class="line">    if form.validate_on_submit():</span><br><span class="line">        #如果电子邮件对应的用户存在</span><br><span class="line">        user = User.query.filter_by(email=form.email.data).first()</span><br><span class="line"></span><br><span class="line">        调用用户对象的verify_password()方法，检测输入的密码</span><br><span class="line">        if user is not None and user.verify_password(form.password.data):</span><br><span class="line">            #调用Flask-Login的login_user函数，把用户标记为已登录，第二个参数为“记住我”</span><br><span class="line">            login_user(user, form.remember_me.data)</span><br><span class="line">            return redirect(request.args.get(&apos;next&apos;) or url_for(&apos;main.index&apos;))</span><br><span class="line">        flash(&apos;Invalid username or password.&apos;)</span><br><span class="line"></span><br><span class="line">    #请求类型为GET时直接显示表单</span><br><span class="line">    return render_template(&apos;auth/login.html&apos;, form=form)</span><br></pre></td></tr></table></figure></p>
<h3 id="登出用户"><a href="#登出用户" class="headerlink" title="登出用户"></a>登出用户</h3><p>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask.ext.login import logout_user, login_required</span><br><span class="line"></span><br><span class="line">@auth.route(&apos;/logout&apos;)</span><br><span class="line">@login_required</span><br><span class="line">def logout():</span><br><span class="line">    #调用Flask-Login中的logout_user()函数</span><br><span class="line">    logout_user()</span><br><span class="line">    flash(&apos;You have been logged out.&apos;)</span><br><span class="line">    return redirect(url_for(&apos;main.index&apos;))</span><br></pre></td></tr></table></figure></p>
<h3 id="测试登录"><a href="#测试登录" class="headerlink" title="测试登录"></a>测试登录</h3><p>在Shell界面注册用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(venv)$ python manage.py shell</span><br><span class="line">&gt;&gt;&gt; u = User(id=1,name=&quot;harry&quot;,email=&quot;harryx520@qq.com&quot;,password=&quot;lalala&quot;)</span><br><span class="line">&gt;&gt;&gt; db.session.add(u)</span><br><span class="line">&gt;&gt;&gt; db.session.commit()</span><br></pre></td></tr></table></figure></p>
<p>查看数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from users;</span><br><span class="line"></span><br><span class="line">|  1 | harryx520@qq.com | harry | pbkdf2:sha1:1(...)ffba4781 |</span><br></pre></td></tr></table></figure></p>
<h1 id="数据库常用操作"><a href="#数据库常用操作" class="headerlink" title="数据库常用操作"></a>数据库常用操作</h1><h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><p>创建普通有一个约束的表</p>
<p><code>person_id</code>作为主键约束</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table person</span><br><span class="line">    -&gt; (person_id int(5) unsigned,</span><br><span class="line">    -&gt; name char(64),</span><br><span class="line">    -&gt; gender enum(&apos;M&apos;,&apos;F&apos;),</span><br><span class="line">    -&gt; state char(64),</span><br><span class="line">    -&gt; constraint pk_person primary key (person_id))default charset=utf8;</span><br></pre></td></tr></table></figure>
<p>创建具有外键约束的表</p>
<p><code>person_id</code>和<code>food</code>同时作为主键约束，<code>person_id</code>作为外键约束</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table fav_food</span><br><span class="line">    -&gt; (person_id int(5) unsigned,</span><br><span class="line">    -&gt; food char(64),</span><br><span class="line">    -&gt; constraint pk_fav_food primary key (person_id, food),</span><br><span class="line">    -&gt; constraint fk_fav_food_person_id foreign key (person_id)</span><br><span class="line">    -&gt;      references person (person_id))default charset=utf8;</span><br></pre></td></tr></table></figure>
<h2 id="修改表"><a href="#修改表" class="headerlink" title="修改表"></a>修改表</h2><p>alter table用于修改已经存在的表定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table person modify person_id int(5) unsigned auto_increment;</span><br></pre></td></tr></table></figure>
<h2 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h2><p>insert语句由三个部分构成：表的名称、列的名称、值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into person</span><br><span class="line">    -&gt; (name, gender, state)</span><br><span class="line">    -&gt; values (&quot;harryx&quot;, &quot;M&quot;, &quot;中国&quot;);</span><br></pre></td></tr></table></figure>
<h2 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h2><p>可以指定列、指定顺序、设置条件</p>
<p>可以添加如下：</p>
<ul>
<li>字符，比如数字和字符串</li>
<li>表达式</li>
<li>调用内建函数</li>
<li>自定义函数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select person_id,name,gender from person where state=&quot;中国&quot;;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from person order by name;</span><br><span class="line"></span><br><span class="line">mysql&gt; select name,&quot;is&quot;,gender from person;</span><br><span class="line"></span><br><span class="line">mysql&gt; select version(),user(),database();</span><br></pre></td></tr></table></figure>
<h3 id="使用别名"><a href="#使用别名" class="headerlink" title="使用别名"></a>使用别名</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name as n,gender as g from person;</span><br></pre></td></tr></table></figure>
<h3 id="去除重复"><a href="#去除重复" class="headerlink" title="去除重复"></a>去除重复</h3><p>注意，需要先排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select distinct person_id from fav_food;</span><br></pre></td></tr></table></figure>
<p>查询的表可以是临时表和虚拟表</p>
<p>在子表查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select e.name,e.state from (select * from person) as e;</span><br></pre></td></tr></table></figure>
<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>试图并不存储数据，只提供查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create view person_vw as</span><br><span class="line">    -&gt; select name from person;</span><br></pre></td></tr></table></figure>
<h3 id="表连接"><a href="#表连接" class="headerlink" title="表连接"></a>表连接</h3><p>内连接（不用inner关键字的话也是默认内连接）<br>不提供<code>on</code>关键字的话是笛卡尔积</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select p.name,f.food</span><br><span class="line">    -&gt; from person as p inner join fav_food as f</span><br><span class="line">    -&gt; on p.person_id = f.person_id;</span><br></pre></td></tr></table></figure>
<p>如果如果连接的表关键字是相同的可以使用<code>using</code>代替<code>on</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select p.name,p.state,f.food</span><br><span class="line">    -&gt; from person as p inner join fav_food as f</span><br><span class="line">    -&gt; using (person_id);</span><br></pre></td></tr></table></figure>
<p>连接多个表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select p.name,f.food,a.about</span><br><span class="line">    -&gt; from person as p inner join fav_food as f</span><br><span class="line">    -&gt; using(person_id)</span><br><span class="line">    -&gt; inner join about_me as a</span><br><span class="line">    -&gt; using(person_id);</span><br></pre></td></tr></table></figure>
<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><p>group by 根据某一列的值分组</p>
<p>having 对数据进行过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select p.name,count(f.food) </span><br><span class="line">    -&gt; from person as p inner join fav_food as f </span><br><span class="line">    -&gt; on p.person_id = f.person_id </span><br><span class="line">    -&gt; group by p.name;</span><br><span class="line">    -&gt; having p.name != &quot;harry&quot;;</span><br></pre></td></tr></table></figure>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>order by 用于对结果的列数据或者根据表达式结果排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//根据state排序</span><br><span class="line">mysql&gt; select * from person order by state;</span><br><span class="line"></span><br><span class="line">//根据state 和 name 排序</span><br><span class="line">mysql&gt; select * from person order by state,name;</span><br></pre></td></tr></table></figure>
<p>加上desc降序排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//降序排序</span><br><span class="line">mysql&gt; select * from person order by person_id desc;</span><br></pre></td></tr></table></figure>
<p>limit 限制显示行数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//person_id最大的显示前三行</span><br><span class="line">mysql&gt; select * from person order by person_id desc limit 3;</span><br></pre></td></tr></table></figure>
<h3 id="使用集合"><a href="#使用集合" class="headerlink" title="使用集合"></a>使用集合</h3><p>union 连接数据，排除重复项<br>union all 连接数据，保留重复项</p>
<p>intersect 交集，MySQL不支持</p>
<p>except 差集，MySQL不支持</p>
<h2 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h2><p>更新语句可以更新一行或者匹配到的多行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update person</span><br><span class="line">    -&gt; set state=&quot;美国&quot;</span><br><span class="line">    -&gt; where person_id=4;</span><br></pre></td></tr></table></figure>
<p>级联更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table fav_food</span><br><span class="line">    -&gt; add constraint fk_food_peron foreign key (person_id)</span><br><span class="line">    -&gt; references person(person_id)</span><br><span class="line">    -&gt; on update cascade;</span><br></pre></td></tr></table></figure>
<h2 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h2><p>如果被删除的列设置了外键，需要在子表添加外键时申明级联删除<br>在申明级联删除前先删除外键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table fav_food </span><br><span class="line">    -&gt; add constraint fk_person_id foreign key (person_id) </span><br><span class="line">    -&gt; references person (person_id) on delete cascade;</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from person where name=&quot;o&quot;;</span><br></pre></td></tr></table></figure>
<h2 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h2><p>可以获取XML格式的数据，需要制定xml格式进入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u flask -p --xml flaskdb</span><br></pre></td></tr></table></figure>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>关闭自动提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br></pre></td></tr></table></figure>
<p>关闭自动提交后，所有的SQL命令都在一个事务内<br>显式使用<code>rollback</code>回滚数据<br>显式使用<code>commit</code>提交数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from person where person_id=4;</span><br><span class="line">mysql&gt; rollback;</span><br></pre></td></tr></table></figure>
<p>设置保存点</p>
<p>保存点拥有名字，可以拥有多个保存点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from fav_food where food=&quot;ice&quot;;</span><br><span class="line">mysql&gt; savepoint point_1;</span><br><span class="line">mysql&gt; delete from fav_food where food=&quot;apple&quot;;</span><br><span class="line">mysql&gt; savepoint point_2;</span><br><span class="line">mysql&gt; rollback to savepoint point_1;</span><br></pre></td></tr></table></figure>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>添加索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table person</span><br><span class="line">    -&gt; add index ind_name (name);</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create index ind_name on person(name);</span><br></pre></td></tr></table></figure>
<p>查询索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show index from person \G</span><br></pre></td></tr></table></figure>
<p>删除某个索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table person</span><br><span class="line">    -&gt; drop index ind_name;</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; drop index ind_name on person;</span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-04-13</span><i class="fa fa-tag"></i><a class="tag" href="/tags/mysql/" title="mysql">mysql </a><a class="tag" href="/tags/flask/" title="flask">flask </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2016/04/13/Note/python/library/web/flask/flask-3/,Harryx,myblog-03 数据库和用户认证,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/04/14/Note/python/library/web/flask/flask-4/" title="myblog-04 用户注册">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/04/12/Note/python/library/web/flask/flask-2/" title="myblog-02 表单">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>