<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Harryx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Harryx">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Harryx">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Harryx">
  
    <link rel="alternate" href="/atom.xml" title="Harryx" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Harryx</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-javascript-01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/26/javascript-01/" class="article-date">
  <time datetime="2016-04-26T00:11:58.000Z" itemprop="datePublished">2016-04-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/26/javascript-01/">javascript-01 语法和数据结构</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JavaScript语法"><a href="#JavaScript语法" class="headerlink" title="JavaScript语法"></a>JavaScript语法</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>JavaScript不需要特殊软件编译执行，只要有Web浏览器就够了。<br>JavaScript是一种解释型脚本语言，Web浏览器负责解释执行。<br>打开浏览器，摁F12呼出浏览器的控制台，可以观测运行状况。</p>
<p>JavaScript有两种方式执行。<br>第一种方式是将JavaScript代码放在head标签中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html &gt;</div><div class="line">&lt;html lang=&quot;en&quot;&gt;</div><div class="line">    &lt;head&gt;</div><div class="line">        &lt;meta charset=&quot;utf-8&quot; /&gt;</div><div class="line">        &lt;title&gt;JavaScript&lt;/title&gt;</div><div class="line">        &lt;script type=&quot;text/javascript&quot;&gt;</div><div class="line">                function displayMsg()</div><div class="line">                &#123;</div><div class="line">                    alert(&quot;Hello World!&quot;)</div><div class="line">                &#125;</div><div class="line">        &lt;/script&gt;</div><div class="line">    &lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;div class=&quot;myname&quot;&gt;</div><div class="line">        Javascript</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>第二种方式是把JavaScript保存在一个名为.js的独立文件，在文档的head标签部分放一个script标签，并把src指向该文件。<br>因为脚本默认为JavaScript，所以没必要指定type=”text/javascript”属性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html &gt;</div><div class="line">&lt;html lang=&quot;en&quot;&gt;</div><div class="line">    &lt;head&gt;</div><div class="line">        &lt;meta charset=&quot;utf-8&quot; /&gt;</div><div class="line">        &lt;title&gt;JavaScript&lt;/title&gt;</div><div class="line">        &lt;script type=&quot;text/javascript&quot; src=&quot;test.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;div class=&quot;myname&quot;&gt;</div><div class="line">        Javascript</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>或者把script标签放在HTML文档最后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html &gt;</div><div class="line">&lt;html lang=&quot;en&quot;&gt;</div><div class="line">    &lt;head&gt;</div><div class="line">        &lt;meta charset=&quot;utf-8&quot; /&gt;</div><div class="line">        &lt;title&gt;JavaScript&lt;/title&gt;</div><div class="line">    &lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;div class=&quot;myname&quot;&gt;</div><div class="line">        Javascript</div><div class="line">    &lt;/div&gt;</div><div class="line">    &lt;script src=&quot;test.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h3><p>各条语句可以放在不同行就可以分隔他们<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">first</div><div class="line">second</div></pre></td></tr></table></figure></p>
<p>如果放在同一行，就需要用分号隔开<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">first; second;</div></pre></td></tr></table></figure></p>
<p>建议在每条语句后加分号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">first;</div><div class="line">second;</div></pre></td></tr></table></figure></p>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>两个斜杠作为一行的开始，这一行就会被当成注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">//这是一条注释</div></pre></td></tr></table></figure></p>
<p>使用”/<em>    </em>/“可以多行注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/* 多行注释</div><div class="line">注释多行 */</div></pre></td></tr></table></figure></p>
<p>或者使用HTML风格注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 这是HTML风格注释 --&gt;</div></pre></td></tr></table></figure></p>
<p>但是为了避免混淆，最好使用双斜杠和’/**/‘注释</p>
<h2 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h2><p>条件必须放在if后面的圆括号内<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var a = 100;</div><div class="line">if (a&gt;50)</div><div class="line">&#123;</div><div class="line">    alert(&quot;&gt;50&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>if后面可以有一个else语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var a = 20;</div><div class="line">if (a&gt;50)</div><div class="line">&#123;</div><div class="line">    alert(&quot;&gt;50&quot;);</div><div class="line">&#125;</div><div class="line">else</div><div class="line">&#123;</div><div class="line">    alert(&quot;&lt;50&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>比较操作符</strong>，可以是”&gt;”、”&lt;”、”&gt;=”、”&lt;=”、”==”、”!=”<br>字符串可以使用”==”号判断是否相同<br>“==”并不是严格相同，下面这个例子条件语句求值结果是true，相等操作符把空字符串认为与false相同<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var a = false;</div><div class="line">var b = &quot;&quot;;</div><div class="line">if (a==b)</div><div class="line">&#123;</div><div class="line">    alert(&quot;equal&quot;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>“===”会执行严格的比较，下面条件语句执行结果为False，同样的，严格的不等使用”!==”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var a = false;</div><div class="line">var b = &quot;&quot;;</div><div class="line">if (a===b)</div><div class="line">&#123;</div><div class="line">    alert(&quot;equal&quot;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>逻辑操作符</strong>包括，与”&amp;&amp;”、或”||”、非”!”</p>
<h2 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h2><p>while循环<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var a = 10;</div><div class="line">while (a&gt;0)</div><div class="line">&#123;</div><div class="line">    alert(a);</div><div class="line">    a --;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>do…while循环<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var a = 10;</div><div class="line">do</div><div class="line">&#123;</div><div class="line">    alert(a)</div><div class="line">    a++;</div><div class="line">&#125;</div><div class="line">while(a&lt;20)</div></pre></td></tr></table></figure></p>
<p>for循环<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">for (var count=1; count&lt;10; count++)</div><div class="line">&#123;</div><div class="line">    alert(count);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>定义函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">function shout (num)</div><div class="line">&#123;</div><div class="line">    for (var count=0; count&lt;num; count++)</div><div class="line">    &#123;</div><div class="line">        alert(count)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">shout(10)</div></pre></td></tr></table></figure></p>
<p>#数据结构<br>2016年5月10日编辑，参考《学习javascript数据结构与算法》一书</p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>声明变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var name;</div></pre></td></tr></table></figure></p>
<p>赋值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">name = &quot;javascript&quot;;</div></pre></td></tr></table></figure></p>
<p>JavaScript允许直接对变量赋值而不需要声明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">name = &quot;javascript&quot;;</div><div class="line">alert(name);</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var name=&quot;javascript&quot;;</div></pre></td></tr></table></figure></p>
<p>JavaScript变量名可以是字母数字下划线，不过数字不能是第一个字符<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var my_name = &quot;javascript&quot;;</div></pre></td></tr></table></figure></p>
<p>另一种方式是使用驼峰格式(camel case)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var myName = &quot;javascript&quot;;</div></pre></td></tr></table></figure></p>
<h2 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h2><p>除了支持：“+ - <em> / % ++ – &gt; &lt; &gt;= &lt;= == = += -= </em>= /= %= &amp;&amp; || ! &amp; | ~ ^ &gt;&gt; &lt;&lt;”<br>还支持：”typeof delete(删除对象属性)”</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><h3 id="变量-1"><a href="#变量-1" class="headerlink" title="变量"></a>变量</h3><p>JavaScript不需要进行类型声明<br>下面两句都是合法的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var age = &quot;thirty three&quot;;</div><div class="line">age = 33;</div></pre></td></tr></table></figure></p>
<p>字符换必须包含在引号里面，单引号双引号都可以，如果字符串已经有引号，就得用另外一个引号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var name = &quot;i don&apos;t know&quot;;</div></pre></td></tr></table></figure></p>
<p>或者使用转义字符<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var name = &apos;i don\&apos;t know&apos;;</div></pre></td></tr></table></figure></p>
<p>如果给一个变量赋值，数值可以是整数，也可以是浮点数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var num = -2.33333;</div></pre></td></tr></table></figure></p>
<p>还有一种数据类型是布尔类型，他只有两个可选值true或者false，注意这不是字符串，不能用引号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var select = true;</div></pre></td></tr></table></figure></p>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>创建一个数组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var list = Array(4);</div></pre></td></tr></table></figure></p>
<p>也可以不指定长度<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var list = Array();</div></pre></td></tr></table></figure></p>
<p>给数组赋值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var list = Array();</div><div class="line">list[0] = 100;</div><div class="line">list[1] = &quot;RMB&quot;;</div><div class="line">alert(list[0]);</div><div class="line">alert(list);</div></pre></td></tr></table></figure></p>
<p>创建数组的时候赋值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var list = Array(100, &quot;RMB&quot;, 200, &quot;dollors&quot;);</div></pre></td></tr></table></figure></p>
<p>也可以使用方括号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var list = [100, &quot;RMB&quot;];</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var list = [];</div><div class="line">list[0] = 100;</div><div class="line">list[3] = 200;</div><div class="line">alert(list);</div></pre></td></tr></table></figure></p>
<p>可以用字符串代替数字值，这样的数组称为<strong>关联数组</strong><br>实际上创建的是一个Array对象属性，本身的内容并没有被填充，下例就是给list添加了name、year两个属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var list = [];</div><div class="line">list[&quot;name&quot;] = &quot;harry&quot;;</div><div class="line">list[&quot;year&quot;] = &quot;100&quot;</div><div class="line">alert(list); //返回空</div><div class="line">alert(list[&quot;name&quot;]); //返回harry</div></pre></td></tr></table></figure></p>
<p>添加元素<br>在数组末尾添加元素，可以直接赋值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var list = [1,2,3,4];</div><div class="line">list[list.length] = 5;</div></pre></td></tr></table></figure></p>
<p>或者使用push方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var list = [1,2,3,4];</div><div class="line">list.push(5);</div></pre></td></tr></table></figure></p>
<p>在首部添加，使用unshift方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">list.unshift(-2,-1,0);</div></pre></td></tr></table></figure></p>
<p>删除元素<br>删除最后一个元素，使用pop方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">list.pop();</div></pre></td></tr></table></figure></p>
<p>删除数组的第一个元素，使用shift方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">list.shift();</div></pre></td></tr></table></figure></p>
<p>删除指定位置的元素，使用splice方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">list.splice(3,2); //删除索引3开始的2各元素</div></pre></td></tr></table></figure></p>
<p>数组中插入元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">list.splice(5,0,1,2,3); //第二个参数是删除元素的个数，这里是0，第三个参数往后就是要添加的元素</div></pre></td></tr></table></figure></p>
<p>二维和多维数组<br>数组元素可以是数组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var list = [1,2,3,[1,2,3,[1,2,3]]];</div><div class="line">alert(list);</div></pre></td></tr></table></figure></p>
<p>构成一个二维数组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">car list=[]</div><div class="line">list[0]=[1,2,3,4]</div><div class="line">list[1]=[5,6,7,8]</div></pre></td></tr></table></figure></p>
<h3 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h3><p>every迭代器会迭代每个元素，直到返回false<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; lis=[1,2,3,4,5]</div><div class="line">&gt; lis.every(function(x)&#123;return x&gt;0&#125;)</div><div class="line">true</div><div class="line">&gt; lis.every(function(x)&#123;return x&gt;2&#125;)</div><div class="line">false</div></pre></td></tr></table></figure></p>
<p>some迭代器会迭代每个元素，直到返回true</p>
<p>forEach会迭代整个数组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; lis.forEach(function(x)&#123;console.log(x)&#125;)</div><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">undefined</div></pre></td></tr></table></figure></p>
<p>map会遍历并返回数组的元素，返回的仍然是数组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; mymap=lis.map(function(x)&#123;return x&#125;)</div><div class="line">[ 1, 2, 3, 4, 5 ]</div><div class="line">&gt; lis=[1,2,3,4,5]</div><div class="line">&gt; lis.some(function(x)&#123;return x&gt;2&#125;)</div><div class="line">true</div><div class="line">&gt; lis.some(function(x)&#123;return x&gt;6&#125;)</div><div class="line">false</div></pre></td></tr></table></figure></p>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>数组排序使用sort方法，排序就相当于比较两个数的值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; lis.sort()</div><div class="line">[ 1, 2, 3, 4, 5 ]</div><div class="line">&gt; lis.sort(function(a,b)&#123;return a-b&#125;)</div><div class="line">[ 1, 2, 3, 4, 5 ]</div><div class="line">&gt; lis.sort(function(a,b)&#123;return b-a&#125;)</div><div class="line">[ 5, 4, 3, 2, 1 ]</div></pre></td></tr></table></figure></p>
<h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p>indexOf方法返回元素的索引值，返回最先找到的那个<br>lastIndexOf返回最后找到的元素的索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; lis[1,1,2,2,3,3,4,5]</div><div class="line">3</div><div class="line">&gt; lis.indexOf(3)</div><div class="line">4</div><div class="line">&gt; lis.lastIndexOf(3)</div><div class="line">5</div></pre></td></tr></table></figure></p>
<h3 id="数组转化为字符串"><a href="#数组转化为字符串" class="headerlink" title="数组转化为字符串"></a>数组转化为字符串</h3><p>toString输出所有元素为字符串<br>join用一个分隔符把元素分开<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; lis</div><div class="line">[ 1, 1, 2, 2, 3, 3, 4, 4, 7, 6, 4, 4 ]</div><div class="line">&gt; lis.toString()</div><div class="line">&apos;1,1,2,2,3,3,4,4,7,6,4,4&apos;</div><div class="line"></div><div class="line">&gt; lis.join(&apos;-&apos;)</div><div class="line">&apos;1-1-2-2-3-3-4-4-7-6-4-4&apos;</div><div class="line">&gt; lis.join(&apos;--&apos;)</div><div class="line">&apos;1--1--2--2--3--3--4--4--7--6--4--4&apos;</div></pre></td></tr></table></figure></p>
<h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><p>创建一个<strong>对象</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var student = Object();</div><div class="line">student.name=&quot;harry&quot;;</div><div class="line">student.year = 100;</div><div class="line">alert(student.name);</div></pre></td></tr></table></figure></p>
<p>或者使用花括号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var student = &#123;</div><div class="line">    name:&quot;harry&quot;,</div><div class="line">    year:100</div><div class="line">&#125;;</div><div class="line">alert(student.name);</div></pre></td></tr></table></figure></p>
<p>对象也可以放在数组中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var student = &#123;</div><div class="line">    name:&quot;harry&quot;,</div><div class="line">    year:100</div><div class="line">&#125;;</div><div class="line">var list = [];</div><div class="line">list[0] = student;</div><div class="line">alert(list[0].name);</div></pre></td></tr></table></figure></p>
<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><p>栈遵循后进先出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">function Stack() </div><div class="line">&#123;</div><div class="line">    var items = [];</div><div class="line">    this.push = function(element)</div><div class="line">    &#123; //添加元素到栈顶</div><div class="line">        items.push(element);</div><div class="line">    &#125;;</div><div class="line">    this.pop = function()</div><div class="line">    &#123; //移除栈顶元素</div><div class="line">        return items.pop();</div><div class="line">    &#125;;</div><div class="line">    this.peek = function()</div><div class="line">    &#123; //返回栈顶元素</div><div class="line">        return items[items.length-1];</div><div class="line">    &#125;;</div><div class="line">    this.isEmpty = function()</div><div class="line">    &#123; //空则返回true</div><div class="line">        return items.length == 0;</div><div class="line">    &#125;;</div><div class="line">    this.size = function()</div><div class="line">    &#123; //返回元素个数</div><div class="line">        return items.length;</div><div class="line">    &#125;;</div><div class="line">    this.clear = function()</div><div class="line">    &#123; //移除所有元素</div><div class="line">        items = [];</div><div class="line">    &#125;;</div><div class="line">    this.print = function()</div><div class="line">    &#123; //打印所有内容</div><div class="line">        console.log(items.toString());</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h2><p>遵循先进先出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">function Queue() </div><div class="line">&#123;</div><div class="line">    var items = [];</div><div class="line">    this.enqueue = function(element)</div><div class="line">    &#123; //队列尾添加元素</div><div class="line">        items.push(element);</div><div class="line">    &#125;;</div><div class="line">    this.dequeue = function()</div><div class="line">    &#123; //队列头移除元素</div><div class="line">        return items.shift();</div><div class="line">    &#125;;</div><div class="line">    this.front = function()</div><div class="line">    &#123; //返回队列头元素</div><div class="line">        return items[0];</div><div class="line">    &#125;;</div><div class="line">    this.isEmpty = function()</div><div class="line">    &#123; //空返回true</div><div class="line">        return items.length == 0;</div><div class="line">    &#125;;</div><div class="line">    this.clear = function()</div><div class="line">    &#123; //清空队列</div><div class="line">        items = [];</div><div class="line">    &#125;;</div><div class="line">    this.size = function()</div><div class="line">    &#123; //返回长度</div><div class="line">        return items.length;</div><div class="line">    &#125;;</div><div class="line">    this.print = function()</div><div class="line">    &#123; //打印队列</div><div class="line">        console.log(items.toString());</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="变量作用域"><a href="#变量作用域" class="headerlink" title="变量作用域"></a>变量作用域</h2><p>如果在使用局部变量时没有声明，有可能会改变全局变量的值，下例最后输出30，全局变量值改变了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">function shout (num)</div><div class="line">&#123;</div><div class="line">    for (var count=0; count&lt;num; count++)</div><div class="line">    &#123;</div><div class="line">        res ++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">var res=20;</div><div class="line">shout(10);</div><div class="line">alert(res);</div></pre></td></tr></table></figure></p>
<p>正确做法是，先声明，下例输出20<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">function shout (num)</div><div class="line">&#123;</div><div class="line">    var res=0</div><div class="line">    for (var count=0; count&lt;num; count++)</div><div class="line">    &#123;</div><div class="line">        res ++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">var res=20;</div><div class="line">shout(10);</div><div class="line">alert(res);</div></pre></td></tr></table></figure></p>
<h2 id="对象-1"><a href="#对象-1" class="headerlink" title="对象"></a>对象</h2><p>对象(Object)是非常重要的数据类型，可以通过两种形式访问对象里的数据：属性(property)和方法(method)</p>
<ul>
<li>属性是隶属于某个特定对象的变量</li>
<li>方法是某个特定对象才能调用的函数</li>
</ul>
<p>在JavaScript中，属性和方法都使用”.”来访问<br>如果对象不存在，会返回undefined<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var a = [&apos;A&apos;, &apos;B&apos;, &apos;C&apos;];</div><div class="line">a.name=&quot;hello&quot;; //和a[&quot;name&quot;]=&quot;hello&quot;含义相同</div></pre></td></tr></table></figure></p>
<p>可以自由地添加删除属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var a = &#123;</div><div class="line">    name:&quot;harry&quot;,</div><div class="line">    second_name:&quot;x&quot;</div><div class="line">&#125;</div><div class="line">delete a.second_name</div><div class="line">alert(a.second_name) //返回undefined</div></pre></td></tr></table></figure></p>
<p>可以为给定对象创建一个新实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var xiaom = new Person;</div></pre></td></tr></table></figure></p>
<p>内建对象<br>数组就是一种内建对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var list = new Array</div><div class="line">list.length //返回数组长度</div></pre></td></tr></table></figure></p>
<p>类似的还有Math和Date对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var num = 7.561</div><div class="line">var num = Math.round(num) //十进制转化为整数</div><div class="line">var current_date = new Date()</div><div class="line">var date = current_date.getDay() //星期几</div></pre></td></tr></table></figure></p>
<h2 id="Map和Set"><a href="#Map和Set" class="headerlink" title="Map和Set"></a>Map和Set</h2><p>Map是一组键值对结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var names = [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;];</div><div class="line">var ages = [10,20,30];</div><div class="line">var m =new Map([[&quot;a&quot;,10], [&quot;b&quot;,20], [&quot;c&quot;,30]]);</div><div class="line">alert(m.get(&quot;a&quot;)); //返回10</div></pre></td></tr></table></figure></p>
<p>添加键值，一个键只能对应一个值，多次赋值会覆盖掉<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">m.set(&quot;d&quot;,40)</div></pre></td></tr></table></figure></p>
<p>Set和Map类似，也是key的集合，但是不存储value，重复的key会被自动过滤<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var s =new Set([1,2,3,4,1,2]);</div><div class="line">&gt;&gt;&gt; s //返回Set [ 1, 2, 3, 4 ]</div></pre></td></tr></table></figure></p>
<p>添加和删除键<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s.add(5)</div><div class="line">s.delete(3) //返回true</div></pre></td></tr></table></figure></p>
<h2 id="iterable"><a href="#iterable" class="headerlink" title="iterable"></a>iterable</h2><p>遍历Array可以采用下标循环，遍历Map和Set就无法使用下标。为了统一集合类型，ES6标准引入了新的iterable类型，Array、Map和Set都属于iterable类型。<br>for…of循环遍历<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">var a = [&apos;A&apos;, &apos;B&apos;, &apos;C&apos;];</div><div class="line">var s = new Set([&apos;A&apos;, &apos;B&apos;, &apos;C&apos;]);</div><div class="line">var m = new Map([[1, &apos;x&apos;], [2, &apos;y&apos;], [3, &apos;z&apos;]]);</div><div class="line">for (var x of a)  // 遍历Array</div><div class="line">&#123;</div><div class="line">    alert(x);</div><div class="line">&#125;</div><div class="line">for (var x of s)  // 遍历Set</div><div class="line">&#123;</div><div class="line">    alert(x);</div><div class="line">&#125;</div><div class="line">for (var x of m)  // 遍历Map</div><div class="line">&#123;</div><div class="line">    alert(x[0] + &apos;:&apos; + x[1]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当给Array添加属性之后，for…in遍历会出问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var a = [&apos;A&apos;, &apos;B&apos;, &apos;C&apos;];</div><div class="line">a.name=&quot;array&quot;;</div><div class="line">for (var x in a)</div><div class="line">&#123;</div><div class="line">    alert(x); //返回0，1，2，name</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>for…of遍历修复了这个问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var a = [&apos;A&apos;, &apos;B&apos;, &apos;C&apos;];</div><div class="line">a.name=&quot;array&quot;;</div><div class="line">for (var x of a)</div><div class="line">&#123;</div><div class="line">    alert(x); //返回A，B，C</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>更好的方式是使用iterable内置的forEach方法，接收一个函数，每次迭代会自动回调该函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var a = [&apos;A&apos;, &apos;B&apos;, &apos;C&apos;];</div><div class="line">a.forEach(function (element, index, array) &#123;</div><div class="line">    // element: 指向当前元素的值</div><div class="line">    // index: 指向当前索引</div><div class="line">    // array: 指向Array对象本身</div><div class="line">    alert(element);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Set没有索引，回调函数的前两个参数都是元素本身，即element的值和index的值相同<br>Map的回调函数参数依次是value、key和map本身</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/26/javascript-01/" data-id="cj5c7k3960017m0u43ggyvyla" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-javascript-00" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/25/javascript-00/" class="article-date">
  <time datetime="2016-04-25T11:54:27.000Z" itemprop="datePublished">2016-04-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/25/javascript-00/">javascript-00 简述</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p>现在开始学习javascript！根据大神的推荐，阅读《JavaScript DOM编程艺术(第2版)一书入门》</p>
<p><a href="http://119.29.137.50/pic" target="_blank" rel="external">测试页面</a></p>
<h1 id="JavaScript简史"><a href="#JavaScript简史" class="headerlink" title="JavaScript简史"></a>JavaScript简史</h1><p>JavaScript是网景公司开发的一门和Java没什么关系的语言，使得网站的内容不再局限于枯燥的文本，交互性得到显著改善，在与微软公司竞争中，网景公司联合ECMA对JavaScript语言进行了标准化，于是出现了ECMAScript，同一个语言的另一个名字。<br>和Java不同，JavaScript是一种脚本语言，<strong>只能通过Web浏览器解释执行</strong>(还有node.js?)，相对的特点是简单。</p>
<h1 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h1><p>DOM(Document Object Model，文档对象模型)是一套对文档的内容进行抽象和概念化的方法。<br>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">document.images[2] #文档中的第三个图像</div><div class="line">document.forms[&apos;details&apos;] #文档中名为details的表单</div></pre></td></tr></table></figure></p>
<h1 id="制定标准"><a href="#制定标准" class="headerlink" title="制定标准"></a>制定标准</h1><p>应为微软和网景浏览器之间的冲突，程序员在编写DOM脚本时必须直到要运行在哪种浏览器，令人痛苦难堪。<br>W3C结合大家的优点推出了一个标准化DOM，可以让<strong>任何一种程序设计语言</strong>对<strong>任何一种标记语言</strong>编写出来的<strong>任何一份文档</strong>进行操控。</p>
<p>DOM是一种API，一个与系统平台和编程语言无关的接口，不同的浏览器通过不同的方式完成相同的任务。</p>
<p>苹果公司2003年发布Safari基于WebKit，WebKit是一个开源Web浏览器引擎。</p>
<p>DOM把HTML/SHTML、CSS和JavaScript凝聚在一起</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/25/javascript-00/" data-id="cj5c7k39l001im0u4x95hbofn" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-0e" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/24/myblog-0e/" class="article-date">
  <time datetime="2016-04-24T06:49:56.000Z" itemprop="datePublished">2016-04-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/24/myblog-0e/">myblog-0e 部署</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h2><p>文件：<strong>manage.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@manager.command</div><div class="line">def deploy():</div><div class="line">    &quot;&quot;&quot;Run deployment tasks.&quot;&quot;&quot;</div><div class="line">    from flask.ext.migrate import upgrade</div><div class="line">    from app.models import Role, User</div><div class="line"></div><div class="line">    # 数据库迁移更新</div><div class="line">    upgrade()</div><div class="line"></div><div class="line">    # 创建角色</div><div class="line">    Role.insert_roles()</div><div class="line"></div><div class="line">    # 自我关注</div><div class="line">    User.add_self_follows()</div></pre></td></tr></table></figure></p>
<p>运行deploy更新<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ python manage.py deploy</div></pre></td></tr></table></figure></p>
<h2 id="把生产环境中的错误写入日志"><a href="#把生产环境中的错误写入日志" class="headerlink" title="把生产环境中的错误写入日志"></a>把生产环境中的错误写入日志</h2><p>出错时发送电子邮件<br>文件：<strong>config.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">class ProductionConfig(Config):</div><div class="line">    SQLALCHEMY_DATABASE_URI =&apos;mysql://flask:admin@localhost/flaskdb&apos;</div><div class="line"></div><div class="line">    @classmethod</div><div class="line">    def init_app(cls, app):</div><div class="line">        Config.init_app(app)</div><div class="line"></div><div class="line">        # email errors to the administrators</div><div class="line">        import logging</div><div class="line">        from logging.handlers import SMTPHandler</div><div class="line">        credentials = None</div><div class="line">        secure = None</div><div class="line">        if getattr(cls, &apos;MAIL_USERNAME&apos;, None) is not None:</div><div class="line">            credentials = (cls.MAIL_USERNAME, cls.MAIL_PASSWORD)</div><div class="line">            if getattr(cls, &apos;MAIL_USE_TLS&apos;, None):</div><div class="line">                secure = ()</div><div class="line">        mail_handler = SMTPHandler(</div><div class="line">            mailhost=(cls.MAIL_SERVER, cls.MAIL_PORT),</div><div class="line">            fromaddr=cls.FLASKY_MAIL_SENDER,</div><div class="line">            toaddrs=[cls.FLASKY_ADMIN],</div><div class="line">            subject=cls.FLASKY_MAIL_SUBJECT_PREFIX + &apos; Application Error&apos;,</div><div class="line">            credentials=credentials,</div><div class="line">            secure=secure)</div><div class="line">        mail_handler.setLevel(logging.ERROR)</div><div class="line">        app.logger.addHandler(mail_handler)</div></pre></td></tr></table></figure></p>
<h2 id="Gunicorn"><a href="#Gunicorn" class="headerlink" title="Gunicorn"></a>Gunicorn</h2><p>Gunicorn是一个给Unix用的WSGI HTTP服务器<br>运行一个Flask应用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ gunicorn manage:app</div></pre></td></tr></table></figure></p>
<p>用4个worker进程运行一个flask应用，绑定到localhost的4000端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ gunicorn -w 4 -b 127.0.0.1:4000 manage:app</div></pre></td></tr></table></figure></p>
<h2 id="使用Flask-SSLify启用安全HTTP"><a href="#使用Flask-SSLify启用安全HTTP" class="headerlink" title="使用Flask-SSLify启用安全HTTP"></a>使用Flask-SSLify启用安全HTTP</h2><p>文件：app/<strong>init</strong>.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">def create_app(config_name):</div><div class="line"></div><div class="line">    #...</div><div class="line">    if not app.debug and not app.testing and not app.config[&apos;SSL_DISABLE&apos;]:</div><div class="line">        from flask.ext.sslify import SSLify</div><div class="line">        sslify = SSLify(app)</div></pre></td></tr></table></figure></p>
<h1 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h1><p>后台运行，记录日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">python manage.py runserver &gt;&gt; flask.log 2&gt;&amp;1 &amp;</div><div class="line">python manage.py runserver &amp;&gt;&gt;flask.log</div></pre></td></tr></table></figure></p>
<h1 id="语言问题"><a href="#语言问题" class="headerlink" title="语言问题"></a>语言问题</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apt-get install localepurge //选择en_US.UTF-8 和 zh_CN.UTF-8</div><div class="line">locale-gen zh_CN.UTF-8 en_US.UTF-8 //生成语言</div><div class="line">locale //打印配置</div></pre></td></tr></table></figure>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">apt-get install python-virtualenv</div><div class="line">apt-get install python-pip</div><div class="line">source venv/bin/activate</div><div class="line">pip install -r requirements/common.txt</div></pre></td></tr></table></figure>
<h1 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">apt-get install mysql-server</div><div class="line">apt-get install python-setuptools</div><div class="line">apt-get install libmysqld-dev</div><div class="line">apt-get install libmysqlclient-dev</div><div class="line">apt-get install python-dev</div><div class="line">easy_install mysql-python</div></pre></td></tr></table></figure>
<p>创建新用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql -u root -p //登录</div><div class="line">use mysql</div><div class="line">create user &quot;flask&quot;@&quot;localhost&quot; identified by &quot;admin&quot;</div><div class="line">flush privileges  //刷新</div><div class="line">create database flaskdb //创建数据库</div><div class="line">grant all privileges on flaskdb.* to flask@localhost identified  by &apos;admin&apos; //赋予权限</div><div class="line">flush privileges</div></pre></td></tr></table></figure></p>
<h1 id="终语"><a href="#终语" class="headerlink" title="终语"></a>终语</h1><p>至此，当初搭建博客的目标基本达成<br>后面是更基础的学习</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/24/myblog-0e/" data-id="cj5c7k42a003tm0u4d9g4j7s2" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-0d" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/23/myblog-0d/" class="article-date">
  <time datetime="2016-04-23T09:00:37.000Z" itemprop="datePublished">2016-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/23/myblog-0d/">myblog-0d API</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="应用编程接口"><a href="#应用编程接口" class="headerlink" title="应用编程接口"></a>应用编程接口</h1><p>业务逻辑越来越多的移动到了客户端一侧，开创出一种称为RIA(富互联网应用 Rich Internet Application)的架构，服务器主要功能是提供数据存取服务。<br>在这种模式下，服务器变成了Web服务或者应用编程接口(API Application Programming Interface)。</p>
<h2 id="REST简介"><a href="#REST简介" class="headerlink" title="REST简介"></a>REST简介</h2><p>REST(表现层状态转移, Representational State Transfer)架构特征</p>
<ul>
<li>客户端-服务器<br>客户端和服务器之间必须有明确的界线。</li>
<li>无状态<br>客户端发出的请求中必须包含所有必要的信息。服务器不能在两次请求之间保存客户端的任何状态。</li>
<li>缓存<br>服务器发出的响应可以标记为可缓存或不可缓存,这样出于优化目的,客户端(或客户端和服务器之间的中间服务)可以使用缓存。</li>
<li>接口统一<br>客户端访问服务器资源时使用的协议必须一致,定义良好,且已经标准化。REST Web服务最常使用的统一接口是 HTTP 协议。</li>
<li>系统分层<br>在客户端和服务器之间可以按需插入代理服务器、缓存或网关,以提高性能、稳定性和伸缩性。</li>
<li>按需代码<br>客户端可以选择从服务器上下载代码,在客户端的环境中执行。<h2 id="使用flask提供REST-Web服务"><a href="#使用flask提供REST-Web服务" class="headerlink" title="使用flask提供REST Web服务"></a>使用flask提供REST Web服务</h2><h3 id="API蓝本结构"><a href="#API蓝本结构" class="headerlink" title="API蓝本结构"></a>API蓝本结构</h3>API包的名字中有一个版本号，如果需要向前兼容，需要添加一个版本号的不同的包<br>在API蓝本中，各资源在不同模块实现<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">|-myblog</div><div class="line">    |-app/</div><div class="line">        |-api_1_0</div><div class="line">            |-__init__.py</div><div class="line">            |-users.py</div><div class="line">            |-posts.py</div><div class="line">            |-comments.py</div><div class="line">            |-authentication.py</div><div class="line">            |-errors.py</div><div class="line">            |-decorators.py</div></pre></td></tr></table></figure>
</li>
</ul>
<p>API蓝本构造文件<br>文件：<strong>app/api_1_0/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from flask import Blueprint</div><div class="line"></div><div class="line">api = Blueprint(&apos;api&apos;, __name__)</div><div class="line"></div><div class="line">from . import authentication, posts, users, comments, errors</div></pre></td></tr></table></figure></p>
<p>注册API蓝本<br>文件：<strong>app/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">def create_app(config_name):</div><div class="line">    #...</div><div class="line">    from .api_1_0 import api as api_1_0_blueprint</div><div class="line">    app.register_blueprint(api_1_0_blueprint, url_prefix=&apos;/api/v1.0&apos;)</div><div class="line">    #...</div></pre></td></tr></table></figure></p>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>在错误处理程序中根据客户端请求的格式改写响应，这种技术称为<strong>内容协商</strong><br>它向Web服务端发送JSON格式响应<br>文件：<strong>app/main/errors.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">from flask import render_template, request, jsonify</div><div class="line"></div><div class="line">from . import main</div><div class="line"></div><div class="line">@main.app_errorhandler(404)</div><div class="line">def page_not_found(e):</div><div class="line">    if request.accept_mimetypes.accept_json and \</div><div class="line">            not request.accept_mimetypes.accept_html:</div><div class="line">        response = jsonify(&#123;&apos;error&apos;: &apos;not found&apos;&#125;)</div><div class="line">        response.status_code = 404</div><div class="line">        return response</div><div class="line">    return render_template(&apos;404.html&apos;), 404</div><div class="line"></div><div class="line">@main.app_errorhandler(403)</div><div class="line">def forbidden(e):</div><div class="line">    if request.accept_mimetypes.accept_json and \</div><div class="line">            not request.accept_mimetypes.accept_html:</div><div class="line">        response = jsonify(&#123;&apos;error&apos;: &apos;forbidden&apos;&#125;)</div><div class="line">        response.status_code = 403</div><div class="line">        return response</div><div class="line">    return render_template(&apos;403.html&apos;), 403</div><div class="line"></div><div class="line">@main.app_errorhandler(500)</div><div class="line">def internal_server_error(e):</div><div class="line">    if request.accept_mimetypes.accept_json and \</div><div class="line">            not request.accept_mimetypes.accept_html:</div><div class="line">        response = jsonify(&#123;&apos;error&apos;: &apos;internal server error&apos;&#125;)</div><div class="line">        response.status_code = 500</div><div class="line">        return response</div><div class="line">    return render_template(&apos;500.html&apos;), 500</div></pre></td></tr></table></figure></p>
<p>API蓝本中错误处理程序，Web服务的视图函数可以调用这些辅助函数生成错误响应<br>文件：<strong>app/api_1_0/errors.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">from flask import jsonify</div><div class="line"></div><div class="line">def bad_request(message):</div><div class="line">    response = jsonify(&#123;&apos;error&apos;: &apos;bad request&apos;, &apos;message&apos;: message&#125;)</div><div class="line">    response.status_code = 400</div><div class="line">    return response</div><div class="line"></div><div class="line">def unauthorized(message):</div><div class="line">    response = jsonify(&#123;&apos;error&apos;: &apos;unauthorized&apos;, &apos;message&apos;: message&#125;)</div><div class="line">    response.status_code = 401</div><div class="line">    return response</div><div class="line"></div><div class="line">def forbidden(message):</div><div class="line">    response = jsonify(&#123;&apos;error&apos;: &apos;forbidden&apos;, &apos;message&apos;: message&#125;)</div><div class="line">    response.status_code = 403</div><div class="line">    return response</div></pre></td></tr></table></figure></p>
<h3 id="使用-Flask-HTTPAuth-认证用户"><a href="#使用-Flask-HTTPAuth-认证用户" class="headerlink" title="使用 Flask-HTTPAuth 认证用户"></a>使用 Flask-HTTPAuth 认证用户</h3><p>Web浏览器外的客户端很难提供对cookie的支持<br>因为REST架构基于HTTP协议，所以发送密令的最佳方式是使用HTTP认证<br>在HTTP认证中，用户密令包含在请求的Authorization首部中<br>Flask-HTTPAuth扩展提供了一个便利的包装，可以把协议的细节隐藏在修饰器之中<br>类似于Flask-Login提供的login_required修饰器<br>因为这种用户认证方法只在API蓝本中使用，所以Flask-HTTPAuth扩展只在蓝本包中初始化<br>验证回调函数把通过认证的用户保存在Flask的全局对象g中<br>文件：<strong>app/api_1_0/authentication.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">from flask.ext.httpauth import HTTPBasicAuth</div><div class="line">from flask import g, jsonify</div><div class="line"></div><div class="line">from ..models import User, AnonymousUser</div><div class="line">from . import api</div><div class="line"></div><div class="line">auth = HTTPBasicAuth()</div><div class="line"></div><div class="line">@auth.verify_password</div><div class="line">def verify_password(email, password):</div><div class="line">    if email == &apos;&apos;: #匿名登录</div><div class="line">        g.current_user = AnonymousUser()</div><div class="line">        return True</div><div class="line">    user = User.query.filter_by(email=email_or_token).first()</div><div class="line">    if not user:</div><div class="line">        return False</div><div class="line">    g.current_user = user</div><div class="line">    return user.verify_password(password)</div></pre></td></tr></table></figure></p>
<p>如果认证密令不正确，服务器向客户端返回401错误，默认情况下，Flask-HTTPAuth自动生成这个状态码<br>为了和API返回的其他错误保持一致，可以自定义这个错误响应<br>由于这个蓝本的所有路由都要使用相同方式进行保护，可以在before_request处理程序中使用一次login_required修饰器，应用到整个蓝本<br>文件：<strong>app/api_1_0/authentication.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">from .errors import unauthorized, forbidden</div><div class="line"></div><div class="line">@auth.error_handler</div><div class="line">def auth_error():</div><div class="line">    return unauthorized(&apos;Invalid credentials&apos;)</div><div class="line"></div><div class="line">@api.before_request</div><div class="line">@auth.login_required</div><div class="line">def before_request():</div><div class="line">    if not g.current_user.is_anonymous and \</div><div class="line">            not g.current_user.confirmed:</div><div class="line">        return forbidden(&apos;Unconfirmed account&apos;)</div></pre></td></tr></table></figure></p>
<h3 id="基于令牌的认证"><a href="#基于令牌的认证" class="headerlink" title="基于令牌的认证"></a>基于令牌的认证</h3><p>客户端首先把登录密令发送给一个特殊的URL，从而生成认证令牌<br>一旦用户获得令牌，就可用令牌代替登录密令的认证请求，处于安全考虑，令牌有过期时间<br>User模型添加新方法，generate_auth_token()使用编码后的用户id字段值生成一个签名令牌，还指定了以秒为单位的过期时间<br>verify_auth_token()接收参数是一个令牌，如果令牌可用就返回对应的用户<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):</div><div class="line">    #....</div><div class="line">    def generate_auth_token(self, expiration):</div><div class="line">        s = Serializer(current_app.config[&apos;SECRET_KEY&apos;],</div><div class="line">                       expires_in=expiration)</div><div class="line">        return s.dumps(&#123;&apos;id&apos;: self.id&#125;).decode(&apos;ascii&apos;)</div><div class="line"></div><div class="line">    @staticmethod</div><div class="line">    def verify_auth_token(token):</div><div class="line">        s = Serializer(current_app.config[&apos;SECRET_KEY&apos;])</div><div class="line">        try:</div><div class="line">            data = s.loads(token)</div><div class="line">        except:</div><div class="line">            return None</div><div class="line">        return User.query.get(data[&apos;id&apos;])</div></pre></td></tr></table></figure></p>
<p>更改回调函数，支持令牌<br>文件：<strong>app/api_1_0/authentication.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@auth.verify_password</div><div class="line">def verify_password(email_or_token, password):</div><div class="line">    if email_or_token == &apos;&apos;:</div><div class="line">        g.current_user = AnonymousUser()</div><div class="line">        return True</div><div class="line">    if password == &apos;&apos;:</div><div class="line">        g.current_user = User.verify_auth_token(email_or_token)</div><div class="line">        g.token_used = True</div><div class="line">        return g.current_user is not None</div><div class="line">    user = User.query.filter_by(email=email_or_token).first()</div><div class="line">    if not user:</div><div class="line">        return False</div><div class="line">    g.current_user = user</div><div class="line">    g.token_used = False</div><div class="line">    return user.verify_password(password)</div></pre></td></tr></table></figure></p>
<p>生成认证令牌，为了避免客户端使用旧令牌申请新令牌,要在视图函数中检查 g.token_used 变量的值,如果使用令牌进行认证就拒绝请求。<br>这个视图函数返回 JSON 格式的响应,其中包含了过期时间为 1 小时的令牌。JSON 格式的响应也包含过期时间。<br>文件：<strong>app/api_1_0/authentication.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/token&apos;)</div><div class="line">def get_token():</div><div class="line">    if g.current_user.is_anonymous or g.token_used:</div><div class="line">        return unauthorized(&apos;Invalid credentials&apos;)</div><div class="line">    return jsonify(&#123;&apos;token&apos;: g.current_user.generate_auth_token(</div><div class="line">        expiration=3600), &apos;expiration&apos;: 3600&#125;)</div></pre></td></tr></table></figure></p>
<h3 id="资源和JSON的序列化转换"><a href="#资源和JSON的序列化转换" class="headerlink" title="资源和JSON的序列化转换"></a>资源和JSON的序列化转换</h3><p>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):</div><div class="line">    #...</div><div class="line">    def to_json(self):</div><div class="line">        json_user = &#123;</div><div class="line">            &apos;url&apos;: url_for(&apos;api.get_post&apos;, id=self.id, _external=True),</div><div class="line">            &apos;name&apos;: self.name,</div><div class="line">            &apos;member_since&apos;: self.member_since,</div><div class="line">            &apos;last_seen&apos;: self.last_seen,</div><div class="line">            &apos;posts&apos;: url_for(&apos;api.get_user_posts&apos;, id=self.id, _external=True),</div><div class="line">            &apos;followed_posts&apos;: url_for(&apos;api.get_user_followed_posts&apos;,</div><div class="line">                                      id=self.id, _external=True),</div><div class="line">            &apos;post_count&apos;: self.posts.count()</div><div class="line">        &#125;</div><div class="line">        return json_user</div><div class="line"></div><div class="line">class Post(db.Model):</div><div class="line">    #...</div><div class="line">    def to_json(self):</div><div class="line">        json_post = &#123;</div><div class="line">            &apos;url&apos;: url_for(&apos;api.get_post&apos;, id=self.id, _external=True),</div><div class="line">            &apos;body&apos;: self.body,</div><div class="line">            &apos;body_html&apos;: self.body_html,</div><div class="line">            &apos;timestamp&apos;: self.timestamp,</div><div class="line">            &apos;author&apos;: url_for(&apos;api.get_user&apos;, id=self.author_id,</div><div class="line">                              _external=True),</div><div class="line">            &apos;comments&apos;: url_for(&apos;api.get_post_comments&apos;, id=self.id,</div><div class="line">                                _external=True),</div><div class="line">            &apos;comment_count&apos;: self.comments.count()</div><div class="line">        &#125;</div><div class="line">        return json_post</div></pre></td></tr></table></figure></p>
<p>从JSON格式数据创建一篇博客文章<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class Post(db.Model):</div><div class="line">    #...</div><div class="line">    @staticmethod</div><div class="line">    def from_json(json_post):</div><div class="line">        body = json_post.get(&apos;body&apos;)</div><div class="line">        if body is None or body == &apos;&apos;:</div><div class="line">            raise ValidationError(&apos;post does not have a body&apos;)</div><div class="line">        return Post(body=body)</div></pre></td></tr></table></figure></p>
<p>文件：<strong>app/exceptions.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">class ValidationError(ValueError):</div><div class="line">    pass</div></pre></td></tr></table></figure></p>
<p>创建一个全局异常处理程序<br>文件：<strong>app/api_1_0/errors.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@api.errorhandler(ValidationError)</div><div class="line">def validation_error(e):</div><div class="line">    return bad_request(e.args[0])</div></pre></td></tr></table></figure></p>
<p>第一个路由处理获取文章集合的请求<br>第二个路由返回单个博客文章<br>文件：<strong>app/api_1_0/posts.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/posts/&apos;)</div><div class="line">@auth.login_required</div><div class="line">def get_posts():</div><div class="line">    posts = Post.query.all()</div><div class="line">    return jsonify(&#123; &apos;posts&apos;: [post.to_json() for post in posts] &#125;)</div><div class="line"></div><div class="line">@api.route(&apos;/posts/&lt;int:id&gt;&apos;)</div><div class="line">def get_post(id):</div><div class="line">    post = Post.query.get_or_404(id)</div><div class="line">    return jsonify(post.to_json())</div></pre></td></tr></table></figure></p>
<p>POST请求处理程序把一篇新博客文章插入数据库<br>文件：<strong>app/api_1_0/posts.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/posts/&apos;, methods=[&apos;POST&apos;])</div><div class="line">@permission_required(Permission.WRITE_ARTICLES)</div><div class="line">def new_post():</div><div class="line">    post = Post.from_json(request.json)</div><div class="line">    post.author = g.current_user</div><div class="line">    db.session.add(post)</div><div class="line">    db.session.commit()</div><div class="line">    return jsonify(post.to_json()), 201, \</div><div class="line">        &#123;&apos;Location&apos;: url_for(&apos;api.get_post&apos;, id=post.id, _external=True)&#125;</div></pre></td></tr></table></figure></p>
<p>permission_required修饰器和程序中使用的类似，但会针对API蓝本进行自定义<br>文件：<strong>app/api_1_0/decorators.oy</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">from functools import wraps</div><div class="line">from flask import g</div><div class="line"></div><div class="line">from .errors import forbidden</div><div class="line"></div><div class="line">def permission_required(permission):</div><div class="line">    def decorator(f):</div><div class="line">        @wraps(f)</div><div class="line">        def decorated_function(*args, **kwargs):</div><div class="line">            if not g.current_user.can(permission):</div><div class="line">                return forbidden(&apos;Insufficient permissions&apos;)</div><div class="line">            return f(*args, **kwargs)</div><div class="line">        return decorated_function</div><div class="line">    return decorator</div></pre></td></tr></table></figure></p>
<p>PUT请求处理程序，修饰器用来检查用户是否有写博客文章的权限<br>文件：<strong>app/api_1_0/posts.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/posts/&lt;int:id&gt;&apos;, methods=[&apos;PUT&apos;])</div><div class="line">@permission_required(Permission.WRITE_ARTICLES)</div><div class="line">def edit_post(id):</div><div class="line">    post = Post.query.get_or_404(id)</div><div class="line">    if g.current_user != post.author and \</div><div class="line">            not g.current_user.can(Permission.ADMINISTER):</div><div class="line">        return forbidden(&apos;Insufficient permissions&apos;)</div><div class="line">    post.body = request.json.get(&apos;body&apos;, post.body)</div><div class="line">    db.session.add(post)</div><div class="line">    return jsonify(post.to_json())</div></pre></td></tr></table></figure></p>
<p>API资源</p>
<table>
<thead>
<tr>
<th>/users/<int:id></int:id></th>
<th>GET</th>
<th>一个用户</th>
</tr>
</thead>
<tbody>
<tr>
<td>/users/<int:id>/posts/</int:id></td>
<td>GET</td>
<td>一个用户发布的博客文章</td>
</tr>
<tr>
<td>/users/<int:id>/timeline/</int:id></td>
<td>GET</td>
<td>一个用户所关注用户发布的文章</td>
</tr>
<tr>
<td>/posts/</td>
<td>GET 、POST</td>
<td>所有博客文章</td>
</tr>
<tr>
<td>/posts/<int:id></int:id></td>
<td>GET 、PUT</td>
<td>一篇博客文章</td>
</tr>
<tr>
<td>/posts/<int:id>comments/</int:id></td>
<td>GET 、POST</td>
<td>一篇博客文章中的评论</td>
</tr>
<tr>
<td>/comments/</td>
<td>GET</td>
<td>所有评论</td>
</tr>
<tr>
<td>/comments/<int:id></int:id></td>
<td>GET</td>
<td>一篇评论</td>
</tr>
</tbody>
</table>
<h3 id="分页大型资源集合"><a href="#分页大型资源集合" class="headerlink" title="分页大型资源集合"></a>分页大型资源集合</h3><p>分页文章资源，JSON格式响应中的posts字段依旧包含各篇文章，但这只是完整集合的一部分<br>文件：<strong>app/api_1_0/posts.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">@api.route(&apos;/posts/&apos;)</div><div class="line">def get_posts():</div><div class="line">    page = request.args.get(&apos;page&apos;, 1, type=int)</div><div class="line">    pagination = Post.query.paginate(</div><div class="line">        page, per_page=current_app.config[&apos;FLASKY_POSTS_PER_PAGE&apos;],</div><div class="line">        error_out=False)</div><div class="line">    posts = pagination.items</div><div class="line">    prev = None</div><div class="line">    if pagination.has_prev:</div><div class="line">        prev = url_for(&apos;api.get_posts&apos;, page=page-1, _external=True)</div><div class="line">    next = None</div><div class="line">    if pagination.has_next:</div><div class="line">        next = url_for(&apos;api.get_posts&apos;, page=page+1, _external=True)</div><div class="line">    return jsonify(&#123;</div><div class="line">        &apos;posts&apos;: [post.to_json() for post in posts],</div><div class="line">        &apos;prev&apos;: prev,</div><div class="line">        &apos;next&apos;: next,</div><div class="line">        &apos;count&apos;: pagination.total</div><div class="line">    &#125;)</div></pre></td></tr></table></figure></p>
<h3 id="使用HTTPie测试Web服务"><a href="#使用HTTPie测试Web服务" class="headerlink" title="使用HTTPie测试Web服务"></a>使用HTTPie测试Web服务</h3><p>用户登录发送GET请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth &lt;email&gt;:&lt;password&gt; GET http://localhost:5000/api/v1.0/posts/</div></pre></td></tr></table></figure></p>
<p>匿名用户发送GET请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth  :  GET http://localhost:5000/api/v1.0/posts/</div></pre></td></tr></table></figure></p>
<p>使用POST请求添加一篇新文章<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth harryx520@qq.com:admin POST http://localhost:5000/api/v1.0/posts/ &quot;body=lalala,post from json&quot;</div></pre></td></tr></table></figure></p>
<p>如果要使用认证令牌，可向/api/v1.0/token发送请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth &lt;email&gt;:&lt;password&gt; http://localhost:5000/api/v1.0/token</div></pre></td></tr></table></figure></p>
<p>在有效时间内，这里是一小时，这个令牌可用于访问API<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ http --json --auth eyJhbG...:  GET http://localhost:5000/api/v1.0/posts/</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/23/myblog-0d/" data-id="cj5c7k42d003ym0u4qxfmq0ty" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-0c" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/23/myblog-0c/" class="article-date">
  <time datetime="2016-04-23T07:04:00.000Z" itemprop="datePublished">2016-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/23/myblog-0c/">myblog-0c 评论</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="评论"><a href="#评论" class="headerlink" title="评论"></a>评论</h1><h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><h3 id="数据库关系"><a href="#数据库关系" class="headerlink" title="数据库关系"></a>数据库关系</h3><p>文章posts到评论comments是一对多的关系，一个文章有多个评论<br>用户users到评论comments是一对多关系，一个用户有多个评论</p>
<h3 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h3><p>添加一个评论模型，和文章模型相比多了一个disabled字段，用于管理员查禁不当言论<br>对Markdown的审核更加严格，删除与段落相关的标签<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">class Comment(db.Model):</div><div class="line">    __tablename__ = &apos;comments&apos;</div><div class="line">    id = db.Column(db.Integer, primary_key=True)</div><div class="line">    body = db.Column(db.Text)</div><div class="line">    body_html = db.Column(db.Text)</div><div class="line">    timestamp = db.Column(db.DateTime, index=True, default=datetime.utcnow)</div><div class="line">    disabled = db.Column(db.Boolean)</div><div class="line">    author_id = db.Column(db.Integer, db.ForeignKey(&apos;users.id&apos;))</div><div class="line">    post_id = db.Column(db.Integer, db.ForeignKey(&apos;posts.id&apos;))</div><div class="line"></div><div class="line">    @staticmethod</div><div class="line">    def on_changed_body(target, value, oldvalue, initiator):</div><div class="line">        allowed_tags = [&apos;a&apos;, &apos;abbr&apos;, &apos;acronym&apos;, &apos;b&apos;, &apos;code&apos;, &apos;em&apos;, &apos;i&apos;,</div><div class="line">                        &apos;strong&apos;]</div><div class="line">        target.body_html = bleach.linkify(bleach.clean(</div><div class="line">            markdown(value, output_format=&apos;html&apos;),</div><div class="line">            tags=allowed_tags, strip=True))</div><div class="line"></div><div class="line">db.event.listen(Comment.body, &apos;set&apos;, Comment.on_changed_body)</div><div class="line"></div><div class="line">class User(db.Model):</div><div class="line">    # ...</div><div class="line">    comments = db.relationship(&apos;Comment&apos;, backref=&apos;author&apos;, lazy=&apos;dynamic&apos;)</div><div class="line"></div><div class="line">class Post(db.Model):</div><div class="line">    # ...</div><div class="line">    comments = db.relationship(&apos;Comment&apos;, backref=&apos;post&apos;, lazy=&apos;dynamic&apos;)</div></pre></td></tr></table></figure></p>
<h2 id="提交和显示评论"><a href="#提交和显示评论" class="headerlink" title="提交和显示评论"></a>提交和显示评论</h2><h3 id="提交评论"><a href="#提交评论" class="headerlink" title="提交评论"></a>提交评论</h3><p>创建一个表单<br>文件：<strong>app/main/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">class CommentForm(Form):</div><div class="line">    body = StringField(&apos;评论&apos;, validators=[Required()])</div><div class="line">    submit = SubmitField(&apos;提交&apos;)</div></pre></td></tr></table></figure></p>
<p>视图函数支持评论，和post视图函数相同，要使用current_user._get_current_object()获取用户对象<br>按照时间戳排序，新评论显示在底部<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/post/&lt;int:id&gt;&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def post(id):</div><div class="line">    post = Post.query.get_or_404(id)</div><div class="line">    form = CommentForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        comment = Comment(body=form.body.data,</div><div class="line">                          post=post,</div><div class="line">                          author=current_user._get_current_object())</div><div class="line">        db.session.add(comment)</div><div class="line">        flash(&apos;评论成功&apos;)</div><div class="line">        return redirect(url_for(&apos;.post&apos;, id=post.id, page=-1))</div><div class="line">    page = request.args.get(&apos;page&apos;, 1, type=int)</div><div class="line">    if page == -1:</div><div class="line">        page = (post.comments.count() - 1) // \</div><div class="line">            current_app.config[&apos;FLASKY_COMMENTS_PER_PAGE&apos;] + 1</div><div class="line">    pagination = post.comments.order_by(Comment.timestamp.asc()).paginate(</div><div class="line">        page, per_page=current_app.config[&apos;FLASKY_COMMENTS_PER_PAGE&apos;],</div><div class="line">        error_out=False)</div><div class="line">    comments = pagination.items</div><div class="line">    return render_template(&apos;post.html&apos;, posts=[post], form=form,</div><div class="line">                           comments=comments, pagination=pagination)</div></pre></td></tr></table></figure></p>
<h3 id="显示评论"><a href="#显示评论" class="headerlink" title="显示评论"></a>显示评论</h3><p>渲染过程和_posts.html类似<br>文件：<strong>app/templates/_comments.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;ul class=&quot;comments&quot;&gt;</div><div class="line">    &#123;% for comment in comments %&#125;</div><div class="line">    &lt;li class=&quot;comment&quot;&gt;</div><div class="line">        &lt;div class=&quot;comment-thumbnail&quot;&gt;</div><div class="line">            &lt;a href=&quot;&#123;&#123; url_for(&apos;.user&apos;, name=comment.author.name) &#125;&#125;&quot;&gt;</div><div class="line">                &lt;img class=&quot;img-rounded profile-thumbnail&quot; src=&quot;&#123;&#123; comment.author.avatar&#125;&#125;&quot; width=&quot;40px&quot; height=&quot;40px&quot;&gt;</div><div class="line">            &lt;/a&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;comment-content&quot;&gt;</div><div class="line">            &lt;div class=&quot;comment-date&quot;&gt;&#123;&#123; moment(comment.timestamp).fromNow() &#125;&#125;&lt;/div&gt;</div><div class="line">            &lt;div class=&quot;comment-author&quot;&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;.user&apos;, name=comment.author.name) &#125;&#125;&quot;&gt;&#123;&#123; comment.author.name &#125;&#125;&lt;/a&gt;&lt;/div&gt;</div><div class="line">            &lt;div class=&quot;comment-body&quot;&gt;</div><div class="line">                &#123;% if comment.body_html %&#125;</div><div class="line">                    &#123;&#123; comment.body_html | safe &#125;&#125;</div><div class="line">                &#123;% else %&#125;</div><div class="line">                    &#123;&#123; comment.body &#125;&#125;</div><div class="line">                &#123;% endif %&#125;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure></p>
<h3 id="在博客文章添加评论链接"><a href="#在博客文章添加评论链接" class="headerlink" title="在博客文章添加评论链接"></a>在博客文章添加评论链接</h3><p>#comments链接到评论顶部<br>文件：<strong>app/templates/_posts.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;a href=&quot;&#123;&#123; url_for(&apos;.post&apos;, id=post.id) &#125;&#125;#comments&quot;&gt;</div><div class="line">    &lt;span class=&quot;label label-primary&quot;&gt;&#123;&#123; post.comments.count() &#125;&#125; 评论&lt;/span&gt;</div><div class="line">&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<p>文件：<strong>app/templates/post.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line">&#123;% import &quot;_macros.html&quot; as macros %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Post&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&#123;% include &apos;_posts.html&apos; %&#125;</div><div class="line">&lt;h4 id=&quot;comments&quot;&gt;评论&lt;/h4&gt;</div><div class="line">&#123;% if current_user.can(Permission.COMMENT) %&#125;</div><div class="line">&lt;div class=&quot;comment-form&quot;&gt;</div><div class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endif %&#125;</div><div class="line">&#123;% include &apos;_comments.html&apos; %&#125;</div><div class="line">&#123;% if pagination %&#125;</div><div class="line">&lt;div class=&quot;pagination&quot;&gt;</div><div class="line">    &#123;&#123; macros.pagination_widget(pagination, &apos;.post&apos;, fragment=&apos;#comments&apos;, id=posts[0].id) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endif %&#125;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h2 id="管理评论"><a href="#管理评论" class="headerlink" title="管理评论"></a>管理评论</h2><h3 id="管理评论的链接"><a href="#管理评论的链接" class="headerlink" title="管理评论的链接"></a>管理评论的链接</h3><p>在导航条添加管理评论的链接<br>文件：<strong>app/templates/base.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;% if current_user.can(Permission.MODERATE_COMMENTS) %&#125;</div><div class="line">&lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;main.moderate&apos;) &#125;&#125;&quot;&gt;管理评论&lt;/a&gt;&lt;/li&gt;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure></p>
<h3 id="管理评论的路由"><a href="#管理评论的路由" class="headerlink" title="管理评论的路由"></a>管理评论的路由</h3><p>最近发布的评论会显示在最前面，每篇评论下都会有一个按钮，用来切换disabled的值<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/moderate&apos;)</div><div class="line">@login_required</div><div class="line">@permission_required(Permission.MODERATE_COMMENTS)</div><div class="line">def moderate():</div><div class="line">    page = request.args.get(&apos;page&apos;, 1, type=int)</div><div class="line">    pagination = Comment.query.order_by(Comment.timestamp.desc()).paginate(</div><div class="line">        page, per_page=current_app.config[&apos;FLASKY_COMMENTS_PER_PAGE&apos;],</div><div class="line">        error_out=False)</div><div class="line">    comments = pagination.items</div><div class="line">    return render_template(&apos;moderate.html&apos;, comments=comments,</div><div class="line">                           pagination=pagination, page=page)</div></pre></td></tr></table></figure></p>
<h3 id="渲染页面"><a href="#渲染页面" class="headerlink" title="渲染页面"></a>渲染页面</h3><p>将渲染工作交给_comments.html之前，设置moderate的值<br>文件：<strong>app/templates/moderate.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;_macros.html&quot; as macros %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;管理评论&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Comment Moderation&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% set moderate = True %&#125;</div><div class="line">&#123;% include &apos;_comments.html&apos; %&#125;</div><div class="line">&#123;% if pagination %&#125;</div><div class="line">&lt;div class=&quot;pagination&quot;&gt;</div><div class="line">    &#123;&#123; macros.pagination_widget(pagination, &apos;.moderate&apos;) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endif %&#125;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>如果评论被设置为disable，将不能显示<br>文件：<strong>app/templates/_comments.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;comment-body&quot;&gt;</div><div class="line">    &#123;% if comment.disabled %&#125;</div><div class="line">    &lt;p&gt;&lt;i&gt;该评论无法显示&lt;/i&gt;&lt;/p&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">    &#123;% if comment.body_html %&#125;</div><div class="line">        &#123;&#123; comment.body_html | safe &#125;&#125;</div><div class="line">    &#123;% else %&#125;</div><div class="line">        &#123;&#123; comment.body &#125;&#125;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% if moderate %&#125;</div><div class="line">    &lt;br&gt;</div><div class="line">    &#123;% if comment.disabled %&#125;</div><div class="line">    &lt;a class=&quot;btn btn-default btn-xs&quot; href=&quot;&#123;&#123; url_for(&apos;.moderate_enable&apos;, id=comment.id, page=page) &#125;&#125;&quot;&gt;Enable&lt;/a&gt;</div><div class="line">    &#123;% else %&#125;</div><div class="line">    &lt;a class=&quot;btn btn-danger btn-xs&quot; href=&quot;&#123;&#123; url_for(&apos;.moderate_disable&apos;, id=comment.id, page=page) &#125;&#125;&quot;&gt;Disable&lt;/a&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure></p>
<p>添加enable和disable评论的路由<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/moderate/enable/&lt;int:id&gt;&apos;)</div><div class="line">@login_required</div><div class="line">@permission_required(Permission.MODERATE_COMMENTS)</div><div class="line">def moderate_enable(id):</div><div class="line">    comment = Comment.query.get_or_404(id)</div><div class="line">    comment.disabled = False</div><div class="line">    db.session.add(comment)</div><div class="line">    return redirect(url_for(&apos;.moderate&apos;,</div><div class="line">                            page=request.args.get(&apos;page&apos;, 1, type=int)))</div><div class="line"></div><div class="line">@main.route(&apos;/moderate/disable/&lt;int:id&gt;&apos;)</div><div class="line">@login_required</div><div class="line">@permission_required(Permission.MODERATE_COMMENTS)</div><div class="line">def moderate_disable(id):</div><div class="line">    comment = Comment.query.get_or_404(id)</div><div class="line">    comment.disabled = True</div><div class="line">    db.session.add(comment)</div><div class="line">    return redirect(url_for(&apos;.moderate&apos;,</div><div class="line">                            page=request.args.get(&apos;page&apos;, 1, type=int)))</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/23/myblog-0c/" data-id="cj5c7k427003pm0u47ps22cit" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-0b" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/22/myblog-0b/" class="article-date">
  <time datetime="2016-04-22T12:20:05.000Z" itemprop="datePublished">2016-04-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/22/myblog-0b/">myblog-0b 关注</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="关注"><a href="#关注" class="headerlink" title="关注"></a>关注</h1><h2 id="多对多关系"><a href="#多对多关系" class="headerlink" title="多对多关系"></a>多对多关系</h2><p>一对多关系，一般是在‘多’的那一方添加一个外键连接<br>多对多关系需要添加第三张表，用来储存关系<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">class Follow(db.Model):</div><div class="line">    __tablename__ = &apos;follows&apos;</div><div class="line">    follower_id = db.Column(db.Integer, db.ForeignKey(&apos;users.id&apos;),</div><div class="line">                            primary_key=True)</div><div class="line">    followed_id = db.Column(db.Integer, db.ForeignKey(&apos;users.id&apos;),</div><div class="line">                            primary_key=True)</div><div class="line">    timestamp = db.Column(db.DateTime, default=datetime.utcnow)</div><div class="line"></div><div class="line">class User(UserMixin, db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    followed = db.relationship(&apos;Follow&apos;,</div><div class="line">                               foreign_keys=[Follow.follower_id],   #为了消除歧义指定外键</div><div class="line">                               backref=db.backref(&apos;follower&apos;, lazy=&apos;joined&apos;),</div><div class="line">                               lazy=&apos;dynamic&apos;,</div><div class="line">                               cascade=&apos;all, delete-orphan&apos;)</div><div class="line">    followers = db.relationship(&apos;Follow&apos;,</div><div class="line">                                foreign_keys=[Follow.followed_id],</div><div class="line">                                backref=db.backref(&apos;followed&apos;, lazy=&apos;joined&apos;),</div><div class="line">                                lazy=&apos;dynamic&apos;,</div><div class="line">                                cascade=&apos;all, delete-orphan&apos;)</div><div class="line"></div><div class="line">    #...</div><div class="line">    def follow(self, user):</div><div class="line">        if not self.is_following(user):</div><div class="line">            f = Follow(followed=user)</div><div class="line">            self.followed.append(f)</div><div class="line"></div><div class="line">    def unfollow(self, user):</div><div class="line">        f = self.followed.filter_by(followed_id=user.id).first()</div><div class="line">        if f:</div><div class="line">            self.followed.remove(f)</div><div class="line"></div><div class="line">    def is_following(self, user):</div><div class="line">        return self.followed.filter_by(</div><div class="line">            followed_id=user.id).first() is not None</div><div class="line"></div><div class="line">    def is_followed_by(self, user):</div><div class="line">        return self.followers.filter_by(</div><div class="line">            follower_id=user.id).first() is not None</div></pre></td></tr></table></figure></p>
<h2 id="显示关注"><a href="#显示关注" class="headerlink" title="显示关注"></a>显示关注</h2><p>在用户信息页面显示关注信息<br>文件：<strong>app/templates/user.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;</div><div class="line">    &#123;% if current_user.can(Permission.FOLLOW) and user != current_user %&#125;</div><div class="line">        &#123;% if not current_user.is_following(user) %&#125;</div><div class="line">        &lt;a href=&quot;&#123;&#123; url_for(&apos;.follow&apos;, name=user.name) &#125;&#125;&quot; class=&quot;btn btn-primary&quot;&gt;关注&lt;/a&gt;</div><div class="line">        &#123;% else %&#125;</div><div class="line">        &lt;a href=&quot;&#123;&#123; url_for(&apos;.unfollow&apos;, name=user.name) &#125;&#125;&quot; class=&quot;btn btn-default&quot;&gt;取消关注&lt;/a&gt;</div><div class="line">        &#123;% endif %&#125;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">    &lt;a href=&quot;&#123;&#123; url_for(&apos;.followers&apos;, name=user.name) &#125;&#125;&quot;&gt;粉丝数：&lt;span class=&quot;badge&quot;&gt;&#123;&#123; user.followers.count() &#125;&#125;&lt;/span&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;&#123;&#123; url_for(&apos;.followed_by&apos;, name=user.name) &#125;&#125;&quot;&gt;正在关注：&lt;span class=&quot;badge&quot;&gt;&#123;&#123; user.followed.count() &#125;&#125;&lt;/span&gt;&lt;/a&gt;</div><div class="line">    &#123;% if current_user.is_authenticated and user != current_user and user.is_following(current_user) %&#125;</div><div class="line">    | &lt;span class=&quot;label label-default&quot;&gt;关注了你&lt;/span&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">&lt;/p&gt;</div></pre></td></tr></table></figure></p>
<h3 id="关注的相应路由"><a href="#关注的相应路由" class="headerlink" title="关注的相应路由"></a>关注的相应路由</h3><p>文件：<strong>app/main/views.py</strong><br>关注(取消关注)用户的路由：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/follow/&lt;name&gt;&apos;)</div><div class="line">@login_required</div><div class="line">@permission_required(Permission.FOLLOW)</div><div class="line">def follow(name):</div><div class="line">    #确保用户存在</div><div class="line">    user = User.query.filter_by(name=name).first()</div><div class="line">    if user is None:</div><div class="line">        flash(&apos;无效用户&apos;)</div><div class="line">        return redirect(url_for(&apos;.index&apos;))</div><div class="line">    #确保用户没有关注该用户</div><div class="line">    if current_user.is_following(user):</div><div class="line">        flash(&apos;你已经关注了这个用户&apos;)</div><div class="line">        return redirect(url_for(&apos;.user&apos;, name=name))</div><div class="line">    current_user.follow(user)</div><div class="line">    flash(&apos;成功关注 %s.&apos; % name)</div><div class="line">    return redirect(url_for(&apos;.user&apos;, name=name))</div><div class="line"></div><div class="line">@main.route(&apos;/unfollow/&lt;name&gt;&apos;)</div><div class="line">@login_required</div><div class="line">@permission_required(Permission.FOLLOW)</div><div class="line">def unfollow(name):</div><div class="line">    user = User.query.filter_by(name=name).first()</div><div class="line">    if user is None:</div><div class="line">        flash(&apos;无效用户&apos;)</div><div class="line">        return redirect(url_for(&apos;.index&apos;))</div><div class="line">    if not current_user.is_following(user):</div><div class="line">        flash(&apos;你没有关注该用户&apos;)</div><div class="line">        return redirect(url_for(&apos;.user&apos;, name=name))</div><div class="line">    current_user.unfollow(user)</div><div class="line">    flash(&apos;你已经取消关注 %s&apos; % name)</div><div class="line">    return redirect(url_for(&apos;.user&apos;, name=name))</div></pre></td></tr></table></figure></p>
<h3 id="显示关注者"><a href="#显示关注者" class="headerlink" title="显示关注者"></a>显示关注者</h3><p>关注数据从user.followd关系获取<br>FLASKY_FOLLOWERS_PER_PAGE在config.py默认配置为50<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/followers/&lt;name&gt;&apos;)</div><div class="line">def followers(name):</div><div class="line">    user = User.query.filter_by(name=name).first()</div><div class="line">    if user is None:</div><div class="line">        flash(&apos;无效用户&apos;)</div><div class="line">        return redirect(url_for(&apos;.index&apos;))</div><div class="line">    page = request.args.get(&apos;page&apos;, 1, type=int)</div><div class="line">    pagination = user.followers.paginate(</div><div class="line">        page, per_page=current_app.config[&apos;FLASKY_FOLLOWERS_PER_PAGE&apos;],</div><div class="line">        error_out=False)</div><div class="line">    follows = [&#123;&apos;user&apos;: item.follower, &apos;timestamp&apos;: item.timestamp&#125;</div><div class="line">               for item in pagination.items]</div><div class="line">    return render_template(&apos;followers.html&apos;, user=user, title=&quot;Followers of&quot;,</div><div class="line">                           endpoint=&apos;.followers&apos;, pagination=pagination,</div><div class="line">                           follows=follows)</div></pre></td></tr></table></figure></p>
<h2 id="关注者的博客文章"><a href="#关注者的博客文章" class="headerlink" title="关注者的博客文章"></a>关注者的博客文章</h2><h3 id="数据库查询"><a href="#数据库查询" class="headerlink" title="数据库查询"></a>数据库查询</h3><p><strong>Post.query.join(Follow, Follow.followed_id == Post.author_id)</strong>联接follows和posts<br>(***)<strong>.filter(Follow.follower_id == self.id)</strong>找到关注者为当前用户的值<br>类似的用mysql语句实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select u.id,u.name,f.followed_id,p.body from users as u </div><div class="line">        -&gt;  join follows as f on u.id=f.follower_id </div><div class="line">        -&gt;  join posts as p on f.followed_id=p.author_id;</div></pre></td></tr></table></figure></p>
<p>在用户模型添加查询关注者文章功能<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class User(db.Model):</div><div class="line">    # ...</div><div class="line">    @property</div><div class="line">    def followed_posts(self):</div><div class="line">        return Post.query.join(Follow, Follow.followed_id == Post.author_id)\</div><div class="line">            .filter(Follow.follower_id == self.id)</div></pre></td></tr></table></figure></p>
<h3 id="在首页显示所关注者文章"><a href="#在首页显示所关注者文章" class="headerlink" title="在首页显示所关注者文章"></a>在首页显示所关注者文章</h3><p>显示所有用户或者关注用户文章的flag保存在cookie(show_followed)中，使用两个路由设定值<br>Cookies 是设置在响应对象上的。由于通常视图函数只是返回字符串，之后 Flask 将字符串转换为响应对象。如果要显式地转换，你可以使用make_response() 函数然后再进行修改<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def index():</div><div class="line">    </div><div class="line">    #...</div><div class="line">    show_followed = False</div><div class="line">    if current_user.is_authenticated:</div><div class="line">        show_followed = bool(request.cookies.get(&apos;show_followed&apos;, &apos;&apos;))</div><div class="line">    if show_followed:</div><div class="line">        query = current_user.followed_posts</div><div class="line">    else:</div><div class="line">        query = Post.query</div><div class="line">    pagination = query.order_by(Post.timestamp.desc()).paginate(</div><div class="line">        page, per_page=current_app.config[&apos;FLASKY_POSTS_PER_PAGE&apos;],</div><div class="line">        error_out=False)</div><div class="line">    posts = pagination.items</div><div class="line">    return render_template(&apos;index.html&apos;, form=form, posts=posts,</div><div class="line">                           show_followed=show_followed, pagination=pagination)</div><div class="line"></div><div class="line">@main.route(&apos;/all&apos;)</div><div class="line">@login_required</div><div class="line">def show_all():</div><div class="line">    resp = make_response(redirect(url_for(&apos;.index&apos;)))</div><div class="line">    resp.set_cookie(&apos;show_followed&apos;, &apos;&apos;, max_age=30*24*60*60)</div><div class="line">    return resp</div><div class="line"></div><div class="line"></div><div class="line">@main.route(&apos;/followed&apos;)</div><div class="line">@login_required</div><div class="line">def show_followed():</div><div class="line">    resp = make_response(redirect(url_for(&apos;.index&apos;)))</div><div class="line">    resp.set_cookie(&apos;show_followed&apos;, &apos;1&apos;, max_age=30*24*60*60)</div><div class="line">    return resp</div></pre></td></tr></table></figure></p>
<p>在首页渲染两个标签对应两个路由<br>文件：<strong>app/templates/index.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;post-tabs&quot;&gt;</div><div class="line">    &lt;ul class=&quot;nav nav-tabs&quot;&gt;</div><div class="line">        &lt;li&#123;% if not show_followed %&#125; class=&quot;active&quot;&#123;% endif %&#125;&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;.show_all&apos;) &#125;&#125;&quot;&gt;All&lt;/a&gt;&lt;/li&gt;</div><div class="line">        &#123;% if current_user.is_authenticated %&#125;</div><div class="line">        &lt;li&#123;% if show_followed %&#125; class=&quot;active&quot;&#123;% endif %&#125;&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;.show_followed&apos;) &#125;&#125;&quot;&gt;Followers&lt;/a&gt;&lt;/li&gt;</div><div class="line">        &#123;% endif %&#125;</div><div class="line">    &lt;/ul&gt;</div><div class="line">    &#123;% include &apos;_posts.html&apos; %&#125;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<h3 id="用户自己关注自己"><a href="#用户自己关注自己" class="headerlink" title="用户自己关注自己"></a>用户自己关注自己</h3><p>添加一个函数，批量更新用户关注自己<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):</div><div class="line">    #...</div><div class="line">    def __init__(self, **kwargs):</div><div class="line">        #...</div><div class="line">        self.followed.append(Follow(followed=self))</div><div class="line"></div><div class="line">    @staticmethod</div><div class="line">    def add_self_follows():</div><div class="line">        for user in User.query.all():</div><div class="line">            if not user.is_following(user):</div><div class="line">                user.follow(user)</div><div class="line">                db.session.add(user)</div><div class="line">                db.session.commit()</div></pre></td></tr></table></figure></p>
<p>在Shell界面调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(venv)$ python manage.py shell</div><div class="line">&gt;&gt;&gt; User.add_self_follows()</div></pre></td></tr></table></figure></p>
<p>静止用户取消关注自己<br>文件：app/main/views.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/unfollow/&lt;name&gt;&apos;)</div><div class="line">@login_required</div><div class="line">@permission_required(Permission.FOLLOW)</div><div class="line">def unfollow(name):</div><div class="line">    #...</div><div class="line">    if user == current_user:</div><div class="line">        flash(&apos;小伙子可以的，不过用户不能取消关注自己&apos;)</div><div class="line">        return redirect(url_for(&apos;.index&apos;))</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/22/myblog-0b/" data-id="cj5c7k3c9003gm0u4gp55tva5" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-0a" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/21/myblog-0a/" class="article-date">
  <time datetime="2016-04-21T03:20:06.000Z" itemprop="datePublished">2016-04-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/21/myblog-0a/">myblog-0a 文章链接和编辑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="添加博客文章的固定链接"><a href="#添加博客文章的固定链接" class="headerlink" title="添加博客文章的固定链接"></a>添加博客文章的固定链接</h1><h2 id="文章路由"><a href="#文章路由" class="headerlink" title="文章路由"></a>文章路由</h2><p>到文章页面<strong>post.html</strong>的路由<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/post/&lt;int:id&gt;&apos;)</div><div class="line">def post(id):</div><div class="line">    post = Post.query.get_or_404(id)</div><div class="line">    return render_template(&apos;post.html&apos;, posts=[post])</div></pre></td></tr></table></figure></p>
<h2 id="文章模板"><a href="#文章模板" class="headerlink" title="文章模板"></a>文章模板</h2><p>每个文章后面都会添加一个单独的链接<br>文件：<strong>app/templates/_posts.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;ul class=&quot;posts&quot;&gt;</div><div class="line">    &#123;% for post in posts %&#125;</div><div class="line">    #...</div><div class="line">            &lt;div class=&quot;post-footer&quot;&gt;</div><div class="line">                &lt;a href=&quot;&#123;&#123; url_for(&apos;.post&apos;, id=post.id) &#125;&#125;&quot;&gt;</div><div class="line">                    &lt;span class=&quot;label label-default&quot;&gt;more&lt;/span&gt;</div><div class="line">                &lt;/a&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure></p>
<h2 id="单独博客文章页面"><a href="#单独博客文章页面" class="headerlink" title="单独博客文章页面"></a>单独博客文章页面</h2><p>从视图函数获得posts参数<br>文件：<strong>app/templates/post.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;_macros.html&quot; as macros %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Post&#123;% enm dblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&#123;% include &apos;_posts.html&apos; %S&#125;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h1 id="文章编辑器"><a href="#文章编辑器" class="headerlink" title="文章编辑器"></a>文章编辑器</h1><h2 id="渲染模板"><a href="#渲染模板" class="headerlink" title="渲染模板"></a>渲染模板</h2><p>文件：<strong>app/templates/edit_post.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Edit Post&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;编辑文章&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div&gt;</div><div class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block scripts %&#125;</div><div class="line">&#123;&#123; super() &#125;&#125;</div><div class="line">&#123;&#123; pagedown.include_pagedown() &#125;&#125;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h2 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h2><p>只允许作者本人或者管理员编辑文章，如果其他人视图编辑，返回403<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/edit/&lt;int:id&gt;&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">@login_required</div><div class="line">def edit(id):</div><div class="line">    post = Post.query.get_or_404(id)</div><div class="line">    if current_user != post.author and \</div><div class="line">            not current_user.can(Permission.ADMINISTER):</div><div class="line">        abort(403)</div><div class="line">    form = PostForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        post.body = form.body.data</div><div class="line">        db.session.add(post)</div><div class="line">        flash(&apos;The post has been updated.&apos;)</div><div class="line">        return redirect(url_for(&apos;.post&apos;, id=post.id))</div><div class="line">    form.body.data = post.body</div><div class="line">    return render_template(&apos;edit_post.html&apos;, form=form)</div></pre></td></tr></table></figure></p>
<h2 id="添加链接"><a href="#添加链接" class="headerlink" title="添加链接"></a>添加链接</h2><p>文件：<strong>app/templates/_posts.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;post-footer&quot;&gt;</div><div class="line">    &#123;% if current_user == post.author %&#125;</div><div class="line">    &lt;a href=&quot;&#123;&#123; url_for(&apos;.edit&apos;, id=post.id) &#125;&#125;&quot;&gt;</div><div class="line">        &lt;span class=&quot;label label-primary&quot;&gt;编辑&lt;/span&gt;</div><div class="line">    &lt;/a&gt;</div><div class="line">    &#123;% elif current_user.is_administrator() %&#125;</div><div class="line">    &lt;a href=&quot;&#123;&#123; url_for(&apos;.edit&apos;, id=post.id) &#125;&#125;&quot;&gt;</div><div class="line">        &lt;span class=&quot;label label-danger&quot;&gt;编辑&lt;/span&gt;</div><div class="line">    &lt;/a&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">    &lt;a href=&quot;&#123;&#123; url_for(&apos;.post&apos;, id=post.id) &#125;&#125;&quot;&gt;</div><div class="line">        &lt;span class=&quot;label label-default&quot;&gt;--more--&lt;/span&gt;</div><div class="line">    &lt;/a&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/21/myblog-0a/" data-id="cj5c7k3c7003em0u4nfci0xtg" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-opencv_color" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/20/opencv_color/" class="article-date">
  <time datetime="2016-04-20T12:28:34.000Z" itemprop="datePublished">2016-04-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/20/opencv_color/">颜色识别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><p>识别红色和蓝色</p>
<h1 id="用到的库"><a href="#用到的库" class="headerlink" title="用到的库"></a>用到的库</h1><ul>
<li>opencv</li>
<li>numpy<h1 id="代码如下"><a href="#代码如下" class="headerlink" title="代码如下"></a>代码如下</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*-coding:utf-8 -*-</div><div class="line"></div><div class="line">import numpy as np</div><div class="line">import cv2</div><div class="line"></div><div class="line">def find_red_and_blue(img):</div><div class="line">    height, width, channel = img.shape</div><div class="line">    rows= []</div><div class="line">    cols = []</div><div class="line">    #色调H∈ [0, 180）， 饱和度S ∈ [0, 255]， 亮度V ∈ [0, 255]</div><div class="line">    #H:</div><div class="line">    #   Orange  0-22</div><div class="line">    #   Yellow 22- 38</div><div class="line">    #   Green 38-75</div><div class="line">    #   Blue 75-130</div><div class="line">    #   Violet 130-160</div><div class="line">    #   Red 160-179</div><div class="line">    HSV_img = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)</div><div class="line"></div><div class="line">    flag = 0</div><div class="line"></div><div class="line">    for row in range(height):</div><div class="line">        for col in range(width):</div><div class="line">            H = HSV_img[row][col][0]</div><div class="line">            S = HSV_img[row][col][1]</div><div class="line">            V = HSV_img[row][col][2]</div><div class="line"></div><div class="line">            # blue \  red 根据实际情况做了微调</div><div class="line">            if (H &gt;= 160 and H &lt;= 179 and  V &gt;= 90 and V &lt;= 255 and S &gt;= 90 and S &lt;= 255) or \</div><div class="line">                (H &gt;= 111and H &lt;= 130 and  V &gt;= 150 and V &lt;= 255 and S &gt;= 150 and S &lt;= 255):</div><div class="line">                rows.append(row)</div><div class="line">                cols.append(col)</div><div class="line">                flag = 1</div><div class="line"></div><div class="line">    # 没有检测到红色或者蓝色</div><div class="line">    if flag == 0:</div><div class="line">        return 0,0,0,0</div><div class="line">    row_max = max(rows)</div><div class="line">    row_min = min(rows)</div><div class="line">    col_max = max(cols)</div><div class="line">    col_min = min(cols)</div><div class="line"></div><div class="line">    return row_max,row_min,col_max,col_min</div><div class="line"></div><div class="line">#打开摄像头</div><div class="line">cap = cv2.VideoCapture(0)</div><div class="line"></div><div class="line">#缩小图片</div><div class="line">ret = cap.set(3,160)</div><div class="line">ret = cap.set(4,120)</div><div class="line"></div><div class="line">while True:</div><div class="line"></div><div class="line">    ret, img = cap.read()</div><div class="line"></div><div class="line">    height, width, channel = img.shape</div><div class="line"></div><div class="line">    row_max,row_min,col_max,col_min = find_red_and_blue(img)</div><div class="line"></div><div class="line">    # 画矩形</div><div class="line">    try:</div><div class="line">        if row_max != 0 and height/(row_max - row_min) &lt;= 100 and width/(col_max - col_min) &lt;= 100:</div><div class="line">            pts = np.array([[col_min, row_min], [col_min, row_max], [col_max, row_max], [col_max, row_max]], np.int32)</div><div class="line">            pts = np.array([[col_min,row_min],[col_max,row_min],[col_max,row_max],[col_min,row_max]], np.int32)</div><div class="line">            pts = pts.reshape((-1,1,2))</div><div class="line">            img = cv2.polylines(img,[pts],True,(0,255,255))</div><div class="line"></div><div class="line">     #除零错误</div><div class="line">    except ZeroDivisionError:</div><div class="line">        pass</div><div class="line"></div><div class="line">    #img = cv2.resize(img, (320,240), interpolation=cv2.INTER_CUBIC)</div><div class="line">    # Display</div><div class="line">    cv2.imshow(&apos;image&apos;,img)</div><div class="line">    if cv2.waitKey(1) &amp; 0xFF == ord(&apos;q&apos;):</div><div class="line">        break</div><div class="line"></div><div class="line">#release everything</div><div class="line">cap.release()</div><div class="line">cv2.destroyAllWindows()</div></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/20/opencv_color/" data-id="cj5c7k42y0048m0u4jubn8tua" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-09" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/19/myblog-09/" class="article-date">
  <time datetime="2016-04-19T00:41:49.000Z" itemprop="datePublished">2016-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/19/myblog-09/">myblog-09 分页显示和markdown支持</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="分页显示微博"><a href="#分页显示微博" class="headerlink" title="分页显示微博"></a>分页显示微博</h1><h2 id="创建虚拟博客文章记录"><a href="#创建虚拟博客文章记录" class="headerlink" title="创建虚拟博客文章记录"></a>创建虚拟博客文章记录</h2><h3 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h3><p>自动生成依赖文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv)$ pip freeze &gt; requirements/common.txt</div></pre></td></tr></table></figure></p>
<p>配置环境<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv) $ pip install -r requirements.txt</div></pre></td></tr></table></figure></p>
<p>针对开发环境<br>文件：<strong>requirements/dev.txt</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-r common.txt</div><div class="line">ForgeryPy==0.1</div></pre></td></tr></table></figure></p>
<h3 id="添加创建虚拟用户功能"><a href="#添加创建虚拟用户功能" class="headerlink" title="添加创建虚拟用户功能"></a>添加创建虚拟用户功能</h3><p>随机生成用户和其他数据通过forgery_py随机信息生成器生成<br>因为是随机生成，所以有可能重复，当重复时，会报出IntegrityError异常<br>检测出异常需要回滚数据<br>随机生成文章时，通过随机定义一个不超过用户个数的偏移量，检索随机用户<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    @staticmethod</div><div class="line">    def generate_fake(count=100):</div><div class="line">        from sqlalchemy.exc import IntegrityError</div><div class="line">        from random import seed</div><div class="line">        import forgery_py</div><div class="line"></div><div class="line">        seed()</div><div class="line">        for i in range(count):</div><div class="line">            u = User(email=forgery_py.internet.email_address(),</div><div class="line">                     name=forgery_py.internet.user_name(True),</div><div class="line">                     password=forgery_py.lorem_ipsum.word(),</div><div class="line">                     confirmed=True,</div><div class="line">                     location=forgery_py.address.city(),</div><div class="line">                     about_me=forgery_py.lorem_ipsum.sentence(),</div><div class="line">                     member_since=forgery_py.date.date(True))</div><div class="line">            db.session.add(u)</div><div class="line">            try:</div><div class="line">                db.session.commit()</div><div class="line">            except IntegrityError:</div><div class="line">                db.session.rollback()</div><div class="line"></div><div class="line">class Post(db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    @staticmethod</div><div class="line">    def generate_fake(count=100):</div><div class="line">        from random import seed, randint</div><div class="line">        import forgery_py</div><div class="line"></div><div class="line">        seed()</div><div class="line">        user_count = User.query.count()</div><div class="line">        for i in range(count):</div><div class="line">            u = User.query.offset(randint(0, user_count - 1)).first()</div><div class="line">            p = Post(body=forgery_py.lorem_ipsum.sentences(randint(1, 5)),</div><div class="line">                     timestamp=forgery_py.date.date(True),</div><div class="line">                     author=u)</div><div class="line">            db.session.add(p)</div><div class="line">            db.session.commit()</div></pre></td></tr></table></figure></p>
<p>在shell下添加虚拟用户和文章<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(venv) $ python manage.py shell</div><div class="line">&gt;&gt;&gt; User.generate_fake(100)</div><div class="line">&gt;&gt;&gt; Post.generate_fake(100)</div></pre></td></tr></table></figure></p>
<h2 id="数据库分页读取"><a href="#数据库分页读取" class="headerlink" title="数据库分页读取"></a>数据库分页读取</h2><p>获取页面的页数从request.args.get()中获取，如果没有明确指定，page默认为1，即第一页<br>在URL最后加上<strong>?page=2</strong>，page值为2，即为第二页<br>在order_by检索完之后，在进行paginate检索<br>第一个参数page为必须参数<br>第二个参数per_page为每页个数，在config.py里面配置成默认10<br>第三个参数为True时，如果请求的页数超出了范围会返回404，False返回空列表<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def index():</div><div class="line"></div><div class="line">    #...</div><div class="line">    page = request.args.get(&apos;page&apos;, 1, type=int)</div><div class="line">    pagination = Post.query.order_by(Post.timestamp.desc()).paginate(</div><div class="line">        page, per_page=current_app.config[&apos;FLASKY_POSTS_PER_PAGE&apos;],</div><div class="line">        error_out=False)</div><div class="line">    posts = pagination.items</div><div class="line">    return render_template(&apos;index.html&apos;, form=form, posts=posts,</div><div class="line">                           pagination=pagination)</div></pre></td></tr></table></figure></p>
<h2 id="添加分页导航"><a href="#添加分页导航" class="headerlink" title="添加分页导航"></a>添加分页导航</h2><h3 id="Pagination属性"><a href="#Pagination属性" class="headerlink" title="Pagination属性"></a>Pagination属性</h3><p><strong>paginate()</strong>方法返回的是一个<strong>Pagination</strong>类对象，具有以下属性</p>
<table>
<thead>
<tr>
<th>属  性</th>
<th>说  明</th>
</tr>
</thead>
<tbody>
<tr>
<td>items</td>
<td>当前页面中的记录</td>
</tr>
<tr>
<td>query</td>
<td>分页的源查询</td>
</tr>
<tr>
<td>page</td>
<td>当前页数</td>
</tr>
<tr>
<td>prev_num</td>
<td>上一页的页数</td>
</tr>
<tr>
<td>next_num</td>
<td>下一页的页数</td>
</tr>
<tr>
<td>has_next</td>
<td>如果有下一页,返回 True</td>
</tr>
<tr>
<td>has_prev</td>
<td>如果有上一页,返回 True</td>
</tr>
<tr>
<td>pages</td>
<td>查询得到的总页数</td>
</tr>
<tr>
<td>per_page</td>
<td>每页显示的记录数量</td>
</tr>
<tr>
<td>total</td>
<td>查询返回的记录总数</td>
</tr>
</tbody>
</table>
<p>可以调用的方法</p>
<ul>
<li>iter_pages(left_edge=2,left_current=2,right_current=5,right_edge=2)：<br>一个迭代器,返回一个在分页导航中显示的页数列表。这个列表的最左边显示 left_edge页,当前页的左边显示left_current 页,当前页的右边显示 right_current 页,最右边显示 right_edge 页。<br>例如,在一个 100 页的列表中,当前页为第50 页,使用默认配置,这个方法会返回以下页数:1、2、 None 、48、49、50、51、52、53、54、55、 None 、99、100。 None 表示页数之间的间隔</li>
<li>prev()：上一页的分页对象</li>
<li>next()：下一页的分页对象</li>
</ul>
<h3 id="分页模块宏"><a href="#分页模块宏" class="headerlink" title="分页模块宏"></a>分页模块宏</h3><p>检测当前页数是不是第一页或者最后一页，在上一页和下一页添加disabled类<br>文件保存在_macros.html中，在index和user中导入<br>文件：<strong>app/templates/_macros.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">&#123;% macro pagination_widget(pagination, endpoint) %&#125;</div><div class="line">&lt;ul class=&quot;pagination&quot;&gt;</div><div class="line">    &lt;li&#123;% if not pagination.has_prev %&#125; class=&quot;disabled&quot;&#123;% endif %&#125;&gt;</div><div class="line">        &lt;a href=&quot;&#123;% if pagination.has_prev %&#125;&#123;&#123; url_for(endpoint, page=pagination.prev_num, **kwargs) &#125;&#125;&#123;% else %&#125;#&#123;% endif %&#125;&quot;&gt;</div><div class="line">            &amp;laquo;</div><div class="line">        &lt;/a&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line">    &#123;% for p in pagination.iter_pages() %&#125;</div><div class="line">        &#123;% if p %&#125;</div><div class="line">            &#123;% if p == pagination.page %&#125;</div><div class="line">            &lt;li class=&quot;active&quot;&gt;</div><div class="line">                &lt;a href=&quot;&#123;&#123; url_for(endpoint, page = p, **kwargs) &#125;&#125;&quot;&gt;&#123;&#123; p &#125;&#125;&lt;/a&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">            &#123;% else %&#125;</div><div class="line">            &lt;li&gt;</div><div class="line">                &lt;a href=&quot;&#123;&#123; url_for(endpoint, page = p, **kwargs) &#125;&#125;&quot;&gt;&#123;&#123; p &#125;&#125;&lt;/a&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">            &#123;% endif %&#125;</div><div class="line">        &#123;% else %&#125;</div><div class="line">        &lt;li class=&quot;disabled&quot;&gt;&lt;a href=&quot;#&quot;&gt;&amp;hellip;&lt;/a&gt;&lt;/li&gt;</div><div class="line">        &#123;% endif %&#125;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">    &lt;li&#123;% if not pagination.has_next %&#125; class=&quot;disabled&quot;&#123;% endif %&#125;&gt;</div><div class="line">        &lt;a href=&quot;&#123;% if pagination.has_next %&#125;&#123;&#123; url_for(endpoint, page=pagination.next_num, **kwargs) &#125;&#125;&#123;% else %&#125;#&#123;% endif %&#125;&quot;&gt;</div><div class="line">            &amp;raquo;</div><div class="line">        &lt;/a&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line">&lt;/ul&gt;</div><div class="line">&#123;% endmacro %&#125;</div></pre></td></tr></table></figure></p>
<p>文件：<strong>app/templates/index.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line">&#123;% import &quot;_macros.html&quot; as macros %&#125;</div><div class="line"></div><div class="line">#...</div><div class="line">&#123;% if pagination %&#125;</div><div class="line">&lt;div class=&quot;pagination&quot;&gt;</div><div class="line">    &#123;&#123; macros.pagination_widget(pagination, &apos;.index&apos;) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endif %&#125;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>文件：<strong>app/templates/user.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;_macros.html&quot; as macros %&#125;</div><div class="line"></div><div class="line">#...</div><div class="line">&lt;h3&gt;&#123;&#123; user.name &#125;&#125;的文章&lt;/h3&gt;</div><div class="line">&#123;% include &apos;_posts.html&apos; %&#125;</div><div class="line">&#123;% if pagination %&#125;</div><div class="line">&lt;div class=&quot;pagination&quot;&gt;</div><div class="line">    &#123;&#123; macros.pagination_widget(pagination, &apos;.user&apos;, username=user.username) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endif %&#125;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Markdown和Flask-PageDown支持"><a href="#Markdown和Flask-PageDown支持" class="headerlink" title="Markdown和Flask-PageDown支持"></a>Markdown和Flask-PageDown支持</h1><h2 id="需要的包"><a href="#需要的包" class="headerlink" title="需要的包"></a>需要的包</h2><ul>
<li>PageDown：使用JavaScript实现的客户端Markdown到HTML转换程序</li>
<li>Flask-PageDown：为Flask包装的PageDown，把PageDown集成到Flask-WTF表单</li>
<li>Markdown：使用 Python 实现的服务器端 Markdown 到 HTML 的转换程序</li>
<li>Bleach：使用 Python 实现的 HTML 清理器。</li>
</ul>
<h3 id="使用Flask-PageDown扩展"><a href="#使用Flask-PageDown扩展" class="headerlink" title="使用Flask-PageDown扩展"></a>使用Flask-PageDown扩展</h3><p>初始化<br>文件：<strong>app/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line">#-*-coding:utf-8-*-</div><div class="line"></div><div class="line">from flask.ext.pagedown import PageDown</div><div class="line">#...</div><div class="line"></div><div class="line">pagedown = PageDown()</div><div class="line">#...</div><div class="line">def create_app(config_name):</div><div class="line">    </div><div class="line">    #...</div><div class="line">    pagedown.init_app(app)</div><div class="line">    #...</div></pre></td></tr></table></figure></p>
<p>添加Markdown表单<br>文件：<strong>app/main/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from flask.ext.pagedown.fields import PageDownField </div><div class="line"></div><div class="line">class PostForm(Form):</div><div class="line">    body = PageDownField(&apos;写点什么&apos;, validators=[Required()])</div><div class="line">    submit = SubmitField(&apos;提交&apos;)</div></pre></td></tr></table></figure></p>
<p>Markdown预览，在index.html文件导入这个功能<br>文件：<strong>app/templates/index.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;% block scripts %&#125;</div><div class="line">&#123;&#123; super() &#125;&#125;</div><div class="line">&#123;&#123; pagedown.include_pagedown() &#125;&#125;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>在用户模型中添加<strong>body_html</strong>储存Markdown转化成的HTML<br><strong>markdown()</strong>函数把Markdown转化成HTML，然后把结果传给<strong>clean()</strong>，删除不在白名单的标签<br>attributes参数能够保存标签的属性，不然无法插入图片<br>最后，<strong>linkify()</strong>函数把纯文本中的URL转成适当的<a\>链接<br>数据库监听body字段’set’事件，如果发生变化，重新进行转换<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">from markdown import markdown</div><div class="line">import bleach</div><div class="line"></div><div class="line">class Post(db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    body_html = db.Column(db.Text)</div><div class="line"></div><div class="line">    #...</div><div class="line">    @staticmethod</div><div class="line">    def on_changed_body(target, value, oldvalue, initiator):</div><div class="line">        allowed_tags = [&apos;a&apos;, &apos;abbr&apos;, &apos;acronym&apos;, &apos;b&apos;, &apos;blockquote&apos;, &apos;code&apos;,</div><div class="line">                        &apos;em&apos;, &apos;i&apos;, &apos;li&apos;, &apos;ol&apos;, &apos;pre&apos;, &apos;strong&apos;, &apos;ul&apos;,</div><div class="line">                        &apos;h1&apos;, &apos;h2&apos;, &apos;h3&apos;, &apos;p&apos;, &apos;img&apos;]</div><div class="line">        attrs = &#123;</div><div class="line">            &quot;img&quot;:[&quot;src&quot;]</div><div class="line">        &#125;</div><div class="line">        target.body_html = bleach.linkify(bleach.clean(</div><div class="line">            markdown(value, output_format=&apos;html&apos;),</div><div class="line">            tags=allowed_tags, strip=True ,attributes=attrs))</div><div class="line"></div><div class="line">db.event.listen(Post.body, &apos;set&apos;, Post.on_changed_body)</div></pre></td></tr></table></figure></a\></p>
<p>渲染HTML格式内容时使用 | safe后缀，告诉Jinja2不要转义HTML元素<br>文件：<strong>app/templates/__posts.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;post-body&quot;&gt;</div><div class="line">    &#123;% if post.body_html %&#125;</div><div class="line">        &#123;&#123; post.body_html | safe &#125;&#125;</div><div class="line">    &#123;% else %&#125;</div><div class="line">        &#123;&#123; post.body &#125;&#125;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/19/myblog-09/" data-id="cj5c7k3ax002gm0u4ognw06s5" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-08" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/18/myblog-08/" class="article-date">
  <time datetime="2016-04-18T01:45:56.000Z" itemprop="datePublished">2016-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/18/myblog-08/">myblog-08 博客文章</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="博客文章"><a href="#博客文章" class="headerlink" title="博客文章"></a>博客文章</h1><h2 id="文章支持"><a href="#文章支持" class="headerlink" title="文章支持"></a>文章支持</h2><h3 id="更新数据库模型"><a href="#更新数据库模型" class="headerlink" title="更新数据库模型"></a>更新数据库模型</h3><p>这里需要新建一个数据库模型，用来储存博客文章<br>用户与博客文章是一对多的关系<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">class Post(db.Model):</div><div class="line">    __tablename__ = &quot;posts&quot;</div><div class="line">    id = db.Column(db.Integer, primary_key=True)</div><div class="line">    body = db.Column(db.Text())</div><div class="line">    timestamp = db.Column(db.DateTime(), index=True, default=datetime.utcnow)</div><div class="line">    author_id = db.Column(db.Integer, db.ForeignKey(users.id))</div><div class="line"></div><div class="line">class User(UserMixin, db.Model):</div><div class="line">    </div><div class="line">    #...</div><div class="line">    posts = db.relationship(&apos;Post&apos;, backref=&apos;author&apos;, lazy=&apos;dynamic&apos;)</div></pre></td></tr></table></figure></p>
<h3 id="简历表单"><a href="#简历表单" class="headerlink" title="简历表单"></a>简历表单</h3><p>建立一个表单，提供给用户写博客文章<br>文件：<strong>app/main/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">class PostForm(Form):</div><div class="line">    name = StringField(&apos;write something here: &apos;, validators=[Required()])</div><div class="line">    submit = SubmitField(&apos;Submit&apos;)</div></pre></td></tr></table></figure></p>
<p>首页路由提供用户写文章的表单，并把文章上传到数据库，前提是用户拥有写文章的权限<br>用户第一次GET请求会把所有文章按照时间检索出来<br>用户对象的_get_current_object()类，是真正的用户对象<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def index():</div><div class="line">    form =PostForm()</div><div class="line">    if current_user.can(Permission.WRITE_ARTICLES) adn \</div><div class="line">            form.validate_on_submit():</div><div class="line">        post = Post(body=form.body.data,</div><div class="line">                            author=current_user._get_current_object())</div><div class="line">        db.session.add(post)</div><div class="line">        return redirect(url_for(&apos;.index&apos;))</div><div class="line">    posts = Post.query.order_by(Post.timestamp.desc()).all()</div><div class="line">    return render_template(&apos;index.html&apos;, form=form, posts=posts)</div></pre></td></tr></table></figure></p>
<h3 id="显示文章"><a href="#显示文章" class="headerlink" title="显示文章"></a>显示文章</h3><p>在主页渲染<br>利用循环，将所有内容显示出来<br>文件：<strong>app/templates/index.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;主站&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Hello, &#123;% if current_user.is_authenticated %&#125;&#123;&#123; current_user.name &#125;&#125;&#123;% else %&#125;Stranger&#123;% endif %&#125;!&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div&gt;</div><div class="line">    &#123;% if current_user.can(Permission.WRITE_ARTICLES) %&#125;</div><div class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;ul class=&quot;posts&quot;&gt;</div><div class="line">    &#123;% for post in posts %&#125;</div><div class="line">    &lt;li class=&quot;post&quot;&gt;</div><div class="line">        &lt;div class=&quot;post-thumbnail&quot;&gt;</div><div class="line">            &lt;a href=&quot;&#123;&#123; url_for(&apos;.user&apos;, name=post.author.name) &#125;&#125;&quot;&gt;</div><div class="line">                &lt;img class=&quot;img-rounded profile-thumbnail&quot; src=&quot;&#123;&#123; post.author.avatar&#125;&#125;&quot; width=&quot;40px&quot; height=&quot;40px&quot;&gt;</div><div class="line">            &lt;/a&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;post-content&quot;&gt;</div><div class="line">            &lt;div class=&quot;post-date&quot;&gt;&#123;&#123; moment(post.timestamp).fromNow() &#125;&#125;&lt;/div&gt;</div><div class="line">            &lt;div class=&quot;post-author&quot;&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;.user&apos;, name=post.author.name) &#125;&#125;&quot;&gt;&#123;&#123; post.author.name &#125;&#125;&lt;/a&gt;&lt;/div&gt;</div><div class="line">            &lt;div class=&quot;post-body&quot;&gt;&#123;&#123; post.body &#125;&#125;&lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">&lt;/ul&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h3 id="添加CSS样式"><a href="#添加CSS样式" class="headerlink" title="添加CSS样式"></a>添加CSS样式</h3><p>添加一个css文件，保存在static文件夹里面<br>文件：<strong>app/static/styles.css</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">.profile-thumbnail &#123;</div><div class="line">    position: absolute;</div><div class="line">&#125;</div><div class="line">.profile-header &#123;</div><div class="line">    min-height: 260px;</div><div class="line">    margin-left: 280px;</div><div class="line">&#125;</div><div class="line">ul.posts &#123;</div><div class="line">    list-style-type: none;</div><div class="line">    padding: 0px;</div><div class="line">    margin: 16px 0px 0px 0px;</div><div class="line">    border-top: 1px solid #e0e0e0;</div><div class="line">&#125;</div><div class="line">ul.posts li.post &#123;</div><div class="line">    padding: 8px;</div><div class="line">    border-bottom: 1px solid #e0e0e0;</div><div class="line">&#125;</div><div class="line">ul.posts li.post:hover &#123;</div><div class="line">    background-color: #f0f0f0;</div><div class="line">&#125;</div><div class="line">div.post-date &#123;</div><div class="line">    float: right;</div><div class="line">&#125;</div><div class="line">div.post-author &#123;</div><div class="line">    font-weight: bold;</div><div class="line">&#125;</div><div class="line">div.post-thumbnail &#123;</div><div class="line">    position: absolute;</div><div class="line">&#125;</div><div class="line">div.post-content &#123;</div><div class="line">    margin-left: 48px;</div><div class="line">    min-height: 48px;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在base.html中导入css文件<br>文件：<strong>app/templates/base.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;% block head %&#125;</div><div class="line">&#123;&#123; super() &#125;&#125;</div><div class="line">&lt;link rel=&quot;icon&quot; href=&quot;&#123;&#123; url_for(&apos;static&apos;, filename=&apos;shortcut.ico&apos;) &#125;&#125;&quot; type=&quot;image/x-icon&quot;&gt;</div><div class="line">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;&#123;&#123; url_for(&apos;static&apos;, filename=&apos;styles.css&apos;) &#125;&#125;&quot;&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/18/myblog-08/" data-id="cj5c7k3al002bm0u4y1sa0vg4" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-07" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/myblog-07/" class="article-date">
  <time datetime="2016-04-17T05:18:51.000Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/myblog-07/">myblog-07 用户资料</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="用户资料"><a href="#用户资料" class="headerlink" title="用户资料"></a>用户资料</h1><h2 id="更新数据库"><a href="#更新数据库" class="headerlink" title="更新数据库"></a>更新数据库</h2><h3 id="编写用户模板"><a href="#编写用户模板" class="headerlink" title="编写用户模板"></a>编写用户模板</h3><p>在用户模板中添加所在地、个性签名、注册日期和最后访问日期<br>数据库以datetime格式存储UTC时间，Flask-Moment自动更具时区渲染时间<br>首先引入moment.js库<br>文件：<strong>app/templates/base.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;% block scripts %&#125;</div><div class="line">&#123;&#123; super() &#125;&#125;</div><div class="line">&#123;&#123; moment.include_moment() &#125;&#125;</div><div class="line">&#123;&#123; moment.lang(&quot;zh-CN&quot;) &#125;&#125; </div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>渲染时间<br>文件：<strong>app/templates/user.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;Member since &#123;&#123; moment(user.member_since).format(&apos;LL&apos;) &#125;&#125;.&lt;/p&gt;</div><div class="line">&lt;p&gt;Last seen &#123;&#123; moment(user.last_seen).fromNow() &#125;&#125;.&lt;/p&gt;</div></pre></td></tr></table></figure></p>
<p>db.String()和db.Text()的区别是后者不需要指定长度<br>这里的member_since和last_seen分别是注册日期和最后访问日期，默认值都是now函数的值<br>如果数据库提交时，没有赋值，则提交默认值，而不是NULL<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">from datetime import datetime</div><div class="line"></div><div class="line">class User(UserMixin, db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    location = db.Column(db.String(64))</div><div class="line">    about_me = db.Column(db.Text())</div><div class="line">    member_since = db.Column(db.DateTime(), default=datetime.now)</div><div class="line">    last_seen = db.Column(db.DateTime(), default=datetime.now)</div></pre></td></tr></table></figure></p>
<h3 id="刷新最后访问日期"><a href="#刷新最后访问日期" class="headerlink" title="刷新最后访问日期"></a>刷新最后访问日期</h3><p>添加用户刷新时间功能<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    def ping(self):</div><div class="line">        self.last_seen = datetime.now()</div><div class="line">        db.session.add(self)</div></pre></td></tr></table></figure></p>
<p>auth蓝本中的before_app_request处理程序会在用户每次请求之前运行<br>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@auth.before_app_request</div><div class="line">def before_request():</div><div class="line">    if current_user.is_authenticated:</div><div class="line">        current_user.ping()</div><div class="line">        #...</div></pre></td></tr></table></figure></p>
<h2 id="用户资料页面"><a href="#用户资料页面" class="headerlink" title="用户资料页面"></a>用户资料页面</h2><h3 id="编写路由"><a href="#编写路由" class="headerlink" title="编写路由"></a>编写路由</h3><p>从URL接收参数name，如果用户不存在，返回404错误<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/user/&lt;name&gt;&apos;)</div><div class="line">def user(name):</div><div class="line">    user = User.query.filter_by(name=name).first_or_404()</div><div class="line">    return render_template(&apos;user.html&apos;, user=user)</div></pre></td></tr></table></figure></p>
<h3 id="资料页面模板"><a href="#资料页面模板" class="headerlink" title="资料页面模板"></a>资料页面模板</h3><p>只有管理员可以看到邮件地址<br>文件：<strong>app/templates/user.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;&#123;&#123; user.name &#125;&#125;&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;&#123;&#123; user.name &#125;&#125;&lt;/h1&gt;</div><div class="line">    &#123;% if user.name or user.location %&#125;</div><div class="line">    &lt;p&gt;</div><div class="line">        &#123;% if user.location %&#125;</div><div class="line">            From &lt;a href=&quot;http://maps.google.com/?q=&#123;&#123; user.location &#125;&#125;&quot;&gt;&#123;&#123; user.location &#125;&#125;&lt;/a&gt;</div><div class="line">        &#123;% endif %&#125;</div><div class="line">    &lt;/p&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">    &#123;% if current_user.is_administrator() %&#125;</div><div class="line">    &lt;p&gt;&#123;&#123; user.email &#125;&#125;&lt;/a&gt;&lt;/p&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">    &#123;% if user.about_me %&#125;&lt;p&gt;&#123;&#123; user.about_me &#125;&#125;&lt;/p&gt;&#123;% endif %&#125;</div><div class="line">    &lt;p&gt;Member since &#123;&#123; moment(user.member_since).format(&apos;LL&apos;) &#125;&#125;.&lt;/p&gt;</div><div class="line">    &lt;p&gt;Last seen &#123;&#123; moment(user.last_seen).fromNow() &#125;&#125;.&lt;/p&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h3 id="查看个人资料"><a href="#查看个人资料" class="headerlink" title="查看个人资料"></a>查看个人资料</h3><p>在导航条创建一个链接，用于访问自己的资料<br>文件：<strong>app/templates/base.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;% if current_user.is_authenticated %&#125;</div><div class="line">&lt;li class=&quot;dropdown&quot;&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;Account &lt;b class=&quot;caret&quot;&gt;&lt;/b&gt;&lt;/a&gt;</div><div class="line">    &lt;ul class=&quot;dropdown-menu&quot;&gt;</div><div class="line">        &lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;main.user&apos;, name=current_user.name) &#125;&#125;&quot;&gt;Profile&lt;/a&gt;&lt;/li&gt;</div><div class="line">        #...</div><div class="line">    &lt;/ul&gt;</div><div class="line">&lt;/li&gt;</div><div class="line">&#123;% else %&#125;</div></pre></td></tr></table></figure></p>
<h2 id="资料编辑器"><a href="#资料编辑器" class="headerlink" title="资料编辑器"></a>资料编辑器</h2><p>用户可以通过资料编辑器更改自己的资料<br>管理员可以通过资料编辑器更改所有用户资料和角色<br>针对两个角色创建不同的表单</p>
<h3 id="用户级别的资料编辑器"><a href="#用户级别的资料编辑器" class="headerlink" title="用户级别的资料编辑器"></a>用户级别的资料编辑器</h3><p>这个表单中的所有字段都是可选的，可以不填<br>文件：<strong>app/main/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">class EditProfileForm(Form):</div><div class="line">    location = StringField(&apos;Location&apos;, validators=[Length(0, 64)])</div><div class="line">    about_me = TextAreaField(&apos;About me&apos;)</div><div class="line">    submit = SubmitField(&apos;Submit&apos;)</div></pre></td></tr></table></figure></p>
<p>渲染表单<br>文件：<strong>app/templates/edit_profile.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Edit Profile&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Edit Your Profile&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div class=&quot;col-md-4&quot;&gt;</div><div class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>编辑路由<br>在显示表单之前，存下初始值，如果没有提交更改，返回默认值<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/edit-profile&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">@login_required</div><div class="line">def edit_profile():</div><div class="line">    form = EditProfileForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        current_user.location = form.location.data</div><div class="line">        current_user.about_me = form.about_me.data</div><div class="line">        db.session.add(current_user)</div><div class="line">        flash(&apos;Your profile has been updated.&apos;)</div><div class="line">        return redirect(url_for(&apos;.user&apos;, name=current_user.name))</div><div class="line">    form.location.data = current_user.location</div><div class="line">    form.about_me.data = current_user.about_me</div><div class="line">    return render_template(&apos;edit_profile.html&apos;, form=form)</div></pre></td></tr></table></figure></p>
<p>添加到编辑页面的链接<br>文件：<strong>app/templates/user.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;</div><div class="line">    &#123;% if user == current_user %&#125;</div><div class="line">        &lt;a class=&quot;btn btn-default&quot; href=&quot;&#123;&#123; url_for(&apos;.edit_profile&apos;) &#125;&#125;&quot;&gt;Edit Profile&lt;/a&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">&lt;/p&gt;</div></pre></td></tr></table></figure></p>
<p>关于数据库中文乱码的问题，创建表的时候，指定编码格式：<strong>default charset=utf8</strong></p>
<h3 id="管理员级别的资料编辑器"><a href="#管理员级别的资料编辑器" class="headerlink" title="管理员级别的资料编辑器"></a>管理员级别的资料编辑器</h3><p>管理员使用的表单比普通用户复杂，除了地点、个性签名还有用户名、电子邮件、确认状态和角色<br>SelectField实例必须在choice属性中设置各选项，选项是一个元组组成的列表<br>这里使用一个查询按照角色名的字母排序的所有角色<br>SelectField构造函数中添加coerce=int参数，从而把字段值转化为整数，而不使用字符串<br>email和name字段的构造方式和认证表单中一样<br>文件：<strong>app/main/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">class EditProfileAdminForm(Form):</div><div class="line">    email = StringField(&apos;Email&apos;, validators=[Required(), Length(1, 64),</div><div class="line">                                             Email()])</div><div class="line">    confirmed = BooleanField(&apos;Confirmed&apos;)</div><div class="line">    name = StringField(&apos;Name&apos;, validators=[</div><div class="line">        Required(), Length(1, 64), Regexp(&apos;^[A-Za-z][A-Za-z0-9_.]*$&apos;, 0,</div><div class="line">                                          &apos;Names must have only letters, &apos;</div><div class="line">                                          &apos;numbers, dots or underscores&apos;)])</div><div class="line">    role = SelectField(&apos;Role&apos;, coerce=int)</div><div class="line">    location = StringField(&apos;Location&apos;, validators=[Length(0, 64)])</div><div class="line">    about_me = TextAreaField(&apos;About me&apos;)</div><div class="line">    submit = SubmitField(&apos;Submit&apos;)</div><div class="line"></div><div class="line">    def __init__(self, user, *args, **kwargs):</div><div class="line">        super(EditProfileAdminForm, self).__init__(*args, **kwargs)</div><div class="line">        self.role.choices = [(role.id, role.name)</div><div class="line">                             for role in Role.query.order_by(Role.name).all()]</div><div class="line">        self.user = user</div><div class="line"></div><div class="line">    def validate_email(self, field):</div><div class="line">        if field.data != self.user.email and \</div><div class="line">                User.query.filter_by(email=field.data).first():</div><div class="line">            raise ValidationError(&apos;Email already registered.&apos;)</div><div class="line"></div><div class="line">    def validate_name(self, field):</div><div class="line">        if field.data != self.user.name and \</div><div class="line">                User.query.filter_by(name=field.data).first():</div><div class="line">            raise ValidationError(&apos;Name already in use.&apos;)</div></pre></td></tr></table></figure></p>
<p>视图函数，通过URL获得用户id，如果用户不存在，返回404<br>user.role是通过Role查询赋值<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/edit-profile/&lt;int:id&gt;&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">@login_required</div><div class="line">@admin_required</div><div class="line">def edit_profile_admin(id):</div><div class="line">    user = User.query.get_or_404(id)</div><div class="line">    form = EditProfileAdminForm(user=user)</div><div class="line">    if form.validate_on_submit():</div><div class="line">        user.email = form.email.data</div><div class="line">        user.name = form.name.data</div><div class="line">        user.confirmed = form.confirmed.data</div><div class="line">        user.role = Role.query.get(form.role.data)</div><div class="line">        user.location = form.location.data</div><div class="line">        user.about_me = form.about_me.data</div><div class="line">        db.session.add(user)</div><div class="line">        flash(&apos;The profile has been updated.&apos;)</div><div class="line">        return redirect(url_for(&apos;.user&apos;, name=user.name))</div><div class="line">    form.email.data = user.email</div><div class="line">    form.confirmed.data = user.confirmed</div><div class="line">    form.role.data = user.role_id</div><div class="line">    form.name.data = user.name</div><div class="line">    form.location.data = user.location</div><div class="line">    form.about_me.data = user.about_me</div><div class="line">    return render_template(&apos;edit_profile.html&apos;, form=form, user=user)</div></pre></td></tr></table></figure></p>
<p>在用户的资料页面添加管理员管理链接<br>文件：<strong>app/templates/user.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;% if current_user.is_administrator() %&#125;</div><div class="line">    &lt;a class=&quot;btn btn-danger&quot; href=&quot;&#123;&#123; url_for(&apos;.edit_profile_admin&apos;, id=user.id) &#125;&#125;&quot;&gt;Edit Profile [Admin]&lt;/a&gt;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure></p>
<h2 id="用户头像"><a href="#用户头像" class="headerlink" title="用户头像"></a>用户头像</h2><p>这里使用的是将图片的URL储存在数据库，需要更新用户模型<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):  </div><div class="line">    #...</div><div class="line">    avatar = db.Column(db.String(128))</div><div class="line">    #...</div></pre></td></tr></table></figure></p>
<p>视图函数也稍微修改<br>文件：<strong>app/main/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">@main.route(&apos;/edit-profile&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">@login_required</div><div class="line">def edit_profile():</div><div class="line">    if form.validate_on_submit():</div><div class="line">        current_user.avatar = form.avatar.data</div><div class="line">        #...</div><div class="line">        return redirect(url_for(&apos;.user&apos;, name=current_user.name))</div><div class="line">    form.avatar.data = current_user.avatar</div><div class="line">    #...</div><div class="line"></div><div class="line">@main.route(&apos;/edit-profile/&lt;int:id&gt;&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">@login_required</div><div class="line">@admin_required</div><div class="line">def edit_profile_admin(id):</div><div class="line">    user = User.query.get_or_404(id)</div><div class="line">    form = EditProfileAdminForm(user=user)</div><div class="line">    if form.validate_on_submit():</div><div class="line">        user.avatar = form.avatar.data</div><div class="line">        #...</div><div class="line">        return redirect(url_for(&apos;.user&apos;, name=user.name))</div><div class="line">    form.avatar.data = user.avatar</div><div class="line">    #...</div></pre></td></tr></table></figure></p>
<p>然后在用户资料页面渲染<br>文件：<strong>app/templates/user.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;% if user.avatar %&#125;</div><div class="line">    &lt;img class=&quot;img-rounded profile-thumbnail&quot; src=&quot;&#123;&#123; user.avatar &#125;&#125;&quot; width=&quot;200px&quot; height=&quot;200px&quot;&gt;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/myblog-07/" data-id="cj5c7k3ap002em0u482lzm0e1" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-06" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/16/myblog-06/" class="article-date">
  <time datetime="2016-04-16T02:36:56.000Z" itemprop="datePublished">2016-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/16/myblog-06/">myblog-06 角色和权限</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="角色和权限"><a href="#角色和权限" class="headerlink" title="角色和权限"></a>角色和权限</h1><h2 id="角色在数据库中的表示"><a href="#角色在数据库中的表示" class="headerlink" title="角色在数据库中的表示"></a>角色在数据库中的表示</h2><p>常见的角色为用户和管理员，他们拥有不同的权限<br>在数据库模型中添加一个角色模型，针对不同角色给与不同权限<br>flag标识为True时，表示该角色为默认角色，只能有一个角色为True<br>Role通过relationship()与User关联</p>
<h3 id="用户角色数据库模型"><a href="#用户角色数据库模型" class="headerlink" title="用户角色数据库模型"></a>用户角色数据库模型</h3><p>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">class Role(db.Model):</div><div class="line">    __tablename__=&quot;roles&quot;</div><div class="line">    id = db.Column(db.Integer, primary_key=True)</div><div class="line">    name = db.Column(db.String(64), unique=True, index=True)</div><div class="line">    flag = db.Column(db.Boolean, default=False, index=True)</div><div class="line">    permissions = db.Column(db.Integer)</div><div class="line">    users = db.relationship(&apos;User&apos;, backref=&apos;role&apos;, lazy=&apos;dynamic&apos;)</div><div class="line"></div><div class="line">#...</div><div class="line"></div><div class="line">class User(UserMixin, db.Model):</div><div class="line">    __tablename__ = &apos;users&apos;</div><div class="line">    id = db.Column(db.Integer, primary_key=True)</div><div class="line">    email = db.Column(db.String(64), unique=True, index=True)</div><div class="line">    name = db.Column(db.String(64), unique=True, index=True)</div><div class="line">    password_hash = db.Column(db.String(128))</div><div class="line">    role_id = db.Column(db.Integer, db.ForeignKey(&apos;roles.id&apos;))</div><div class="line">    confirmed = db.Column(db.Boolean, default=False)</div></pre></td></tr></table></figure></p>
<h3 id="mysql数据库表属性"><a href="#mysql数据库表属性" class="headerlink" title="mysql数据库表属性"></a>mysql数据库表属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">mysql&gt; desc users;</div><div class="line">+---------------+------------+------+-----+---------+----------------+</div><div class="line">| Field         | Type       | Null | Key | Default | Extra          |</div><div class="line">+---------------+------------+------+-----+---------+----------------+</div><div class="line">| id            | int(32)    | NO   | PRI | NULL    | auto_increment |</div><div class="line">| email         | char(64)   | YES  | UNI | NULL    |                |</div><div class="line">| name          | char(64)   | YES  | UNI | NULL    |                |</div><div class="line">| password_hash | char(128)  | YES  |     | NULL    |                |</div><div class="line">| confirmed     | tinyint(1) | YES  |     | NULL    |                |</div><div class="line">| role_id       | int(32)    | YES  |     | NULL    |                |</div><div class="line">+---------------+------------+------+-----+---------+----------------+</div><div class="line"></div><div class="line">mysql&gt; desc roles;</div><div class="line">+-------------+------------+------+-----+---------+----------------+</div><div class="line">| Field       | Type       | Null | Key | Default | Extra          |</div><div class="line">+-------------+------------+------+-----+---------+----------------+</div><div class="line">| id          | int(32)    | NO   | PRI | NULL    | auto_increment |</div><div class="line">| name        | char(64)   | YES  | UNI | NULL    |                |</div><div class="line">| permissions | int(32)    | YES  |     | NULL    |                |</div><div class="line">| flag        | tinyint(1) | YES  |     | NULL    |                |</div><div class="line">+-------------+------------+------+-----+---------+----------------+</div></pre></td></tr></table></figure>
<h2 id="权限设置"><a href="#权限设置" class="headerlink" title="权限设置"></a>权限设置</h2><h3 id="程序的权限"><a href="#程序的权限" class="headerlink" title="程序的权限"></a>程序的权限</h3><table>
<thead>
<tr>
<th>操作</th>
<th>位值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>关注用户</td>
<td>0x01</td>
<td>关注其他用户</td>
</tr>
<tr>
<td>评论</td>
<td>0x02</td>
<td>在他人的文章中发表评论</td>
</tr>
<tr>
<td>写文章</td>
<td>0x04</td>
<td>自己写原创文章</td>
</tr>
<tr>
<td>管理他人评论</td>
<td>0x08</td>
<td>查处他人发表的不当评论</td>
</tr>
<tr>
<td>管理员</td>
<td>0x80</td>
<td>管理网站</td>
</tr>
</tbody>
</table>
<h3 id="代码表示权限"><a href="#代码表示权限" class="headerlink" title="代码表示权限"></a>代码表示权限</h3><p>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class Permission:</div><div class="line">    FOLLOW = 0x01</div><div class="line">    COMMENT = 0x02</div><div class="line">    WRITE_ARTICLES = 0x04</div><div class="line">    MODERATE_COMMENTS = 0x08</div><div class="line">    ADMINISTER = 0x80</div></pre></td></tr></table></figure></p>
<h3 id="拥有不同权限的角色"><a href="#拥有不同权限的角色" class="headerlink" title="拥有不同权限的角色"></a>拥有不同权限的角色</h3><table>
<thead>
<tr>
<th>角色</th>
<th>权限</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>匿名</td>
<td>0x00</td>
<td>没有登录的用户，只有阅读权限</td>
</tr>
<tr>
<td>用户</td>
<td>0x07</td>
<td>正常用户，拥有管理以外的权限</td>
</tr>
<tr>
<td>协管员</td>
<td>0x0f</td>
<td>具有审查评论的权限</td>
</tr>
<tr>
<td>管理员</td>
<td>0xff</td>
<td>拥有所有权限</td>
</tr>
</tbody>
</table>
<h2 id="在数据库中创建角色"><a href="#在数据库中创建角色" class="headerlink" title="在数据库中创建角色"></a>在数据库中创建角色</h2><p>自动添加角色<br>roles字典内容有两个参数，一个参数是对应的权限相或(加)，另一个参数是flag，表示是否为默认角色<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">class Role(db.Model):</div><div class="line">    </div><div class="line">    #...</div><div class="line">    @staticmethod</div><div class="line">    def insert_roles():</div><div class="line">        roles = &#123;</div><div class="line">            &apos;User&apos;: (Permission.FOLLOW |</div><div class="line">                     Permission.COMMENT |</div><div class="line">                     Permission.WRITE_ARTICLES, True),</div><div class="line">            &apos;Moderator&apos;: (Permission.FOLLOW |</div><div class="line">                          Permission.COMMENT |</div><div class="line">                          Permission.WRITE_ARTICLES |</div><div class="line">                          Permission.MODERATE_COMMENTS, False),</div><div class="line">            &apos;Administrator&apos;: (0xff, False)</div><div class="line">        &#125;</div><div class="line">        for r in roles:</div><div class="line">            role = Role.query.filter_by(name=r).first()</div><div class="line">            if role is None:</div><div class="line">                role = Role(name=r)</div><div class="line">            role.permissions = roles[r][0]</div><div class="line">            role.flag = roles[r][1]</div><div class="line">            db.session.add(role)</div><div class="line">        db.session.commit()</div></pre></td></tr></table></figure></p>
<p>通过shell会话把角色加入数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(venv) $ python manage.py shell</div><div class="line">&gt;&gt;&gt; Role.insert_roles()</div><div class="line">&gt;&gt;&gt; Role.query.all()</div><div class="line">[&lt;Role u&apos;Administrator&apos;&gt;, &lt;Role u&apos;User&apos;&gt;, &lt;Role u&apos;Moderator&apos;&gt;]</div></pre></td></tr></table></figure></p>
<h2 id="赋予角色"><a href="#赋予角色" class="headerlink" title="赋予角色"></a>赋予角色</h2><p>在用户注册时赋予用户角色，通过环境变量读取<strong>FLASKY_ADMIN</strong>获得管理员电子邮件<br>如果注册的是管理员，则拥有管理员权限，否则为设置的默认角色<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">class User(UserMixin, db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    def __init__(self, **kwargs):</div><div class="line">        super(User, self).__init__(**kwargs)</div><div class="line">        if self.role is None:</div><div class="line">            if self.email == current_app.config[&apos;FLASKY_ADMIN&apos;]:</div><div class="line">                self.role = Role.query.filter_by(permissions=0xff).first()</div><div class="line">            if self.role is None:</div><div class="line">                self.role = Role.query.filter_by(flag=True).first()</div></pre></td></tr></table></figure></p>
<h2 id="角色验证"><a href="#角色验证" class="headerlink" title="角色验证"></a>角色验证</h2><h3 id="检查角色权限的函数"><a href="#检查角色权限的函数" class="headerlink" title="检查角色权限的函数"></a>检查角色权限的函数</h3><p>AnonymousUser类表示未登录的用户，所以不用检查用户是否登录，可以直接调用<strong>current_user.can()</strong><br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">from flask.ext.login import UserMixin, AnonymousUserMixin</div><div class="line"></div><div class="line">class User(UserMixin, db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    def can(self, permissions):</div><div class="line">        return self.role is not None and \</div><div class="line">            (self.role.permissions &amp; permissions) == permissions</div><div class="line"></div><div class="line">    def is_administrator(self):</div><div class="line">        return self.can(Permission.ADMINISTER)</div><div class="line"></div><div class="line">class AnonymousUser(AnonymousUserMixin):</div><div class="line">    def can(self, permissions):</div><div class="line">        return False</div><div class="line"></div><div class="line">    def is_administrator(self):</div><div class="line">        return False</div></pre></td></tr></table></figure></p>
<h3 id="检查用户权限的修饰器"><a href="#检查用户权限的修饰器" class="headerlink" title="检查用户权限的修饰器"></a>检查用户权限的修饰器</h3><p>两个修饰器都使用Python标准库的functools包<br>如果用户不具有指定权限，则返回403错误码<br>需要添加403.html文件和相应路由<br>文件：<strong>app/decorators.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">from functools import wraps</div><div class="line">from flask import abort</div><div class="line">from flask.ext.login import current_user</div><div class="line"></div><div class="line">from .models import Permission</div><div class="line"></div><div class="line"></div><div class="line">def permission_required(permission):</div><div class="line">    def decorator(f):</div><div class="line">        @wraps(f)</div><div class="line">        def decorated_function(*args, **kwargs):</div><div class="line">            if not current_user.can(permission):</div><div class="line">                abort(403)</div><div class="line">            return f(*args, **kwargs)</div><div class="line">        return decorated_function</div><div class="line">    return decorator</div><div class="line"></div><div class="line"></div><div class="line">def admin_required(f):</div><div class="line">    return permission_required(Permission.ADMINISTER)(f)</div></pre></td></tr></table></figure></p>
<p>用法如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">from decorators import admin_required, permission_required</div><div class="line">from .models import Permission</div><div class="line"></div><div class="line">@main.route(&apos;/admin&apos;)</div><div class="line">@login_required</div><div class="line">@admin_required</div><div class="line">def for_admins_only():</div><div class="line">    return &quot;For administrators!&quot;</div><div class="line"></div><div class="line">@main.route(&apos;/moderator&apos;)</div><div class="line">@login_required</div><div class="line">@permission_required(Permission.MODERATE_COMMENTS)</div><div class="line">def for_moderators_only():</div><div class="line">    return &quot;For comment moderators!&quot;</div></pre></td></tr></table></figure></p>
<p>Permission类加入模板上下文<br>文件：<strong>app/main/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from ..models import Permission</div><div class="line"></div><div class="line">@main.app_context_processor</div><div class="line">def inject_permissions():</div><div class="line">    return dict(Permission=Permission)</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/16/myblog-06/" data-id="cj5c7k3aj0029m0u4g448ogeo" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-05" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/15/myblog-05/" class="article-date">
  <time datetime="2016-04-15T11:53:37.000Z" itemprop="datePublished">2016-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/15/myblog-05/">myblog-05 管理账户</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="管理账户"><a href="#管理账户" class="headerlink" title="管理账户"></a>管理账户</h1><h2 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h2><p>在登录的前提下，提供修改密码的功能</p>
<h3 id="添加表单"><a href="#添加表单" class="headerlink" title="添加表单"></a>添加表单</h3><p>文件：<strong>app/auth/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class ChangePasswordForm(Form):</div><div class="line">    old_password = PasswordField(&apos;Old password&apos;, validators=[Required()])</div><div class="line">    password = PasswordField(&apos;New password&apos;, validators=[</div><div class="line">        Required(), EqualTo(&apos;password2&apos;, message=&apos;Passwords must match&apos;)])</div><div class="line">    password2 = PasswordField(&apos;Confirm new password&apos;, validators=[Required()])</div><div class="line">    submit = SubmitField(&apos;Update Password&apos;)</div></pre></td></tr></table></figure></p>
<h3 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h3><p>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">from .forms import ChangePasswordForm</div><div class="line"></div><div class="line">@auth.route(&apos;/change-password&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">@login_required</div><div class="line">def change_password():</div><div class="line">    form = ChangePasswordForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        if current_user.verify_password(form.old_password.data):</div><div class="line">            current_user.password = form.password.data</div><div class="line">            db.session.add(current_user)</div><div class="line">            flash(&apos;Your password has been updated.&apos;)</div><div class="line">            return redirect(url_for(&apos;main.index&apos;))</div><div class="line">        else:</div><div class="line">            flash(&apos;Invalid password.&apos;)</div><div class="line">    return render_template(&quot;auth/change_password.html&quot;, form=form)</div></pre></td></tr></table></figure></p>
<h3 id="编写页面"><a href="#编写页面" class="headerlink" title="编写页面"></a>编写页面</h3><p>文件：<strong>app/templates/auth/change_password.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Change Password&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Change Your Password&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div class=&quot;col-md-4&quot;&gt;</div><div class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h3 id="添加改变密码的标签"><a href="#添加改变密码的标签" class="headerlink" title="添加改变密码的标签"></a>添加改变密码的标签</h3><p>提供一个菜单，可以选择登出或者更改密码<br>文件 <strong>app/templates/base.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;% if current_user.is_authenticated %&#125;</div><div class="line">&lt;li class=&quot;dropdown&quot;&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;Account &lt;b class=&quot;caret&quot;&gt;&lt;/b&gt;&lt;/a&gt;</div><div class="line">    &lt;ul class=&quot;dropdown-menu&quot;&gt;</div><div class="line">        &lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;auth.change_password&apos;) &#125;&#125;&quot;&gt;Change Password&lt;/a&gt;&lt;/li&gt;</div><div class="line">        &lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;auth.logout&apos;) &#125;&#125;&quot;&gt;Log Out&lt;/a&gt;&lt;/li&gt;</div><div class="line">    &lt;/ul&gt;</div><div class="line">&lt;/li&gt;</div><div class="line">&#123;% else %&#125;</div><div class="line">&lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;auth.login&apos;) &#125;&#125;&quot;&gt;Log In&lt;/a&gt;&lt;/li&gt;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure></p>
<h2 id="忘记密码"><a href="#忘记密码" class="headerlink" title="忘记密码"></a>忘记密码</h2><p>使用邮件令牌提供给用户修改密码</p>
<h3 id="添加表单-1"><a href="#添加表单-1" class="headerlink" title="添加表单"></a>添加表单</h3><p>提供两个表单，一个用于输入需要重置密码的邮件地址，另一个用于通过邮件确认后给与用户重置密码<br>文件：<strong>app/auth/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">class PasswordResetRequestForm(Form):</div><div class="line">    email = StringField(&apos;Email&apos;, validators=[Required(), Length(1, 64),</div><div class="line">                                             Email()])</div><div class="line">    submit = SubmitField(&apos;Reset Password&apos;)</div><div class="line"></div><div class="line"></div><div class="line">class PasswordResetForm(Form):</div><div class="line">    email = StringField(&apos;Email&apos;, validators=[Required(), Length(1, 64),</div><div class="line">                                             Email()])</div><div class="line">    password = PasswordField(&apos;New Password&apos;, validators=[</div><div class="line">        Required(), EqualTo(&apos;password2&apos;, message=&apos;Passwords must match&apos;)])</div><div class="line">    password2 = PasswordField(&apos;Confirm password&apos;, validators=[Required()])</div><div class="line">    submit = SubmitField(&apos;Reset Password&apos;)</div><div class="line"></div><div class="line">    def validate_email(self, field):</div><div class="line">        if User.query.filter_by(email=field.data).first() is None:</div><div class="line">            raise ValidationError(&apos;Unknown email address.&apos;)</div></pre></td></tr></table></figure></p>
<h3 id="编写页面-1"><a href="#编写页面-1" class="headerlink" title="编写页面"></a>编写页面</h3><p>在登录界面提供重置密码的链接<br>文件：<strong>app/templates/auth/login.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;Forgot your password? </div><div class="line">    &lt;a href=&quot;&#123;&#123; url_for(&apos;auth.password_reset_request&apos;) &#125;&#125;&quot;&gt;Click here to reset it&lt;/a&gt;.</div><div class="line">&lt;/p&gt;</div></pre></td></tr></table></figure></p>
<p>显示给用户，用来输入邮件，或者重置密码<br>文件：<strong>app/templates/auth/reset_password.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Password Reset&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Reset Your Password&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div class=&quot;col-md-4&quot;&gt;</div><div class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h3 id="视图函数-1"><a href="#视图函数-1" class="headerlink" title="视图函数"></a>视图函数</h3><p>视图函数提供两个路由，一个提供重置密码的链接，另一个是邮件发送给用户的链接<br>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">from .forms import PasswordResetRequestForm, PasswordResetForm</div><div class="line"></div><div class="line">@auth.route(&apos;/reset&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def password_reset_request():</div><div class="line">    if not current_user.is_anonymous:</div><div class="line">        return redirect(url_for(&apos;main.index&apos;))</div><div class="line">    form = PasswordResetRequestForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        user = User.query.filter_by(email=form.email.data).first()</div><div class="line">        if user:</div><div class="line">            token = user.generate_reset_token()</div><div class="line">            send_email(user.email, &apos;Reset Your Password&apos;,</div><div class="line">                       &apos;auth/email/reset_password&apos;,</div><div class="line">                       user=user, token=token,</div><div class="line">                       next=request.args.get(&apos;next&apos;))</div><div class="line">        flash(&apos;An email with instructions to reset your password has been &apos;</div><div class="line">              &apos;sent to you.&apos;)</div><div class="line">        return redirect(url_for(&apos;auth.login&apos;))</div><div class="line">    return render_template(&apos;auth/reset_password.html&apos;, form=form)</div><div class="line"></div><div class="line"></div><div class="line">@auth.route(&apos;/reset/&lt;token&gt;&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def password_reset(token):</div><div class="line">    if not current_user.is_anonymous:</div><div class="line">        return redirect(url_for(&apos;main.index&apos;))</div><div class="line">    form = PasswordResetForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        user = User.query.filter_by(email=form.email.data).first()</div><div class="line">        if user is None:</div><div class="line">            return redirect(url_for(&apos;main.index&apos;))</div><div class="line">        if user.reset_password(token, form.password.data):</div><div class="line">            flash(&apos;Your password has been updated.&apos;)</div><div class="line">            return redirect(url_for(&apos;auth.login&apos;))</div><div class="line">        else:</div><div class="line">            return redirect(url_for(&apos;main.index&apos;))</div><div class="line">    return render_template(&apos;auth/reset_password.html&apos;, form=form)</div></pre></td></tr></table></figure></p>
<h3 id="用户添加重置密码功能"><a href="#用户添加重置密码功能" class="headerlink" title="用户添加重置密码功能"></a>用户添加重置密码功能</h3><p>文件：<strong>models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">def generate_reset_token(self, expiration=3600):</div><div class="line">    s = Serializer(current_app.config[&apos;SECRET_KEY&apos;], expiration)</div><div class="line">    return s.dumps(&#123;&apos;reset&apos;: self.id&#125;)</div><div class="line"></div><div class="line">def reset_password(self, token, new_password):</div><div class="line">    s = Serializer(current_app.config[&apos;SECRET_KEY&apos;])</div><div class="line">    try:</div><div class="line">        data = s.loads(token)</div><div class="line">    except:</div><div class="line">        return False</div><div class="line">    if data.get(&apos;reset&apos;) != self.id:</div><div class="line">        return False</div><div class="line">    self.password = new_password</div><div class="line">    db.session.add(self)</div><div class="line">    return True</div></pre></td></tr></table></figure></p>
<h3 id="邮件内容"><a href="#邮件内容" class="headerlink" title="邮件内容"></a>邮件内容</h3><p>文件：<strong>app/templates/auth/email/reset_password.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;Dear &#123;&#123; user.name &#125;&#125;,&lt;/p&gt;</div><div class="line">&lt;p&gt;Welcome to &lt;b&gt;Harry&apos;s blog&lt;/b&gt;!&lt;/p&gt;</div><div class="line">&lt;p&gt;To confirm your account please &lt;a href=&quot;&#123;&#123; url_for(&apos;auth.confirm&apos;, token=token, _external=True) &#125;&#125;&quot;&gt;click here&lt;/a&gt;.&lt;/p&gt;</div><div class="line">&lt;p&gt;Alternatively, you can paste the following link in your browser&apos;s address bar:&lt;/p&gt;</div><div class="line">&lt;p&gt;&#123;&#123; url_for(&apos;auth.confirm&apos;, token=token, _external=True) &#125;&#125;&lt;/p&gt;</div><div class="line">&lt;p&gt;Sincerely,&lt;/p&gt;</div><div class="line">&lt;p&gt;Harry&lt;/p&gt;</div><div class="line">&lt;p&gt;&lt;small&gt;Note: replies to this email address are not monitored.&lt;/small&gt;&lt;/p&gt;</div></pre></td></tr></table></figure></p>
<p>文件：<strong>app/templates/auth/email/reset_password.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Dear &#123;&#123; user.name &#125;&#125;,</div><div class="line"></div><div class="line">To reset your password click on the following link:</div><div class="line"></div><div class="line">&#123;&#123; url_for(&apos;auth.password_reset&apos;, token=token, _external=True) &#125;&#125;</div><div class="line"></div><div class="line">If you have not requested a password reset simply ignore this message.</div><div class="line"></div><div class="line">Sincerely,</div><div class="line"></div><div class="line">Harry</div><div class="line"></div><div class="line">Note: replies to this email address are not monitored.</div></pre></td></tr></table></figure></p>
<h2 id="修改邮件地址"><a href="#修改邮件地址" class="headerlink" title="修改邮件地址"></a>修改邮件地址</h2><p>修改邮件地址前，需要向新邮件地址发送确认邮件</p>
<h3 id="添加表单-2"><a href="#添加表单-2" class="headerlink" title="添加表单"></a>添加表单</h3><p>文件：<strong>app/auth/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">class ChangeEmailForm(Form):</div><div class="line">    email = StringField(&apos;New Email&apos;, validators=[Required(), Length(1, 64),</div><div class="line">                                                 Email()])</div><div class="line">    password = PasswordField(&apos;Password&apos;, validators=[Required()])</div><div class="line">    submit = SubmitField(&apos;Update Email Address&apos;)</div><div class="line"></div><div class="line">    def validate_email(self, field):</div><div class="line">        if User.query.filter_by(email=field.data).first():</div><div class="line">            raise ValidationError(&apos;Email already registered.&apos;)</div></pre></td></tr></table></figure></p>
<h3 id="用户模型添加更改邮件功能"><a href="#用户模型添加更改邮件功能" class="headerlink" title="用户模型添加更改邮件功能"></a>用户模型添加更改邮件功能</h3><p>文件：<strong>models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">def generate_email_change_token(self, new_email, expiration=3600):</div><div class="line">    s = Serializer(current_app.config[&apos;SECRET_KEY&apos;], expiration)</div><div class="line">    return s.dumps(&#123;&apos;change_email&apos;: self.id, &apos;new_email&apos;: new_email&#125;)</div><div class="line"></div><div class="line">def change_email(self, token):</div><div class="line">    s = Serializer(current_app.config[&apos;SECRET_KEY&apos;])</div><div class="line">    try:</div><div class="line">        data = s.loads(token)</div><div class="line">    except:</div><div class="line">        return False</div><div class="line">    if data.get(&apos;change_email&apos;) != self.id:</div><div class="line">        return False</div><div class="line">    new_email = data.get(&apos;new_email&apos;)</div><div class="line">    if new_email is None:</div><div class="line">        return False</div><div class="line">    if self.query.filter_by(email=new_email).first() is not None:</div><div class="line">        return False</div><div class="line">    self.email = new_email</div><div class="line">    db.session.add(self)</div><div class="line">    return True</div></pre></td></tr></table></figure></p>
<h3 id="编写页面-2"><a href="#编写页面-2" class="headerlink" title="编写页面"></a>编写页面</h3><p>文件：<strong>app/templates/auth/login.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Change Email Address&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Change Your Email Address&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div class=&quot;col-md-4&quot;&gt;</div><div class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h3 id="添加改变邮件的标签"><a href="#添加改变邮件的标签" class="headerlink" title="添加改变邮件的标签"></a>添加改变邮件的标签</h3><p>提供一个菜单，可以选择修改邮件地址<br>文件 <strong>app/templates/base.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;auth.change_email_request&apos;) &#125;&#125;&quot;&gt;Change Email&lt;/a&gt;&lt;/li&gt;</div></pre></td></tr></table></figure></p>
<h3 id="编写视图函数"><a href="#编写视图函数" class="headerlink" title="编写视图函数"></a>编写视图函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">from .forms import ChangeEmailForm</div><div class="line"></div><div class="line">@auth.route(&apos;/change-email&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">@login_required</div><div class="line">def change_email_request():</div><div class="line">    form = ChangeEmailForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        if current_user.verify_password(form.password.data):</div><div class="line">            new_email = form.email.data</div><div class="line">            token = current_user.generate_email_change_token(new_email)</div><div class="line">            send_email(new_email, &apos;Confirm your email address&apos;,</div><div class="line">                       &apos;auth/email/change_email&apos;,</div><div class="line">                       user=current_user, token=token)</div><div class="line">            flash(&apos;An email with instructions to confirm your new email &apos;</div><div class="line">                  &apos;address has been sent to you.&apos;)</div><div class="line">            return redirect(url_for(&apos;main.index&apos;))</div><div class="line">        else:</div><div class="line">            flash(&apos;Invalid email or password.&apos;)</div><div class="line">    return render_template(&quot;auth/change_email.html&quot;, form=form)</div><div class="line"></div><div class="line"></div><div class="line">@auth.route(&apos;/change-email/&lt;token&gt;&apos;)</div><div class="line">@login_required</div><div class="line">def change_email(token):</div><div class="line">    if current_user.change_email(token):</div><div class="line">        flash(&apos;Your email address has been updated.&apos;)</div><div class="line">    else:</div><div class="line">        flash(&apos;Invalid request.&apos;)</div><div class="line">    return redirect(url_for(&apos;main.index&apos;))</div></pre></td></tr></table></figure>
<h3 id="编写邮件内容"><a href="#编写邮件内容" class="headerlink" title="编写邮件内容"></a>编写邮件内容</h3><p>文件：<strong>app/templates/auth/email/change_email.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;Dear &#123;&#123; user.name &#125;&#125;,&lt;/p&gt;</div><div class="line">&lt;p&gt;To confirm your new email address &lt;a href=&quot;&#123;&#123; url_for(&apos;auth.change_email&apos;, token=token, _external=True) &#125;&#125;&quot;&gt;click here&lt;/a&gt;.&lt;/p&gt;</div><div class="line">&lt;p&gt;Alternatively, you can paste the following link in your browser&apos;s address bar:&lt;/p&gt;</div><div class="line">&lt;p&gt;&#123;&#123; url_for(&apos;auth.change_email&apos;, token=token, _external=True) &#125;&#125;&lt;/p&gt;</div><div class="line">&lt;p&gt;Sincerely,&lt;/p&gt;</div><div class="line">&lt;p&gt;Harry&lt;/p&gt;</div><div class="line">&lt;p&gt;&lt;small&gt;Note: replies to this email address are not monitored.&lt;/small&gt;&lt;/p&gt;</div></pre></td></tr></table></figure></p>
<p>文件：<strong>app/templates/auth/email/change_email.txt</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Dear &#123;&#123; user.name &#125;&#125;,</div><div class="line"></div><div class="line">To confirm your new email address click on the following link:</div><div class="line"></div><div class="line">&#123;&#123; url_for(&apos;auth.change_email&apos;, token=token, _external=True) &#125;&#125;</div><div class="line"></div><div class="line">Sincerely,</div><div class="line"></div><div class="line">Harry</div><div class="line"></div><div class="line">Note: replies to this email address are not monitored.</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/15/myblog-05/" data-id="cj5c7k3ag0026m0u4s0h9a0ae" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-04" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/14/myblog-04/" class="article-date">
  <time datetime="2016-04-14T02:38:49.000Z" itemprop="datePublished">2016-04-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/14/myblog-04/">myblog-04 用户注册</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="电子邮件"><a href="#电子邮件" class="headerlink" title="电子邮件"></a>电子邮件</h1><p><a href="http://herui.blog-harryx.cn/2016/03/13/flask-send-mail/" target="_blank" rel="external">邮件配置参数</a></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>QQ邮箱的发送邮件服务器和端口：<strong>smtp.qq.com ，使用SSL，端口号465</strong><br>密码要从环境中导入，避免直接写入脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">import os</div><div class="line"></div><div class="line">app.config[&apos;MAIL_SERVER&apos;] = &apos;smtp.qq.com&apos;</div><div class="line">app.config[&apos;MAIL_PORT&apos;] = 587</div><div class="line">app.config[&apos;MAIL_USE_TLS&apos;] = True</div><div class="line">app.config[&apos;MAIL_USERNAME&apos;] = os.environ.get(&apos;MAIL_USERNAME&apos;)</div><div class="line">app.config[&apos;MAIL_PASSWORD&apos;] = os.environ.get(&apos;MAIL_PASSWORD&apos;)</div></pre></td></tr></table></figure></p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">from flask.ext.mail import Mail</div><div class="line">mail = Mail(app)</div></pre></td></tr></table></figure>
<h3 id="集成发送邮件功能"><a href="#集成发送邮件功能" class="headerlink" title="集成发送邮件功能"></a>集成发送邮件功能</h3><p>异步发送邮件<br>文件：app/email.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">from threading import Thread</div><div class="line">from flask import current_app, render_template</div><div class="line">from flask.ext.mail import Message</div><div class="line"></div><div class="line">app.config[&apos;FLASKY_MAIL_SUBJECT_PREFIX&apos;] = &apos;[Harry]&apos;</div><div class="line">app.config[&apos;FLASKY_MAIL_SENDER&apos;] = &apos;harryx520@qq.com&apos;</div><div class="line"></div><div class="line">def send_async_email(app, msg):</div><div class="line">    with app.app_context():</div><div class="line">        mail.send(msg)</div><div class="line"></div><div class="line">def send_email(to, subject, template, **kwargs):</div><div class="line">    app = current_app._get_current_object()</div><div class="line">    msg = Message(app.config[&apos;FLASKY_MAIL_SUBJECT_PREFIX&apos;] + &apos; &apos; + subject,</div><div class="line">                  sender=app.config[&apos;FLASKY_MAIL_SENDER&apos;], recipients=[to])</div><div class="line">    msg.body = render_template(template + &apos;.txt&apos;, **kwargs)</div><div class="line">    msg.html = render_template(template + &apos;.html&apos;, **kwargs)</div><div class="line">    thr = Thread(target=send_async_email, args=[app, msg])</div><div class="line">    thr.start()</div><div class="line">    return thr</div></pre></td></tr></table></figure></p>
<h1 id="注册用户"><a href="#注册用户" class="headerlink" title="注册用户"></a>注册用户</h1><h2 id="建立表单"><a href="#建立表单" class="headerlink" title="建立表单"></a>建立表单</h2><p>文件：app/auth/forms.py<br>Regexp提供验证函数，确保username字段合法<br>EqualTo实验密码的第二次输入核对<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">from flask.ext.wtf import Form</div><div class="line">from wtforms import StringField, PasswordField, BooleanField, SubmitField</div><div class="line">from wtforms.validators import Required, Length, Email, Regexp, EqualTo</div><div class="line">from wtforms import ValidationError</div><div class="line"></div><div class="line">from ..models import User</div><div class="line"></div><div class="line">class RegistrationForm(Form):</div><div class="line">    email = StringField(&apos;Email&apos;, validators=[Required(), Length(1, 64),</div><div class="line">                                           Email()])</div><div class="line">    name = StringField(&apos;name&apos;, validators=[</div><div class="line">        Required(), Length(1, 64), Regexp(&apos;^[A-Za-z][A-Za-z0-9_.]*$&apos;, 0,</div><div class="line">                                          &apos;Names must have only letters, &apos;</div><div class="line">                                          &apos;numbers, dots or underscores&apos;)])</div><div class="line">    password = PasswordField(&apos;Password&apos;, validators=[</div><div class="line">        Required(), EqualTo(&apos;password2&apos;, message=&apos;Passwords must match.&apos;)])</div><div class="line">    password2 = PasswordField(&apos;Confirm password&apos;, validators=[Required()])</div><div class="line">    submit = SubmitField(&apos;Register&apos;)</div><div class="line"></div><div class="line">    def validate_email(self, field):</div><div class="line">        if User.query.filter_by(email=field.data).first():</div><div class="line">            raise ValidationError(&apos;Email already registered.&apos;)</div><div class="line"></div><div class="line">    def validate_name(self, field):</div><div class="line">        if User.query.filter_by(name=field.data).first():</div><div class="line">            raise ValidationError(&apos;Name already in use.&apos;)</div></pre></td></tr></table></figure></p>
<p>注册页面：<strong>app/templates/auth/register.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Flasky - Register&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Register&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div class=&quot;col-md-4&quot;&gt;</div><div class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>登录页面添加到注册页面的链接<br>文件：<strong>app/templates/auth/login.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;New user? &lt;a href=&quot;&#123;&#123; url_for(&apos;auth.register&apos;) &#125;&#125;&quot;&gt;Click here to register&lt;/a&gt;.&lt;/p&gt;</div></pre></td></tr></table></figure></p>
<h2 id="编写视图函数"><a href="#编写视图函数" class="headerlink" title="编写视图函数"></a>编写视图函数</h2><p>文件：app/auth/views.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">from flask import render_template, redirect, request, url_for, flash</div><div class="line">from flask.ext.login import login_user, logout_user, login_required,current_user</div><div class="line"></div><div class="line">from . import auth</div><div class="line">from .. import db</div><div class="line">from ..models import User</div><div class="line">from ..email import send_email</div><div class="line">from .forms import LoginForm,RegistrationForm</div><div class="line"></div><div class="line">@auth.route(&apos;/register&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def register():</div><div class="line">    form = RegistrationForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        user = User(email=form.email.data,</div><div class="line">                    name=form.name.data,</div><div class="line">                    password=form.password.data)</div><div class="line">        db.session.add(user)</div><div class="line">        flash(&apos;You can now login.&apos;)</div><div class="line">        return redirect(url_for(&apos;auth.login&apos;))</div><div class="line">    return render_template(&apos;auth/register.html&apos;, form=form)</div></pre></td></tr></table></figure></p>
<h2 id="确认账户"><a href="#确认账户" class="headerlink" title="确认账户"></a>确认账户</h2><p>证明用户注册时提供的邮箱是本人邮箱</p>
<h3 id="使用itsdangerous生成确认令牌"><a href="#使用itsdangerous生成确认令牌" class="headerlink" title="使用itsdangerous生成确认令牌"></a>使用itsdangerous生成确认令牌</h3><p>确认邮件发送<a href="http://example.com/auth/config/id这种形式的URL，其中id是数据库分配给用户的id" target="_blank" rel="external">http://example.com/auth/config/id这种形式的URL，其中id是数据库分配给用户的id</a><br>安全的做法是将URL中的id换成相同信息安全加密后得到的令牌<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; from manage import app</div><div class="line">&gt;&gt;&gt; from itsdangerous import TimedJSONWebSignatureSerializer as Serializer</div><div class="line"></div><div class="line">#生成具有过期时间的JSON Web签名</div><div class="line">&gt;&gt;&gt; s = Serializer(app.config[&apos;SECRET_KEY&apos;], expires_in = 3600)</div><div class="line"></div><div class="line">#为指定数据生成一个加密签名</div><div class="line">&gt;&gt;&gt; token = s.dumps(&#123; &apos;confirm&apos;: 23 &#125;)</div><div class="line">&gt;&gt;&gt; token</div><div class="line">&apos;eyJhbGciOiJIUzI1NiIsImV4(...)30.UxML4AVrfSx6Mz0-hLzp5hy6Qayoht5J78IDr_-NNug&apos;</div><div class="line"></div><div class="line">#解码令牌，这个指令会检验签名和过期时间，如果通过，返回原始数据</div><div class="line">&gt;&gt;&gt; data = s.loads(token)</div><div class="line">&gt;&gt;&gt; data</div><div class="line">&#123;u&apos;confirm&apos;: 23&#125;</div></pre></td></tr></table></figure></p>
<p>generate_confirmation_token()生成一个令牌，有效期为1小时<br>confirm()检验令牌与用户是否匹配<br>更新用户模型后要进行一次数据库更新</p>
<h3 id="在用户模型中添加确认令牌的功能"><a href="#在用户模型中添加确认令牌的功能" class="headerlink" title="在用户模型中添加确认令牌的功能"></a>在用户模型中添加确认令牌的功能</h3><p>文件：app/models.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">from itsdangerous import TimedJSONWebSignatureSerializer as Serializer</div><div class="line">from flask import current_app</div><div class="line"></div><div class="line">class User(UserMixin, db.Model):</div><div class="line"></div><div class="line">    #...</div><div class="line">    confirmed = db.Column(db.Boolean, default=False)</div><div class="line"></div><div class="line">    def generate_confirmation_token(self, expiration=3600):</div><div class="line">        s = Serializer(current_app.config[&apos;SECRET_KEY&apos;], expiration)</div><div class="line">        return s.dumps(&#123;&apos;confirm&apos;: self.id&#125;)</div><div class="line"></div><div class="line">    def confirm(self, token):</div><div class="line">        s = Serializer(current_app.config[&apos;SECRET_KEY&apos;])</div><div class="line">        try:</div><div class="line">            data = s.loads(token)</div><div class="line">        except:</div><div class="line">            return False</div><div class="line">        if data.get(&apos;confirm&apos;) != self.id:</div><div class="line">            return False</div><div class="line">        self.confirmed = True</div><div class="line">        db.session.add(self)</div><div class="line">        return True</div></pre></td></tr></table></figure></p>
<h3 id="发送确认邮件"><a href="#发送确认邮件" class="headerlink" title="发送确认邮件"></a>发送确认邮件</h3><p>当/register路由把用户添加到数据库时，会重定向到/index，在重定向之前，这个路由需要发送确认邮件<br>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@auth.route(&apos;/register&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def register():</div><div class="line">    form = RegistrationForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        user = User(email=form.email.data,</div><div class="line">                    name=form.name.data,</div><div class="line">                    password=form.password.data)</div><div class="line">        db.session.add(user)</div><div class="line">        db.session.commit()</div><div class="line">        token = user.generate_confirmation_token()</div><div class="line">        send_email(user.email, &apos;Confirm Your Account&apos;,</div><div class="line">                   &apos;auth/email/confirm&apos;, user=user, token=token)</div><div class="line">        flash(&apos;Please confirm the email!&apos;)</div><div class="line">        return redirect(url_for(&apos;auth.login&apos;))</div><div class="line">    return render_template(&apos;auth/register.html&apos;, form=form)</div></pre></td></tr></table></figure></p>
<h3 id="添加邮件文本"><a href="#添加邮件文本" class="headerlink" title="添加邮件文本"></a>添加邮件文本</h3><p>使用_external=True参数，指定使用绝对URL<br>文件：<strong>app/templates/auth/email/condirm.txt</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Dear &#123;&#123; user.name &#125;&#125;,</div><div class="line"></div><div class="line">Welcome to Harry&apos;s blog!</div><div class="line"></div><div class="line">To confirm your account please click on the following link:</div><div class="line"></div><div class="line">&#123;&#123; url_for(&apos;auth.confirm&apos;, token=token, _external=True) &#125;&#125;</div><div class="line"></div><div class="line">Sincerely</div></pre></td></tr></table></figure></p>
<h3 id="确认用户视图函数"><a href="#确认用户视图函数" class="headerlink" title="确认用户视图函数"></a>确认用户视图函数</h3><p>Flask-Login提供的login_required修饰器会保护这个路由<br>用户点击邮件中的链接后要先登录，才能执行这个视图函数<br>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">from flask.ext.login import current_user</div><div class="line"></div><div class="line">@auth.route(&apos;/confirm/&lt;token&gt;&apos;)</div><div class="line">@login_required</div><div class="line">def confirm(token):</div><div class="line">    if current_user.confirmed:</div><div class="line">        return redirect(url_for(&apos;main.index&apos;))</div><div class="line">    if current_user.confirm(token):</div><div class="line">        flash(&apos;You have confirmed your account. Thanks!&apos;)</div><div class="line">    else:</div><div class="line">        flash(&apos;The confirmation link is invalid or has expired.&apos;)</div><div class="line">    return redirect(url_for(&apos;main.index&apos;))</div></pre></td></tr></table></figure></p>
<h3 id="处理没有确认的账户"><a href="#处理没有确认的账户" class="headerlink" title="处理没有确认的账户"></a>处理没有确认的账户</h3><p>当满足以下三个条件时，before_app_request处理程序会拦截请求</p>
<p>1 . 用户已登录(<strong>current_user.is_authenticated()</strong> 必须返回 True)<br>2 . 用户账户没有确认<br>3 . 请求的端点不在认证蓝本中，访问认证路由要获取权限</p>
<p>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@auth.before_app_request</div><div class="line">def before_request():</div><div class="line">    if current_user.is_authenticated \</div><div class="line">            and not current_user.confirmed \</div><div class="line">            and request.endpoint[:5] != &apos;auth.&apos; \</div><div class="line">            and request.endpoint != &apos;static&apos;:</div><div class="line">        return redirect(url_for(&apos;auth.unconfirmed&apos;))</div><div class="line"></div><div class="line">@auth.route(&apos;/unconfirmed&apos;)</div><div class="line">def unconfirmed():</div><div class="line">    if current_user.is_anonymous or current_user.confirmed:</div><div class="line">        return redirect(url_for(&apos;main.index&apos;))</div><div class="line">    return render_template(&apos;auth/unconfirmed.html&apos;)</div></pre></td></tr></table></figure></p>
<h3 id="重新发送账户确认邮件"><a href="#重新发送账户确认邮件" class="headerlink" title="重新发送账户确认邮件"></a>重新发送账户确认邮件</h3><p>显示给未确认用户的页面有一个再次发送确认邮件的链接<br>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@auth.route(&apos;/confirm&apos;)</div><div class="line">@login_required</div><div class="line">def resend_confirmation():</div><div class="line">    token = current_user.generate_confirmation_token()</div><div class="line">    send_email(current_user.email, &apos;Confirm Your Account&apos;,</div><div class="line">               &apos;auth/email/confirm&apos;, user=current_user, token=token)</div><div class="line">    flash(&apos;A new confirmation email has been sent to you by email.&apos;)</div><div class="line">    return redirect(url_for(&apos;main.index&apos;))</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/14/myblog-04/" data-id="cj5c7k3a80021m0u4qnilvva5" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-03" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/13/myblog-03/" class="article-date">
  <time datetime="2016-04-13T06:07:25.000Z" itemprop="datePublished">2016-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/13/myblog-03/">myblog-03 数据库和用户认证</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Flask-SQLAlchemy管理数据库"><a href="#Flask-SQLAlchemy管理数据库" class="headerlink" title="Flask-SQLAlchemy管理数据库"></a>Flask-SQLAlchemy管理数据库</h1><h2 id="初始化一个数据库"><a href="#初始化一个数据库" class="headerlink" title="初始化一个数据库"></a>初始化一个数据库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">from flask.ext.sqlalchemy import SQLAlchemy</div><div class="line"></div><div class="line">app.config[&quot;SQLALCHEMY_TRACK_MODIFICATIONS&quot;] = True</div><div class="line">app.config[&apos;SQLALCHEMY_DATABASE_URI&apos;] =&apos;mysql://username:password@hostname/database&apos;</div><div class="line">app.config[&apos;SQLALCHEMY_COMMIT_ON_TEARDOWN&apos;] = True</div><div class="line"></div><div class="line">db = SQLAlchemy(app)</div></pre></td></tr></table></figure>
<h2 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h2><p>模型表示程序使用的持久化实体，在<strong>ORM</strong>（对象关系映射：Object Relation Mapping）中，模型一般是一个python类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">class User(db.Model):</div><div class="line">    __tablename__ = &apos;users&apos;</div><div class="line">    id = db.Column(db.Integer, primary_key=True)</div><div class="line">    name = db.Column(db.String(20), unique=True)</div><div class="line"></div><div class="line">    def __repr__(self):</div><div class="line">        return &apos;&lt;User %r&gt;&apos; % self.name</div></pre></td></tr></table></figure></p>
<p><a href="http://herui.blog-harryx.cn/2016/03/12/flask-mysql/" target="_blank" rel="external">详细指令</a></p>
<h2 id="数据库创建一个表"><a href="#数据库创建一个表" class="headerlink" title="数据库创建一个表"></a>数据库创建一个表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create table users(</div><div class="line">    -&gt; id int(32) primary key auto_increment,</div><div class="line">    -&gt; name char(20) unique);</div></pre></td></tr></table></figure>
<h2 id="插入一个数据"><a href="#插入一个数据" class="headerlink" title="插入一个数据"></a>插入一个数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; insert users</div><div class="line">    -&gt; (id,name)</div><div class="line">    -&gt; values (1,harry);</div></pre></td></tr></table></figure>
<h2 id="集成Python-Shell"><a href="#集成Python-Shell" class="headerlink" title="集成Python Shell"></a>集成Python Shell</h2><p>注册一个<strong>make_shell_context()</strong>回调函数<br>不用每次都从Shell导入模型和实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from flask.ext.script import Shell</div><div class="line"></div><div class="line">def make_shell_context():</div><div class="line">    return dict(app=app, db=db, User=User)</div><div class="line">manager.add_command(&quot;shell&quot;, Shell(make_context=make_shell_context))</div></pre></td></tr></table></figure></p>
<h2 id="视图函数操作"><a href="#视图函数操作" class="headerlink" title="视图函数操作"></a>视图函数操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@app.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def index():</div><div class="line">    form = NameForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        user = User.query.filter_by(name=form.name.data).first()</div><div class="line">        if user is None:</div><div class="line">            flash(&quot;I think you are new here~&quot;)</div><div class="line">            user = User(name = form.name.data)</div><div class="line">            db.session.add(user)</div><div class="line">        session[&apos;name&apos;] = form.name.data</div><div class="line">        form.name.data = &apos;&apos;</div><div class="line">        return redirect(url_for(&apos;index&apos;))</div><div class="line">    return render_template(&apos;index.html&apos;, form=form, name=session.get(&apos;name&apos;))</div></pre></td></tr></table></figure>
<h2 id="创建迁移仓库"><a href="#创建迁移仓库" class="headerlink" title="创建迁移仓库"></a>创建迁移仓库</h2><h3 id="配置Flask-Migrate"><a href="#配置Flask-Migrate" class="headerlink" title="配置Flask-Migrate"></a>配置Flask-Migrate</h3><p>Flask-Migrate提供了一个MigrateCommand类，可以附加到Flask-Script的manager对象上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">from flask.ext.migrate import Migrate, MigrateCommand</div><div class="line"></div><div class="line"># ...</div><div class="line"></div><div class="line">migrate = Migrate(app, db)</div><div class="line">manager.add_command(&apos;db&apos;, MigrateCommand)</div></pre></td></tr></table></figure></p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>如果已经初始化过，需要删除之前的版本，并且要删除之前创建migrations文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql &gt; DROP TABLE alembic_version;</div></pre></td></tr></table></figure></p>
<p>初始化会创建migrations文件，所有迁移脚本都存放其中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(venv)$ python blog.py db init</div><div class="line">  Creating directory /home/herui/myblog/migrations ... done</div><div class="line">  Creating directory /home/herui/myblog/migrations/versions ... done</div><div class="line">  Generating /home/herui/myblog/migrations/alembic.ini ... done</div><div class="line">  Generating /home/herui/myblog/migrations/env.pyc ... done</div><div class="line">  Generating /home/herui/myblog/migrations/script.py.mako ... done</div><div class="line">  Generating /home/herui/myblog/migrations/env.py ... done</div><div class="line">  Generating /home/herui/myblog/migrations/README ... done</div><div class="line">  Please edit configuration/connection/logging settings in</div><div class="line">  &apos;/home/herui/myblog/migrations/alembic.ini&apos; before proceeding.</div></pre></td></tr></table></figure></p>
<h3 id="创建迁移脚本"><a href="#创建迁移脚本" class="headerlink" title="创建迁移脚本"></a>创建迁移脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(venv)$ python blog.py db migrate -m &quot;initial migration&quot;</div><div class="line">INFO  [alembic.runtime.migration] Context impl MySQLImpl.</div><div class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</div><div class="line">INFO  [alembic.env] No changes in schema detected.</div></pre></td></tr></table></figure>
<h3 id="更新数据库"><a href="#更新数据库" class="headerlink" title="更新数据库"></a>更新数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(venv)$ python blog.py db upgrade</div><div class="line">INFO  [alembic.runtime.migration] Context impl MySQLImpl.</div><div class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</div></pre></td></tr></table></figure>
<h1 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h1><h2 id="密码散列值"><a href="#密码散列值" class="headerlink" title="密码散列值"></a>密码散列值</h2><p>使用Werkzeug实现密码散列</p>
<ul>
<li><strong>generate_password_hash(password, method= pbkdf2:sha1 , salt_length=8)</strong>：<br>这个函数将原始密码作为输入，以字符串形式输出密码散列值，method，salt_length默认值能满足大部分需求</li>
<li><strong>check_password_hash(hash, password)</strong>：<br>这个函数参数是从数据库读回的密码散列值和用户输入的密码，返回值为True表示密码正确</li>
</ul>
<p>生成散列值后不能还原成原来的密码<br>在User模型中加入密码散列<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">from werkzeug.security import generate_password_hash, check_password_hash</div><div class="line"></div><div class="line">@property</div><div class="line">def password(self):</div><div class="line">    raise AttributeError(&apos;password is not a readable attribute&apos;)</div><div class="line"></div><div class="line">@password.setter</div><div class="line">def password(self, password):</div><div class="line">    self.password_hash = generate_password_hash(password)</div><div class="line"></div><div class="line">def verify_password(self, password):</div><div class="line">    return check_password_hash(self.password_hash, password)</div></pre></td></tr></table></figure></p>
<h2 id="创建认证蓝本"><a href="#创建认证蓝本" class="headerlink" title="创建认证蓝本"></a>创建认证蓝本</h2><p>对于不同的程序功能使用不同的蓝本<br>文件：<strong>app/auth/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from flask import Blueprint</div><div class="line"></div><div class="line">auth = Blueprint(&apos;auth&apos;, __name__)</div><div class="line"></div><div class="line">from . import views</div></pre></td></tr></table></figure></p>
<p>添加路由和视图函数<br>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">from flask import render_template</div><div class="line"></div><div class="line">from . import auth</div><div class="line"></div><div class="line">@auth.route(&apos;/login&apos;)</div><div class="line">def login():</div><div class="line">    return render_template(&apos;auth/login.html&apos;)</div></pre></td></tr></table></figure></p>
<p>文件：<strong>app/auth/login.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;login&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Login&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>在<strong>create_app()</strong>工厂函数中附加auth蓝本<br>url_prefix是可选参数，如果使用了这个参数，注册后蓝本中定义的所有路由都会加上前缀，这个例子为即/auth<br>文件：<strong>app/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">def create_app(config_name):</div><div class="line"></div><div class="line">    #...</div><div class="line"></div><div class="line">    from .auth import auth as auth_blueprint</div><div class="line">    app.register_blueprint(auth_blueprint, url_prefix=&apos;/auth&apos;)</div><div class="line"></div><div class="line">    return app</div></pre></td></tr></table></figure></p>
<h2 id="使用Flask-Login认证用户"><a href="#使用Flask-Login认证用户" class="headerlink" title="使用Flask-Login认证用户"></a>使用Flask-Login认证用户</h2><h3 id="准备用于登录的用户模型"><a href="#准备用于登录的用户模型" class="headerlink" title="准备用于登录的用户模型"></a>准备用于登录的用户模型</h3><p>Flask-Login提供了一个UserMixin类，包含一些方法的默认实现<br>文件：app/models.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">from flask.ext.login import UserMixin</div><div class="line"></div><div class="line">class User(UserMixin, db.Model):</div><div class="line">    __tablename__ = &apos;users&apos;</div><div class="line">    id = db.Column(db.Integer, primary_key = True)</div><div class="line">    email = db.Column(db.String(64), unique=True, index=True)</div><div class="line">    name = db.Column(db.String(64), unique=True, index=True)</div><div class="line">    password_hash = db.Column(db.String(128))</div></pre></td></tr></table></figure></p>
<h3 id="Flask-Login在工厂函数中初始化"><a href="#Flask-Login在工厂函数中初始化" class="headerlink" title="Flask-Login在工厂函数中初始化"></a>Flask-Login在工厂函数中初始化</h3><p>login_manager对象的session_protection可以设置为None、’basic’、’strong’，以提供不同的安全等级防止用户会话遭篡改<br>Flask-Login会记录客户端IP地址和浏览器的用户代理信息，如果发现异动就登出用户<br>login_view属性设置登录页面的端点，登录路由在蓝本中定义，要在前面加上蓝本名字(auth)<br>文件：<strong>app/<strong>init</strong>.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">from flask.ext.login import LoginManager</div><div class="line"></div><div class="line">login_manager = LoginManager()</div><div class="line">login_manager.session_protection = &apos;strong&apos;</div><div class="line">login_manager.login_view = &apos;auth.login&apos;</div><div class="line"></div><div class="line">def create_app(config_name):</div><div class="line">    # ...</div><div class="line">    login_manager.init_app(app)</div><div class="line">    # ...</div></pre></td></tr></table></figure></p>
<p>回调函数，使用指定标识符加载用户，返回用户对象或者None<br>文件：<strong>app/models.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from . import login_manager</div><div class="line"></div><div class="line">@login_manager.user_loader</div><div class="line">def load_user(user_id):</div><div class="line">    return User.query.get(int(user_id))</div></pre></td></tr></table></figure></p>
<h3 id="保护路由"><a href="#保护路由" class="headerlink" title="保护路由"></a>保护路由</h3><p>为了保护路由只让认证用户访问，Flask-Login提供了一个login_require修饰器<br>如果没有认证的用户访问这个路由，会拦截请求，把用户发往登录页面<br>用法如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">from flask.ext.login import login_required</div><div class="line"></div><div class="line">@app.route(&apos;/secret&apos;)</div><div class="line">@login_required</div><div class="line">def secret():</div><div class="line">    return &apos;Only authenticated users are allowed!&apos;</div></pre></td></tr></table></figure></p>
<h3 id="添加登录表单"><a href="#添加登录表单" class="headerlink" title="添加登录表单"></a>添加登录表单</h3><p>包含输入邮件、密码、记住无复选框和提交按钮<br>文件：<strong>app/auth/forms.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">from flask.ext.wtf import Form</div><div class="line">from wtforms import StringField, PasswordField, BooleanField, SubmitField</div><div class="line">from wtforms.validators import Required, Length, Email</div><div class="line"></div><div class="line">class LoginForm(Form):</div><div class="line">    email = StringField(&apos;Email&apos;, validators=[Required(), Length(1, 64),Email()])</div><div class="line">    password = PasswordField(&apos;Password&apos;, validators=[Required()])</div><div class="line">    remember_me = BooleanField(&apos;Keep me logged in&apos;)</div><div class="line">    submit = SubmitField(&apos;Log In&apos;)</div></pre></td></tr></table></figure></p>
<h3 id="登录页面：auth-login-html"><a href="#登录页面：auth-login-html" class="headerlink" title="登录页面：auth/login.html"></a>登录页面：auth/login.html</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Login&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Login&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div class=&quot;col-md-4&quot;&gt;</div><div class="line">    &#123;&#123; wtf.quick_form(form) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure>
<h3 id="在导航条中添加Sign-In和Sign-Out链接"><a href="#在导航条中添加Sign-In和Sign-Out链接" class="headerlink" title="在导航条中添加Sign In和Sign Out链接"></a>在导航条中添加Sign In和Sign Out链接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;</div><div class="line">&#123; % if current_user.is_authenticated() % &#125;</div><div class="line">&lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;auth.logout&apos;) &#125;&#125;&quot;&gt;Sign Out&lt;/a&gt;&lt;/li&gt;</div><div class="line">&#123; % else % &#125;</div><div class="line">&lt;li&gt;&lt;a href=&quot;&#123;&#123; url_for(&apos;auth.login&apos;) &#125;&#125;&quot;&gt;Sign In&lt;/a&gt;&lt;/li&gt;</div><div class="line">&#123; % endif % &#125;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure>
<h3 id="登入用户"><a href="#登入用户" class="headerlink" title="登入用户"></a>登入用户</h3><p>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">from flask import render_template, redirect, request, url_for, flash</div><div class="line">from flask.ext.login import login_user, logout_user</div><div class="line"></div><div class="line">from . import auth</div><div class="line">from ..models import User</div><div class="line">from .forms import LoginForm</div><div class="line"></div><div class="line">@auth.route(&apos;/login&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def login():</div><div class="line">    #创建一个**LoginForm()**对象</div><div class="line">    form = LoginForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        #如果电子邮件对应的用户存在</div><div class="line">        user = User.query.filter_by(email=form.email.data).first()</div><div class="line"></div><div class="line">        调用用户对象的verify_password()方法，检测输入的密码</div><div class="line">        if user is not None and user.verify_password(form.password.data):</div><div class="line">            #调用Flask-Login的login_user函数，把用户标记为已登录，第二个参数为“记住我”</div><div class="line">            login_user(user, form.remember_me.data)</div><div class="line">            return redirect(request.args.get(&apos;next&apos;) or url_for(&apos;main.index&apos;))</div><div class="line">        flash(&apos;Invalid username or password.&apos;)</div><div class="line"></div><div class="line">    #请求类型为GET时直接显示表单</div><div class="line">    return render_template(&apos;auth/login.html&apos;, form=form)</div></pre></td></tr></table></figure></p>
<h3 id="登出用户"><a href="#登出用户" class="headerlink" title="登出用户"></a>登出用户</h3><p>文件：<strong>app/auth/views.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">from flask.ext.login import logout_user, login_required</div><div class="line"></div><div class="line">@auth.route(&apos;/logout&apos;)</div><div class="line">@login_required</div><div class="line">def logout():</div><div class="line">    #调用Flask-Login中的logout_user()函数</div><div class="line">    logout_user()</div><div class="line">    flash(&apos;You have been logged out.&apos;)</div><div class="line">    return redirect(url_for(&apos;main.index&apos;))</div></pre></td></tr></table></figure></p>
<h3 id="测试登录"><a href="#测试登录" class="headerlink" title="测试登录"></a>测试登录</h3><p>在Shell界面注册用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(venv)$ python manage.py shell</div><div class="line">&gt;&gt;&gt; u = User(id=1,name=&quot;harry&quot;,email=&quot;harryx520@qq.com&quot;,password=&quot;lalala&quot;)</div><div class="line">&gt;&gt;&gt; db.session.add(u)</div><div class="line">&gt;&gt;&gt; db.session.commit()</div></pre></td></tr></table></figure></p>
<p>查看数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from users;</div><div class="line"></div><div class="line">|  1 | harryx520@qq.com | harry | pbkdf2:sha1:1(...)ffba4781 |</div></pre></td></tr></table></figure></p>
<h1 id="数据库常用操作"><a href="#数据库常用操作" class="headerlink" title="数据库常用操作"></a>数据库常用操作</h1><h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><p>创建普通有一个约束的表</p>
<p><code>person_id</code>作为主键约束</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create table person</div><div class="line">    -&gt; (person_id int(5) unsigned,</div><div class="line">    -&gt; name char(64),</div><div class="line">    -&gt; gender enum(&apos;M&apos;,&apos;F&apos;),</div><div class="line">    -&gt; state char(64),</div><div class="line">    -&gt; constraint pk_person primary key (person_id))default charset=utf8;</div></pre></td></tr></table></figure>
<p>创建具有外键约束的表</p>
<p><code>person_id</code>和<code>food</code>同时作为主键约束，<code>person_id</code>作为外键约束</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create table fav_food</div><div class="line">    -&gt; (person_id int(5) unsigned,</div><div class="line">    -&gt; food char(64),</div><div class="line">    -&gt; constraint pk_fav_food primary key (person_id, food),</div><div class="line">    -&gt; constraint fk_fav_food_person_id foreign key (person_id)</div><div class="line">    -&gt;      references person (person_id))default charset=utf8;</div></pre></td></tr></table></figure>
<h2 id="修改表"><a href="#修改表" class="headerlink" title="修改表"></a>修改表</h2><p>alter table用于修改已经存在的表定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; alter table person modify person_id int(5) unsigned auto_increment;</div></pre></td></tr></table></figure>
<h2 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h2><p>insert语句由三个部分构成：表的名称、列的名称、值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; insert into person</div><div class="line">    -&gt; (name, gender, state)</div><div class="line">    -&gt; values (&quot;harryx&quot;, &quot;M&quot;, &quot;中国&quot;);</div></pre></td></tr></table></figure>
<h2 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h2><p>可以指定列、指定顺序、设置条件</p>
<p>可以添加如下：</p>
<ul>
<li>字符，比如数字和字符串</li>
<li>表达式</li>
<li>调用内建函数</li>
<li>自定义函数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select person_id,name,gender from person where state=&quot;中国&quot;;</div><div class="line"></div><div class="line">mysql&gt; select * from person order by name;</div><div class="line"></div><div class="line">mysql&gt; select name,&quot;is&quot;,gender from person;</div><div class="line"></div><div class="line">mysql&gt; select version(),user(),database();</div></pre></td></tr></table></figure>
<h3 id="使用别名"><a href="#使用别名" class="headerlink" title="使用别名"></a>使用别名</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select name as n,gender as g from person;</div></pre></td></tr></table></figure>
<h3 id="去除重复"><a href="#去除重复" class="headerlink" title="去除重复"></a>去除重复</h3><p>注意，需要先排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select distinct person_id from fav_food;</div></pre></td></tr></table></figure>
<p>查询的表可以是临时表和虚拟表</p>
<p>在子表查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select e.name,e.state from (select * from person) as e;</div></pre></td></tr></table></figure>
<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>试图并不存储数据，只提供查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create view person_vw as</div><div class="line">    -&gt; select name from person;</div></pre></td></tr></table></figure>
<h3 id="表连接"><a href="#表连接" class="headerlink" title="表连接"></a>表连接</h3><p>内连接（不用inner关键字的话也是默认内连接）<br>不提供<code>on</code>关键字的话是笛卡尔积</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select p.name,f.food</div><div class="line">    -&gt; from person as p inner join fav_food as f</div><div class="line">    -&gt; on p.person_id = f.person_id;</div></pre></td></tr></table></figure>
<p>如果如果连接的表关键字是相同的可以使用<code>using</code>代替<code>on</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select p.name,p.state,f.food</div><div class="line">    -&gt; from person as p inner join fav_food as f</div><div class="line">    -&gt; using (person_id);</div></pre></td></tr></table></figure>
<p>连接多个表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select p.name,f.food,a.about</div><div class="line">    -&gt; from person as p inner join fav_food as f</div><div class="line">    -&gt; using(person_id)</div><div class="line">    -&gt; inner join about_me as a</div><div class="line">    -&gt; using(person_id);</div></pre></td></tr></table></figure>
<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><p>group by 根据某一列的值分组</p>
<p>having 对数据进行过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select p.name,count(f.food) </div><div class="line">    -&gt; from person as p inner join fav_food as f </div><div class="line">    -&gt; on p.person_id = f.person_id </div><div class="line">    -&gt; group by p.name;</div><div class="line">    -&gt; having p.name != &quot;harry&quot;;</div></pre></td></tr></table></figure>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>order by 用于对结果的列数据或者根据表达式结果排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//根据state排序</div><div class="line">mysql&gt; select * from person order by state;</div><div class="line"></div><div class="line">//根据state 和 name 排序</div><div class="line">mysql&gt; select * from person order by state,name;</div></pre></td></tr></table></figure>
<p>加上desc降序排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//降序排序</div><div class="line">mysql&gt; select * from person order by person_id desc;</div></pre></td></tr></table></figure>
<p>limit 限制显示行数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//person_id最大的显示前三行</div><div class="line">mysql&gt; select * from person order by person_id desc limit 3;</div></pre></td></tr></table></figure>
<h3 id="使用集合"><a href="#使用集合" class="headerlink" title="使用集合"></a>使用集合</h3><p>union 连接数据，排除重复项<br>union all 连接数据，保留重复项</p>
<p>intersect 交集，MySQL不支持</p>
<p>except 差集，MySQL不支持</p>
<h2 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h2><p>更新语句可以更新一行或者匹配到的多行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; update person</div><div class="line">    -&gt; set state=&quot;美国&quot;</div><div class="line">    -&gt; where person_id=4;</div></pre></td></tr></table></figure>
<p>级联更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql&gt; alter table fav_food</div><div class="line">    -&gt; add constraint fk_food_peron foreign key (person_id)</div><div class="line">    -&gt; references person(person_id)</div><div class="line">    -&gt; on update cascade;</div></pre></td></tr></table></figure>
<h2 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h2><p>如果被删除的列设置了外键，需要在子表添加外键时申明级联删除<br>在申明级联删除前先删除外键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysql&gt; alter table fav_food </div><div class="line">    -&gt; add constraint fk_person_id foreign key (person_id) </div><div class="line">    -&gt; references person (person_id) on delete cascade;</div><div class="line"></div><div class="line">mysql&gt; delete from person where name=&quot;o&quot;;</div></pre></td></tr></table></figure>
<h2 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h2><p>可以获取XML格式的数据，需要制定xml格式进入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -u flask -p --xml flaskdb</div></pre></td></tr></table></figure>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>关闭自动提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; set autocommit=0;</div></pre></td></tr></table></figure>
<p>关闭自动提交后，所有的SQL命令都在一个事务内<br>显式使用<code>rollback</code>回滚数据<br>显式使用<code>commit</code>提交数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; delete from person where person_id=4;</div><div class="line">mysql&gt; rollback;</div></pre></td></tr></table></figure>
<p>设置保存点</p>
<p>保存点拥有名字，可以拥有多个保存点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysql&gt; delete from fav_food where food=&quot;ice&quot;;</div><div class="line">mysql&gt; savepoint point_1;</div><div class="line">mysql&gt; delete from fav_food where food=&quot;apple&quot;;</div><div class="line">mysql&gt; savepoint point_2;</div><div class="line">mysql&gt; rollback to savepoint point_1;</div></pre></td></tr></table></figure>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>添加索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; alter table person</div><div class="line">    -&gt; add index ind_name (name);</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create index ind_name on person(name);</div></pre></td></tr></table></figure>
<p>查询索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show index from person \G</div></pre></td></tr></table></figure>
<p>删除某个索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; alter table person</div><div class="line">    -&gt; drop index ind_name;</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; drop index ind_name on person;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/13/myblog-03/" data-id="cj5c7k3a90024m0u43u0a806g" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/12/myblog-02/" class="article-date">
  <time datetime="2016-04-12T12:41:49.000Z" itemprop="datePublished">2016-04-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/12/myblog-02/">myblog-02 表单</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="表单"><a href="#表单" class="headerlink" title="表单"></a>表单</h1><h2 id="跨站请求伪造保护"><a href="#跨站请求伪造保护" class="headerlink" title="跨站请求伪造保护"></a>跨站请求伪造保护</h2><p>使用<strong>Flask-WTF</strong>扩展可以把处理表单<br>默认情况下，Flask-WTF可以保护所有表单免收<strong>CSRF</strong>(Cross-Site Request Forgery)攻击<br>为了实现CSRF保护，Flask-WTF需要程序设置一个密钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.config[&apos;SECRET_KEY&apos;] = &apos;hard to guess string&apos;</div></pre></td></tr></table></figure></p>
<h2 id="表单类"><a href="#表单类" class="headerlink" title="表单类"></a>表单类</h2><p>定义一个表单类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">from flask.ext.wtf import Form</div><div class="line">from wtforms import StringField, SubmitField</div><div class="line">from wtforms.validators import Required</div><div class="line"></div><div class="line">class NameForm(Form):</div><div class="line">    #StringField类表示属性type=&apos;text&apos;的&lt;input&gt;元素</div><div class="line">    #验证函数Required()确保提交的字段不为空</div><div class="line">    name = StringField(&apos;name: &apos;, validators=[Required()])</div><div class="line">    #SubmitField类表示type=&apos;submit&apos;的&lt;input&gt;元素</div><div class="line">    submit = SubmitField(&apos;Submit&apos;)</div></pre></td></tr></table></figure></p>
<h2 id="WTForms支持的HTML标准字段"><a href="#WTForms支持的HTML标准字段" class="headerlink" title="WTForms支持的HTML标准字段"></a>WTForms支持的HTML标准字段</h2><table>
<thead>
<tr>
<th>字段类型</th>
<th>说  明</th>
</tr>
</thead>
<tbody>
<tr>
<td>StringField</td>
<td>文本字段</td>
</tr>
<tr>
<td>TextAreaField</td>
<td>多行文本字段</td>
</tr>
<tr>
<td>PasswordField</td>
<td>密码文本字段</td>
</tr>
<tr>
<td>HiddenField</td>
<td>隐藏文本字段</td>
</tr>
<tr>
<td>DateField</td>
<td>文本字段,值为 datetime.date 格式</td>
</tr>
<tr>
<td>DateTimeField</td>
<td>文本字段,值为 datetime.datetime 格式</td>
</tr>
<tr>
<td>IntegerField</td>
<td>文本字段,值为整数</td>
</tr>
<tr>
<td>DecimalField</td>
<td>文本字段,值为 decimal.Decimal</td>
</tr>
<tr>
<td>FloatField</td>
<td>文本字段,值为浮点数</td>
</tr>
<tr>
<td>BooleanField</td>
<td>复选框,值为 True 和 False</td>
</tr>
<tr>
<td>RadioField</td>
<td>一组单选框</td>
</tr>
<tr>
<td>SelectField</td>
<td>下拉列表</td>
</tr>
<tr>
<td>SelectMultipleField</td>
<td>下拉列表,可选择多个值</td>
</tr>
<tr>
<td>FileField</td>
<td>文件上传字段</td>
</tr>
<tr>
<td>SubmitField</td>
<td>表单提交按钮</td>
</tr>
<tr>
<td>FormField</td>
<td>把表单作为字段嵌入另一个表单</td>
</tr>
<tr>
<td>FieldList</td>
<td>一组指定类型的字段</td>
</tr>
</tbody>
</table>
<h2 id="表单渲染成HTML"><a href="#表单渲染成HTML" class="headerlink" title="表单渲染成HTML"></a>表单渲染成HTML</h2><p>使用Bootstrap中的表单样式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</div><div class="line"></div><div class="line">&#123;&#123; wtf.quick_form(form) &#125;&#125;</div></pre></td></tr></table></figure></p>
<h2 id="在视图函数中处理表单"><a href="#在视图函数中处理表单" class="headerlink" title="在视图函数中处理表单"></a>在视图函数中处理表单</h2><p>视图函数需要渲染表单，并且要接收表单数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#修饰器中添加Methods参数，视图函数注册为GET和POST请求的处理程序</div><div class="line">@app.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def index():</div><div class="line">    #存放表单读取的名字</div><div class="line">    name = None</div><div class="line">    #NameForm实例来表示表单</div><div class="line">    form = NameForm()</div><div class="line">    #提交表单后如果能被验证函数接受，form.validate_on_submit()为True</div><div class="line">    if form.validate_on_submit():</div><div class="line">        name = form.name.data</div><div class="line">        form.name.data = &apos;&apos;</div><div class="line">    return render_template(&apos;index.html&apos;, form=form, name=name)</div></pre></td></tr></table></figure></p>
<h2 id="“session会话”"><a href="#“session会话”" class="headerlink" title="“session会话”"></a>“session会话”</h2><p>可以把数据储存在<strong>用户会话</strong>(session)中<br>默认情况，用户会话保存在cookie中，使用SECRET_KEY进行加密签名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">from flask import session,redirect,url_for</div><div class="line"></div><div class="line">@app.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def index():</div><div class="line">    form = NameForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        #变量值保存在会话</div><div class="line">        session[&apos;name&apos;] = form.name.data</div><div class="line">        #redirect()函数的参数是重定向的URL</div><div class="line">        #推荐使用url_for()</div><div class="line">        return redirect(url_for(&apos;index&apos;))</div><div class="line">    return render_template(&apos;index.html&apos;, form=form, name=session.get(&apos;name&apos;))</div></pre></td></tr></table></figure></p>
<h2 id="redirect-重定向实现一个简单的登陆界面"><a href="#redirect-重定向实现一个简单的登陆界面" class="headerlink" title="redirect()重定向实现一个简单的登陆界面"></a>redirect()重定向实现一个简单的登陆界面</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@app.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def index():</div><div class="line">    form = NameForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        session[&apos;name&apos;] = form.name.data</div><div class="line">        return redirect(url_for(&apos;login&apos;))</div><div class="line">    return render_template(&apos;index.html&apos;, form=form, name=session.get(&apos;name&apos;))</div><div class="line"></div><div class="line">@app.route(&apos;/nologin&apos;)</div><div class="line">def nologin():</div><div class="line">    abort(404)</div><div class="line"></div><div class="line">@app.route(&apos;/login&apos;)</div><div class="line">def login():</div><div class="line">    if not session.get(&apos;name&apos;):</div><div class="line">        return redirect(url_for(&apos;nologin&apos;))</div><div class="line">    return render_template(&apos;user.html&apos;, name=session.get(&apos;name&apos;))</div></pre></td></tr></table></figure>
<h2 id="flash消息"><a href="#flash消息" class="headerlink" title="flash消息"></a>flash消息</h2><p>调用<strong>flash()</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">from flask import url_for,flash</div><div class="line"></div><div class="line">flash(&quot;I think you are new here~&quot;)</div></pre></td></tr></table></figure></p>
<p>在模板中渲染flash消息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;% for message in get_flashed_messages() %&#125;</div><div class="line"></div><div class="line">  &lt;div class=&quot;alert alert-warning&quot;&gt;</div><div class="line">    &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;alert&quot;&gt;&amp;times;&lt;/button&gt;</div><div class="line">    &#123;&#123; message &#125;&#125;</div><div class="line">  &lt;/div&gt;</div><div class="line"></div><div class="line">&#123;% endfor %&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/12/myblog-02/" data-id="cj5c7k3a6001zm0u4uduat6co" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myblog-01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/10/myblog-01/" class="article-date">
  <time datetime="2016-04-10T09:14:02.000Z" itemprop="datePublished">2016-04-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/10/myblog-01/">myblog-01 开始</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p>根据《Flask Web开发：基于Python的Web应用开发实战》一书搭建自己的博客网站并运行在云服务器上</p>
<h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">|-myblog/ #根目录</div><div class="line">    |- app/ #Flask程序</div><div class="line">        |- auth/ #认证蓝本</div><div class="line">            |- __init__.py #创建蓝本</div><div class="line">            |- views.py #蓝本中的路由和视图函数</div><div class="line">        |- templates/ #模板文件</div><div class="line">        |- static/ #静态文件</div><div class="line">        |- main/</div><div class="line">            |- __init__.py #创建蓝本</div><div class="line">            |- errors.py #错误处理程序</div><div class="line">            |- forms.py #表单</div><div class="line">            |- views.py #路由</div><div class="line">        |- __init__.py #程序包构造文件，注册蓝本</div><div class="line">        |- email.py</div><div class="line">        |- models.py #数据库模型</div><div class="line">    |- migrations/ #数据库迁移脚本</div><div class="line">    |- tests/ #单元测试</div><div class="line">        |- __init__.py</div><div class="line">        |- test*.py</div><div class="line">    |- venv/ #Python虚拟环境</div><div class="line">    |- requirement.txt #列出所有依赖包</div><div class="line">    |- config.py #储存配置</div><div class="line">    |- manage.py #用于启动程序以及其他的程序任务</div></pre></td></tr></table></figure>
<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="Flask类"><a href="#Flask类" class="headerlink" title="Flask类"></a>Flask类</h2><p>Flask构造函数只有一个必须的参数，即程序主模块的名字<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from flask import Flask</div><div class="line">app = Flask(__name__)</div><div class="line"></div><div class="line">#启动</div><div class="line">app.run(debug=True)</div></pre></td></tr></table></figure></p>
<h2 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@app.route(&apos;/&apos;)</div><div class="line">def index():</div><div class="line">    return &quot;&lt;h1&gt;hello&lt;/h1&gt;&quot;</div></pre></td></tr></table></figure>
<h2 id="命令解析器"><a href="#命令解析器" class="headerlink" title="命令解析器"></a>命令解析器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">from flask.ext.script import Manager</div><div class="line">manager = Manager(app)</div><div class="line"></div><div class="line"># 开始</div><div class="line">manager.run()</div><div class="line"></div><div class="line">$ python blog.py runserver</div></pre></td></tr></table></figure>
<h1 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h1><h2 id="Jinja2模板引擎"><a href="#Jinja2模板引擎" class="headerlink" title="Jinja2模板引擎"></a>Jinja2模板引擎</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#文件: templates/index.html</div><div class="line">&lt;h1&gt;Hello&lt;/h1&gt;</div><div class="line"></div><div class="line">#文件: emplates/user.html</div><div class="line">&lt;h1&gt;&#123;&#123; name &#125;&#125;&apos;s blog&lt;/h1&gt;</div><div class="line"></div><div class="line"># 导入Jinja2</div><div class="line">from flask import render_template</div><div class="line"></div><div class="line">...</div><div class="line">return render_temptale(&apos;index.html&apos;)</div><div class="line"></div><div class="line">...</div><div class="line">return render_template(&apos;user.html&apos;, name=name)</div></pre></td></tr></table></figure>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>在模板中使用<strong></strong>结构表示一个变量<br>用过滤器修改变量，</p>
<h2 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h2><h2 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;% if user %&#125;</div><div class="line">    hello, &#123;&#123; user &#125;&#125;!</div><div class="line">&#123;% else %&#125;</div><div class="line">    hello, Stranger!s</div><div class="line">&#123;&#123;% endif %&#125;&#125;</div></pre></td></tr></table></figure>
<h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;ul&gt;</div><div class="line">    &#123;% for comment in comments %&#125;</div><div class="line">        &lt;li&gt;&#123;&#123; comment &#125;&#125;&lt;/li&gt;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure>
<h2 id="模块继承"><a href="#模块继承" class="headerlink" title="模块继承"></a>模块继承</h2><h3 id="templates-base-html文件"><a href="#templates-base-html文件" class="headerlink" title="templates/base.html文件"></a>templates/base.html文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#模板文件：templates/base.html</div><div class="line">#模板文件会预留出&#123;&#123;...&#125;&#125;块，子模板可以更改这些块</div><div class="line"></div><div class="line">&lt;html&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &#123;% block head %&#125;</div><div class="line">    &lt;title&gt;&#123;% block title %&#125;&#123;% endblock %&#125; - My Blog&lt;/title&gt; </div><div class="line">    &#123;% endblock %&#125;</div><div class="line">  &lt;/head&gt;</div><div class="line">  &lt;body&gt;</div><div class="line">    &#123;% block body %&#125;</div><div class="line">    &#123;% endblock %&#125;</div><div class="line">  &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<h3 id="templates-index-html文件"><a href="#templates-index-html文件" class="headerlink" title="templates/index.html文件"></a>templates/index.html文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#子模板文件：templates/index.html</div><div class="line">#使用&#123;% extends &quot;base.html&quot; %&#125;继承模板，然后重写相应的块</div><div class="line"></div><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Index&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block body %&#125;</div><div class="line">&lt;h1&gt;hello&lt;/h1&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure>
<h2 id="使用Flask-Bootstrap集成Twitter-Bootstrap"><a href="#使用Flask-Bootstrap集成Twitter-Bootstrap" class="headerlink" title="使用Flask-Bootstrap集成Twitter Bootstrap"></a>使用Flask-Bootstrap集成Twitter Bootstrap</h2><p><strong>初始化</strong>Flask-Bootstrap<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">from flask.ext.bootstrap import Bootstrap</div><div class="line">bootstrap = Bootstrap(app)</div></pre></td></tr></table></figure></p>
<h3 id="templates-base-html文件-1"><a href="#templates-base-html文件-1" class="headerlink" title="templates/base.html文件"></a>templates/base.html文件</h3><p>调用bootstrap<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">#从Flask-Bootstrap导入bootstrap/base.html</div><div class="line">&#123;% extends &quot;bootstrap/base.html&quot; %&#125;</div><div class="line"></div><div class="line">#页面标题</div><div class="line">&#123;% block title %&#125;Flasky&#123;% endblock %&#125;</div><div class="line"></div><div class="line">#导航条</div><div class="line">&#123;% block navbar %&#125;</div><div class="line">&lt;div class=&quot;navbar navbar-inverse&quot; role=&quot;navigation&quot;&gt;</div><div class="line">    &lt;div class=&quot;container&quot;&gt;</div><div class="line">        &lt;div class=&quot;navbar-header&quot;&gt;</div><div class="line">            &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;.navbar-collapse&quot;&gt;</div><div class="line">                &lt;span class=&quot;sr-only&quot;&gt;Toggle navigation&lt;/span&gt;</div><div class="line">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">            &lt;/button&gt;</div><div class="line">            &lt;a class=&quot;navbar-brand&quot; href=&quot;/&quot;&gt;Flasky&lt;/a&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;navbar-collapse collapse&quot;&gt;</div><div class="line">            &lt;ul class=&quot;nav navbar-nav&quot;&gt;</div><div class="line">                &lt;li&gt;&lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;/ul&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block content %&#125;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line">    &#123;% block page_content %&#125;&#123;% endblock %&#125;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h3 id="templates-index-html文件-1"><a href="#templates-index-html文件-1" class="headerlink" title="templates/index.html文件"></a>templates/index.html文件</h3><p>调用base.html，而不直接调用bootstrap<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Index&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Welcome to harry&apos;s blog&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;p&gt;some message&lt;/p&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h3 id="templates-user-html文件"><a href="#templates-user-html文件" class="headerlink" title="templates/user.html文件"></a>templates/user.html文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Index&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;&#123;&#123; name &#125;&#125;&apos;s blog&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;p&gt;some message&lt;/p&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure>
<h3 id="自定义错误页面"><a href="#自定义错误页面" class="headerlink" title="自定义错误页面"></a>自定义错误页面</h3><p>编写路由和视图函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@app.errorhandler(404)</div><div class="line">def page_not_found(e):</div><div class="line">    return render_template(&apos;404.html&apos;), 404</div></pre></td></tr></table></figure></p>
<p><strong>templates/404.html</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line"></div><div class="line">&#123;% block title %&#125;Index&#123;% endblock %&#125;</div><div class="line"></div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;page-header&quot;&gt;</div><div class="line">    &lt;h1&gt;Not found&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<h2 id="super"><a href="#super" class="headerlink" title="super()"></a>super()</h2><p>如果需要在已有的块中添加新内容，需要使用<strong>super()</strong>函数<br>使用<strong>url_for()</strong>函数，获得对应的URL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">url_for(&apos;user&apos;, name=&apos;join&apos;, _external=True)</div><div class="line">#返回:http://localhost:5000/user/join</div></pre></td></tr></table></figure></p>
<p>在<strong>templates/base.html</strong>添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;% block head %&#125;</div><div class="line">&#123;&#123; super() &#125;&#125;</div><div class="line">&lt;link rel=&quot;icon&quot; href=&quot;&#123;&#123; url_for(&apos;static&apos;, filename=&apos;shortcut.ico&apos;) &#125;&#125;&quot; type=&quot;image/x-icon&quot;&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p><a href="http://v3.bootcss.com/" target="_blank" rel="external">bootstrap中文网</a><br><a href="http://v3.bootcss.com/getting-started/" target="_blank" rel="external">bootstrap示例</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/10/myblog-01/" data-id="cj5c7k39w001um0u4w2aepn8v" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-service2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/08/service2/" class="article-date">
  <time datetime="2016-04-08T12:05:32.000Z" itemprop="datePublished">2016-04-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/08/service2/">服务器架设学习笔记二</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="网络设备"><a href="#网络设备" class="headerlink" title="网络设备"></a>网络设备</h1><ul>
<li><strong>主机硬件</strong>：考虑使用年限、省电、虚拟技术等</li>
<li><strong>Linux操作系统</strong>：考虑稳定性</li>
<li><strong>网卡</strong>：考虑服务器用途、驱动程序</li>
<li><strong>Switch/Hub</strong>：考虑主机数量、带宽、网管功能</li>
<li><strong>网线</strong>：考虑速度相配的等级、线缆形状、配线等</li>
<li><strong>无线网络设备</strong>：考虑速度、标准、安全性</li>
</ul>
<h1 id="网卡"><a href="#网卡" class="headerlink" title="网卡"></a>网卡</h1><ul>
<li>网卡名称：<strong>网卡</strong>(Network Interface Card，NIC)名称以网卡内核模块对应设备名称表示，默认网卡名为<strong>eth0</strong></li>
<li><p>linux网络参数配置文件：</p>
<ul>
<li><p><strong>ubuntu</strong>配置文件：</p>
<ul>
<li><strong>IP地址</strong>配置文件：<strong>/etc/network/interfaces</strong>，设置DHCP(动态主机配置协议)或者手动设置静态IP</li>
<li><p>以DHCP方式配置网卡：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">auto eth0</div><div class="line">iface eth0 inet dhcp</div></pre></td></tr></table></figure>
</li>
<li><p>为网卡配置静态IP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">auto eth0</div><div class="line">iface eth0 inet static</div><div class="line">address 192.168.0.100</div><div class="line">gateway 192.168.0.1</div><div class="line">netmask 255.255.255.0</div></pre></td></tr></table></figure>
</li>
<li><p><strong>/etc/init.d/networking restart</strong>，重启以生效</p>
</li>
<li><strong>/bin/hostname newname</strong>，设置主机名称</li>
</ul>
</li>
<li><p><strong>CentOS</strong>配置文件：<br><a href="http://www.cnblogs.com/vicowong/archive/2011/04/23/2025545.html" target="_blank" rel="external">http://www.cnblogs.com/vicowong/archive/2011/04/23/2025545.html</a></p>
</li>
</ul>
</li>
<li><p><strong>无线网络</strong>(Wireless Local Area Network，<strong>WLAN</strong>)：使用无线电波作为传输媒介，IEEE802.11/a/g/b/n/ac标准</p>
</li>
<li><strong>WIFI</strong>(Wireless Fidelity，无线保真)：WIFI是WLAN的一个标准</li>
<li><strong>无线接入点</strong>(Wireless Acess Point，简称<strong>AP</strong>)：就是俗称的无线路由器<h1 id="linux常用网络命令"><a href="#linux常用网络命令" class="headerlink" title="linux常用网络命令"></a>linux常用网络命令</h1></li>
<li><strong>ifconfig</strong>：查询、设置网卡的IP等相关参数</li>
<li><strong>ifup</strong>，<strong>ifdown</strong>：两个script文件，启动、关闭网络接口</li>
<li><strong>route</strong>：查看、配置路由表(route table)ping</li>
<li><strong>ip</strong>：整合式命令，可以直接修改上述提到的功能</li>
<li><strong>ping</strong>：通过ICMP检查网络状态</li>
<li><p><strong>netstat</strong>：查看网络连接和后门</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">-r：列出路由表，如同route</div><div class="line">-n：不使用主机名和服务名称，使用IP与port number，如同route -n</div><div class="line">-a：列出所有连接状态，包括tcp/udp/unix socket等</div><div class="line">-t：仅列出tcp数据包连接</div><div class="line">-u：仅列出udp数据包连接</div><div class="line">-l：仅列出已在监听(Listen)的服务的网络状态</div><div class="line">-p：列出PID与Programe的文件名</div><div class="line">-c：设置几秒后自动更新一次</div><div class="line"></div><div class="line">herui@herui-Compaq-511:~$ sudo netstat -tulnp</div><div class="line">显示已启动的网络服务</div></pre></td></tr></table></figure>
</li>
<li><p><strong>host</strong>：查询某个主机ip，(更详细的可以使用<strong>dig</strong>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-a：列出详细设置数据</div><div class="line"></div><div class="line">herui@herui-Compaq-511:~$ host www.baidu.com</div><div class="line">www.baidu.com is an alias for www.a.shifen.com.</div><div class="line">www.a.shifen.com has address 119.75.218.70</div><div class="line">www.a.shifen.com has address 119.75.217.109</div></pre></td></tr></table></figure>
</li>
<li><p><strong>nslookup</strong>：和host类似，不过还可以由dIP找出主机名</p>
</li>
<li><strong>nm-tool</strong>：查询详细网络参数，包括DNS</li>
<li><strong>wget</strong>：文字接口下载器</li>
<li><strong>tcpdump</strong>：文字接口数据包捕获器<h1 id="网络安全"><a href="#网络安全" class="headerlink" title="网络安全"></a>网络安全</h1></li>
<li><p><strong>防火墙</strong></p>
<ul>
<li>第一层防火墙：数据包过滤防火墙(Net Filter)，iptables这个软件提供的防火墙功能，针对TCP/IP数据包头部进行过滤</li>
<li>第二层防火墙：TCP Wrappers，网络数据包接收Super Daemons以及TCP Wrappers的检验</li>
</ul>
</li>
<li><p><strong>SELinux</strong>(Security Enhanced Linux，安全强化Linux)<br>针对网络服务的权限设置一些规则，让程序拥有的功能有限</p>
<ul>
<li><strong>主体</strong>(Subject)<br>SELinux主要管理的就是程序，主体就是程序(Process)</li>
<li><strong>目标</strong>(Object)<br>主题程序访问的目标资源一般是文件系统</li>
<li><strong>策略</strong>(Policy)<br>由于程序和文件数量庞大，SELinux会根据服务制定安全性策略，这些策略会有详细的规则(Rule)来指定资源访问与否</li>
<li><p><strong>安全性环境</strong>(Security Context)<br>主体和目标的安全性必须一致<br>查看安全性环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ls -Z</div></pre></td></tr></table></figure>
<p>安全性环境主要用冒号分为三个字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Identify：Role：Type</div><div class="line">身份识别：角色：类型</div></pre></td></tr></table></figure>
</li>
<li><p><strong>身份识别</strong>(Identify)：相当于帐号方面的身份识别</p>
<ul>
<li><strong>root</strong>：表示<strong>root帐号身份</strong></li>
<li><strong>system_u</strong>：表示系统程序方面的识别，通常指<strong>程序</strong></li>
<li><strong>user_u</strong>：代表<strong>一般用户</strong>帐号相关的身份</li>
</ul>
</li>
<li><strong>角色</strong>(Role)：通过角色字段，我们可以知道这个数据是代表程序、文件资源还是用户<ul>
<li><strong>object_r</strong>：代表的是<strong>文件或者目录</strong>等文件资源，是最常见的</li>
<li><strong>system_r</strong>：代表<strong>程序</strong>，不过，<strong>一般用户</strong>也会被指定称为system_r</li>
</ul>
</li>
<li><p><strong>类型</strong>(Type)：在默认(targeted)策略中，身份识别(Identify)、角色(Role)基本上是不重要的，<strong>重要的在于这个类型(Type)字段</strong>，基本上，一个程序能不能读取到文件资源，与类型字段有关，类型字段在文件和程序中的定义不太相同</p>
<ul>
<li>Type：在文件资源中(Object)中称为类型(Type)</li>
<li><p>Domain：在主体程序(Subject)中称为域(Domain)</p>
<p>Domain要与Type搭配才能顺利读取文件资源</p>
</li>
</ul>
<p>Identify | Role | 意义<br>———–|——–|———<br>root | system_r | 代表供root帐号登录时所取得的权限<br>system_u | system_r | 由于是系统帐号，因此是非交互式的系统运行程序<br>user_u | system_r | 一般可登录用户的程序</p>
</li>
</ul>
</li>
</ul>
<h1 id="WWW服务器"><a href="#WWW服务器" class="headerlink" title="WWW服务器"></a>WWW服务器</h1><ul>
<li><strong>ubuntu apache2配置</strong><br>apache 针对服务器环境的配置文件<br><strong>/etc/apache2/apache2.conf</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ServerRoot  </div><div class="line">#服务器设置的最顶层</div><div class="line">PidFile $&#123;APACHE_PID_FILE&#125;</div><div class="line">#放置pid的文件</div><div class="line">Timeout 300</div><div class="line">#当持续连接等待300秒后该次连接中断</div><div class="line">KeepAlive On</div><div class="line">是否允许持续性连接，持续性连接就是一次TCP连接可以具有多个文件资料传送要求</div><div class="line">MaxKeepAliveRequests 100</div><div class="line">#当KeepAlive设置为On时，这个数值决定该次连接能够传输的最大传输数量</div><div class="line">KeepAliveTimeout 5</div><div class="line">#允许KeepAlive前提下，该次连接在最后一次传输后等待的秒数</div></pre></td></tr></table></figure>
</li>
</ul>
<p>VH(虚拟主机)的设置<br><strong>/etc/apache2/sites-available/</strong><br>设置完之后导入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#sudo a2dissite example.com.conf</div><div class="line">sudo a2ensite example.com.conf</div><div class="line">sudo service apache2 restart</div></pre></td></tr></table></figure></p>
<p>针对模块功能的配置<br><strong>/etc/apache2/mods-available/mpm_prefork.conf</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;IfModule mpm_prefork_module&gt;</div><div class="line">        StartServers                     2</div><div class="line">        #启动Apache时启动process的数量</div><div class="line">        MinSpareServers           6</div><div class="line">        MaxSpareServers          12</div><div class="line">        #代表最大与最小备用程序数量</div><div class="line">        MaxRequestWorkers         30</div><div class="line">        #每个程序能够提供的最大传输次数要求</div><div class="line">        MaxConnectionsPerChild   3000</div><div class="line">&lt;/IfModule&gt;</div></pre></td></tr></table></figure></p>
<p>参考<br><a href="https://segmentfault.com/a/1190000002517469" target="_blank" rel="external">https://segmentfault.com/a/1190000002517469</a><br><a href="https://www.linode.com/docs/websites/apache/apache-web-server-on-ubuntu-14-04" target="_blank" rel="external">https://www.linode.com/docs/websites/apache/apache-web-server-on-ubuntu-14-04</a><br><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-the-apache-web-server-on-an-ubuntu-or-debian-vps" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-configure-the-apache-web-server-on-an-ubuntu-or-debian-vps</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/08/service2/" data-id="cj5c7k435004im0u4fnqzmxn4" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-service1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/05/service1/" class="article-date">
  <time datetime="2016-04-05T06:55:30.000Z" itemprop="datePublished">2016-04-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/05/service1/">服务器架设学习笔记一</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p><strong>常见案例</strong></p>
<ul>
<li><strong>网络环境</strong>：环境里面的计算机构成网络，能够对外提供访问</li>
<li><strong>对外网络</strong>：环境中只有一个可以对外连接，比如光纤宽带</li>
<li><strong>额外服务</strong>：环境中所有计算机都可以上网，其中一台作为文件服务器共享数据</li>
<li><strong>服务器管理</strong>：这台服务器开放连接机制，远程计算机可以接连维护</li>
<li><strong>防火墙管理</strong>：因为担心作为文件共享的服务器受到攻击，针对来源IP进行登录控制</li>
<li><strong>帐号管理</strong>：由于数据有共享和隐私之分，因此要为每个人提供专用帐号</li>
<li><strong>后台分析</strong>：由于担心系统出问题，需要自动监测分析磁盘和日志文件</li>
</ul>
<h1 id="网络基础"><a href="#网络基础" class="headerlink" title="网络基础"></a>网络基础</h1><ul>
<li><strong>局域网络</strong>(LAN)：节点之间传输距离较近，使用较为昂贵的传输介质(网线、光纤)，传输速度较快</li>
<li><strong>广域网</strong>(WAN)：传输距离较远，连接介质成本较低(电话线)、用于E_mail、FTP、WWW等功能</li>
<li><strong>OSI七层协议</strong>：一种计算机网络协议，分为：应用层、表示层、会话层、传输层、网络层、数据链路层、物理层</li>
<li><strong>TCP/IP</strong>：OSI七层协议简化版，分为：应用层(HTTP、FTP、SSH等)、传输层(TCP、UDP)、网络层(IP、ICMP(因特网信息控制协议))、网络接口层(LAN、WAN)</li>
<li><strong>PPP协议</strong>(point_to_point protocol)：调制解调器拨号上网使用的协议</li>
<li><strong>整合服务数字网络</strong>(ISDN)：利用电话线连接网络，通过多信道整合提高速度</li>
<li><strong>PPPoE协议</strong>(PPP over Ethernet)：<strong>ADSL</strong>(非对称数字环路)使用的协议，使用电话线高频部分，将PPP仿真在以太网上，因此需要一张网卡连接到调制解调器</li>
<li><strong>电缆调制解调器</strong>(Cable Modem)：通过有线电视使用的缆线作为网络介质(Cable)，具有调制解调器(Modem)连接至互联网</li>
</ul>
<h2 id="以太网"><a href="#以太网" class="headerlink" title="以太网"></a>以太网</h2><ul>
<li>每个以太网卡都具有第一无二的卡号，即<strong>MAC</strong>(Media Access Control)</li>
<li>以太网传输协议：<strong>CSMA/CD</strong></li>
<li><strong>数据帧</strong>：CSMA/CD数据传输格式</li>
<li><strong>MTU</strong>：最大传输单位，数据帧的最大容量，标准定义为1500</li>
<li><strong>集线器</strong>：一种网络共享设备，网络介质在单一时间，仅能被一台主机使用</li>
<li><strong>交换器</strong>：交换器内部有一个特别的内存，能够记录每个端口连接的MAC地址，交换器不是共享设备</li>
</ul>
<h2 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h2><ul>
<li>目前因特网环境有两种IP版本，分别是<strong>IPv4</strong>和<strong>IPv6</strong>，IPv4有32位，IPv6有128位</li>
<li>数据帧内容：主要包括<strong>TTL</strong>(time to live 生存时间)、<strong>Protocol</strong>(协议代码，比如TCP、UDP)，<strong>来源地址</strong>(IP)，<strong>目标地址</strong>(IP)</li>
<li>IP地址组成：XX.XX.XX.XX前三组数字是网络号码(Net_ID)，后面一组数字是主机号码(Host_ID)，在同一物理网内，主机IP具有相同Net_ID和独特的Host_ID</li>
<li>IP地址限制：在<strong>同一网段</strong>内，<strong>Net_ID是不变的</strong>，<strong>Host_ID是不可重复的</strong>，不能全为1或者全为0，全为0是<strong>整个网段的地址</strong>(Network IP),全为1是<strong>广播地址</strong>(Broadcast IP)</li>
<li><p>IP地址分级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Class A :   0.xx.xx.xx ~ 127.xx.xx.xx</div><div class="line">Class B : 128.xx.xx.xx ~ 191.xx.xx.xx</div><div class="line">Class C : 192.xx.xx.xx ~ 223.xx.xx.xx</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p>IP地址种类：IP地址分为<strong>公共IP</strong>(Public IP)和<strong>私有IP</strong>(Private IP)，公共IP可以连上Internet，私有IP不能连接Internet，主要用于局域网内主机连接规划</p>
</li>
<li><p>私有IP地址：在Class A、B、C各保留一段作为私有IP，不能作为Internet连接使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Class A :  10.  0.  0.  0 ~  10.255.255.255</div><div class="line">Class B : 172. 16.  0.  0 ~ 172. 31.255.255</div><div class="line">Class C : 192.168.  0.  0 ~ 192.168.255.255</div></pre></td></tr></table></figure>
</li>
<li><p><strong>子网掩码</strong>：实现子网的划分<br>使用全部Host_ID划分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">第一个  IP：11000000.10101000.00000000.00000000</div><div class="line">最后一个IP：11000000.10101000.00000000.11111111</div><div class="line">子网掩码  ：11111111.11111111.11111111.00000000 =&gt;255.255.255.0</div></pre></td></tr></table></figure>
</li>
</ul>
<p>使用7位Host_ID划分<br>第一个子网<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">第一个  IP：11000000.10101000.00000000.00000000</div><div class="line">最后一个IP：11000000.10101000.00000000.01111111</div><div class="line">子网掩码  ：11111111.11111111.11111111.10000000 =&gt;255.255.255.128</div></pre></td></tr></table></figure></p>
<p>第二个子网<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">第一个  IP：11000000.10101000.00000000.10000000</div><div class="line">最后一个IP：11000000.10101000.00000000.11111111</div><div class="line">子网掩码  ：11111111.11111111.11111111.10000000 =&gt;255.255.255.128</div></pre></td></tr></table></figure></p>
<h1 id="数据传输"><a href="#数据传输" class="headerlink" title="数据传输"></a>数据传输</h1><ul>
<li><strong>路由</strong>(Route)：实现不同网段的数据通信</li>
<li><strong>路由表</strong>(Route table)：主机发送数据的参考，每台主机都有路由表</li>
<li>路由：</li>
</ul>
<ol>
<li>主机查询IP数据包目标IP地址</li>
<li>查询是否位于本机所在的网络路由表中，如果在，直接通过局域网发送给目标主机</li>
<li>查询本机默认路由，如果没有其他符合设置值，发送IP数据包到<strong>Default Gateway</strong>(网关)</li>
<li>送出数据包至Default Gateway后，不理会数据包流向</li>
</ol>
<ul>
<li><p>查询主机路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">herui@herui-Compaq-511:~$ route [-n]</div><div class="line">参数:</div><div class="line">-n：将主机以IP的方式显示</div><div class="line">herui@herui-Compaq-511:~$ route</div><div class="line">内核 IP 路由表</div><div class="line">目标            网关            子网掩码        标志  跃点   引用  使用 接口</div><div class="line">default         192.168.1.1     0.0.0.0         UG    0      0    0 wlan0</div><div class="line">192.168.1.0     *               255.255.255.0   U     9      0    0 wlan0</div><div class="line">herui@herui-Compaq-511:~$ route -n</div><div class="line">内核 IP 路由表</div><div class="line">目标            网关            子网掩码        标志  跃点   引用  使用 接口</div><div class="line">0.0.0.0         192.168.1.1     0.0.0.0         UG    0      0    0 wlan0</div><div class="line">192.168.1.0     0.0.0.0         255.255.255.0   U     9      0    0 wlan0</div></pre></td></tr></table></figure>
</li>
<li><p><strong>ARP</strong>(Adress Resolution Protocol网络地址解析)：用于主机了解某个IP配置与哪个以太网卡上，并缓存信息到ARP table中</p>
</li>
<li><p>查看主机上缓存的IP/MAC对应ARP table</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">herui@herui-Compaq-511:~$ arp -n</div><div class="line">地址                 类型    硬件地址            标志  Mask       接口</div><div class="line">192.168.1.1          ether   e0:05:c5:cf:0f:e2   C               wlan0</div></pre></td></tr></table></figure>
</li>
<li><p><strong>数据包</strong>之间的关系：数据包长度：MAC总长度&gt;IP总长度&gt;TCP总长度</p>
</li>
<li><strong>ICMP</strong>(Internet Control Message Protocol，英特网信息控制协议)：ICMP是一个错误检测与报告机制，通过IP数据包进行数据传送<h2 id="TCP数据包内容"><a href="#TCP数据包内容" class="headerlink" title="TCP数据包内容"></a>TCP数据包内容</h2></li>
<li><strong>端口</strong>(Port)：IP数据包连接两端的位置，例如WWW服务器开放Client连接的端口</li>
<li><strong>数据包序号</strong>(Sequence Number)：如果TCP数据太大，大于IP数据包容许程度，就需要进行分段，<strong>数据包序号记录每个包的序号</strong>，让接收端能够重新组合</li>
<li><strong>回应序号</strong>(Acknowledge Number)：当发送端收到这个确认码时，就确定之前的数据包已经被正确收下</li>
<li><strong>数据补偿</strong>(Data Offset)：说明数据包字段的起始位置</li>
<li><strong>控制标志码</strong>(Code，Control Flag)：说明数据包状态和动作<ul>
<li><strong>URG</strong>(Urgent)：若为1代表数据包为<strong>紧急数据包</strong>，接收端要紧急处理</li>
<li><strong>ACK</strong>(Acknowledge)：若为1则代表数据包为<strong>响应数据包</strong></li>
<li><strong>PSH</strong>(Push function)：若为1代表要求对方立即传送缓冲区的对应数据包，无须等待缓冲区满</li>
<li><strong>RST</strong>(Reset)：如果为1表示连接会马上结束，即<strong>强制结束</strong></li>
<li><strong>SYN</strong>(Synchronous)：若为1表示发送端希望双方建立同步处理，表示要<strong>主动连接</strong>对方</li>
<li><strong>FIN</strong>(Finish)：若为1表示传送结束，通知对方数据完毕，等待对方响应</li>
</ul>
</li>
<li><strong>Window</strong>(滑动窗口)：为0时表示缓冲器已满</li>
<li><strong>Checksum</strong>(确认校验码)：数据发送出去之前，会进行一个校验动作，接收者收到后再次验证，对比与原发的校验码是否相符，若不相符，要求对方重发</li>
<li><strong>Urgent Pointer</strong>(紧急数据)：Code字段内的URG=1时才产生作用，说明紧急数据位置</li>
<li><strong>Options</strong>(任意数据)：表示接收端可接收最大数据段容量，不使用则为任意大小，此字段不常用</li>
<li><strong>Padding</strong>(补足字段)：Option非固定，补齐为32bits<h2 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h2></li>
<li><p><strong>通信端口</strong>：提供服务的位置</p>
<blockquote>
<p>IP是门牌，TCP是楼层，真正提供服务的是楼层里面的人(程序)</p>
</blockquote>
</li>
<li><p><strong>特权端口</strong><br>因特网有很多规范好的固定端口port，通常小于1024，提供网络服务<br>Linux环境下，网络服务端口号(Port Number)默认写在/etc/services内</p>
<p>  端口 | 服务名称和内容<br>  ——-|————<br>  20 | FTP-data，文件传输协议主动数据传输端口<br>  21 | FTP，文件传输协议的命令端口<br>  22 | SSH，较为安全的远程连接服务<br>  23 | Telnet，早期的远程连接服务器软件<br>  24 | SMTP，简单邮件传输协议，作为Mail Server的端口<br>  53 | DNS，域名服务器<br>  80 | WWW，全球信息网服务<br>  110 | POP3，邮件接收协议，办公室用的收信软件通过它<br>  443 | HTTPS，有安全加密的WWW服务器</p>
</li>
<li><p><strong>Socket Pair</strong>：IP:port，例如herui.blog-harryx.cn:80</p>
<h2 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h2></li>
</ul>
<ol>
<li>数据包<strong>发起</strong><br>客户端发送一个数据包，TCP报头<strong>SYN=1</strong>，序号(Sequence number=<strong>10001</strong>)</li>
<li>数据包<strong>接收与确认</strong><br>服务器收到数据包后，制作一个同样有<strong>SYN=1</strong>，<strong>ACK=1</strong>的数据包(ack=Sequence+1=<strong>10002</strong>)，为了确认客户端也能收到数据包，发送一个Sequence(seq=<strong>20001</strong>)给客户端</li>
<li><strong>回送</strong>确认数据包<br>当客户端收到来自服务器端的<strong>ACK</strong>(10002)后就能确认之前那个数据包被接收了，同时回送<strong>ACK=1</strong>，ack=20001+1=<strong>20001</strong>给服务器</li>
<li>取得<strong>最后确认</strong><br>当服务器收到<strong>ACK=1</strong>，<strong>ack=20002</strong>，就可以建立连接了<h2 id="无连接的UDP协议"><a href="#无连接的UDP协议" class="headerlink" title="无连接的UDP协议"></a>无连接的UDP协议</h2><strong>UDP(User Datagram Protocol 用户数据报协议)</strong>不提供可靠传输，因为接收端收到数据包后不会回复响应数据包(ACK)给发送端，传输速度快，适用于需要实时反应的一些数据流，比如影像实时传输等<h2 id="网络防火墙"><a href="#网络防火墙" class="headerlink" title="网络防火墙"></a>网络防火墙</h2>网络防火墙分析数据包报头，设定分析规则，丢弃特定IP、端口或者特定数据包信息(SYN/ACK等)的数据包<br>OSI七层协议中每层可阻挡的数据有</li>
</ol>
<ul>
<li>第二层：数据链路层，针对来源与目标<strong>MAC</strong>进行阻挡</li>
<li>第三层：网络层，针对来源与目标<strong>IP</strong>，以及<strong>ICMP</strong>(因特网信息控制协议)的类别进行阻挡</li>
<li>第四层：针对<strong>TCP/UDP的端口</strong>进行阻挡，也可以针对TCP状态(Code)来处理</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/05/service1/" data-id="cj5c7k438004nm0u4bj1i4s2z" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-video" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/04/video/" class="article-date">
  <time datetime="2016-04-04T08:20:00.000Z" itemprop="datePublished">2016-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/04/video/">远程视频</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><p>实现同一局域网内单向远程视频<br>关键步骤是采集的BGR格式图片要转化成JPG格式后再传输<br>接收端将接收到的图片转化为BGR动态显示<br>客户端采集摄像头数据，加密并发送给服务器端</p>
<h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line"></div><div class="line">&quot;客户端&quot;</div><div class="line"></div><div class="line">from socket import *</div><div class="line">import time</div><div class="line">import cv2</div><div class="line">import numpy as np</div><div class="line">import sys</div><div class="line">import pickle,StringIO</div><div class="line">from PIL import Image</div><div class="line"></div><div class="line">HOST = &quot;localhost&quot;</div><div class="line">PORT = 21575</div><div class="line">ADDR = (HOST,PORT)</div><div class="line"></div><div class="line">tcpCliSock = socket(AF_INET, SOCK_STREAM)    #创建客户套接字</div><div class="line">try:</div><div class="line">    tcpCliSock.connect(ADDR)    #连接服务器</div><div class="line">except:</div><div class="line">    print &quot;服务器连接失败&quot;</div><div class="line">    sys.exit(1)</div><div class="line"></div><div class="line">cap = cv2.VideoCapture(0)</div><div class="line">cv2.namedWindow(&quot;v&quot;)</div><div class="line"></div><div class="line">ret = cap.set(3,320)</div><div class="line">ret = cap.set(4,240)</div><div class="line"></div><div class="line">try:</div><div class="line">    while True:</div><div class="line">        ret, frame = cap.read()</div><div class="line">        img = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)</div><div class="line">        img = Image.fromarray(img)</div><div class="line">        src = StringIO.StringIO()</div><div class="line">        img.save(src,&quot;JPEG&quot;)</div><div class="line">        value = src.getvalue()</div><div class="line">        src.close()</div><div class="line">        value = value.replace(&quot;\n&quot;,&quot;\-n&quot;)</div><div class="line">        tcpCliSock.sendall(value+&quot;\n&quot;)   #发送数据</div><div class="line">        time.sleep(0.1)</div><div class="line">except:</div><div class="line">    tcpCliSock.close()</div></pre></td></tr></table></figure>
<h1 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h1><p>服务器端接收摄像头数据，解码并显示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line"></div><div class="line">&quot;服务器端&quot;</div><div class="line"></div><div class="line">from socket import *</div><div class="line">import time</div><div class="line">import numpy as np</div><div class="line">import sys,cv2</div><div class="line">import pickle,StringIO</div><div class="line">from PIL import Image</div><div class="line"></div><div class="line">HOST = &quot;localhost&quot;</div><div class="line">PORT = 21575</div><div class="line">ADDR = (HOST,PORT)</div><div class="line"></div><div class="line">tcpSerSock = socket(AF_INET, SOCK_STREAM)    #创建服务器套接字</div><div class="line">tcpSerSock.bind(ADDR)   #地址绑定到套接字，地址是双元素元祖</div><div class="line">tcpSerSock.listen(5)    #监听，最多允许5个客户连接到服务器</div><div class="line"></div><div class="line">while True:</div><div class="line">    try:</div><div class="line">        tcpCliSock, addr = tcpSerSock.accept()  #接受客户连接</div><div class="line"></div><div class="line">        while True:</div><div class="line">            try:</div><div class="line">                data = tcpCliSock.recv(1024*1024).strip()</div><div class="line">                data = data.replace(&quot;\-n&quot;,&quot;\n&quot;)</div><div class="line">                src = StringIO.StringIO()</div><div class="line">                src.write(data)</div><div class="line">                src.seek(0)</div><div class="line">                out = Image.open(src).convert(&quot;RGB&quot;)</div><div class="line">            except:</div><div class="line">                continue</div><div class="line">            cv_img = np.array(out)</div><div class="line">            cv_img = cv2.cvtColor(cv_img, cv2.COLOR_BGR2RGB)</div><div class="line">            cv2.imshow(&quot;v&quot;,cv_img)</div><div class="line">            if cv2.waitKey(25) &amp; 0xFF == ord(&apos;q&apos;):</div><div class="line">            	break</div><div class="line">            src.close()</div><div class="line">            if not data:</div><div class="line">                print &quot;客户端已经退出&quot;</div><div class="line">                break</div><div class="line">    except KeyboardInterrupt, e:</div><div class="line">        print &quot;\n&quot;</div><div class="line">        print &quot;byebye~&quot;</div><div class="line">        tcpSerSock.close()</div><div class="line">        try:</div><div class="line">            tcpCliSock.close()</div><div class="line">        except:</div><div class="line">            print &quot;没有客户端连接&quot;</div><div class="line">        sys.exit(1)</div></pre></td></tr></table></figure></p>
<p>可以在VPS上建立服务器作为中转站，实现非局域网内远程视频</p>
<p>参考<br><a href="http://blog.csdn.net/huhumama0/article/details/9164873" target="_blank" rel="external">http://blog.csdn.net/huhumama0/article/details/9164873</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/04/video/" data-id="cj5c7k43m0050m0u4vxalpyp5" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/socket/">socket</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Labels</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/acg/">acg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/basic/">basic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bb/">bb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/haskell/">haskell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jquery/">jquery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sicp/">sicp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/soket/">soket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spider/">spider</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 10px;">C#</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/acg/" style="font-size: 10px;">acg</a> <a href="/tags/basic/" style="font-size: 10px;">basic</a> <a href="/tags/bb/" style="font-size: 10px;">bb</a> <a href="/tags/c/" style="font-size: 12.86px;">c++</a> <a href="/tags/django/" style="font-size: 12.86px;">django</a> <a href="/tags/flask/" style="font-size: 20px;">flask</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/haskell/" style="font-size: 10px;">haskell</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/javascript/" style="font-size: 17.14px;">javascript</a> <a href="/tags/jquery/" style="font-size: 15.71px;">jquery</a> <a href="/tags/linux/" style="font-size: 11.43px;">linux</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mysql/" style="font-size: 12.86px;">mysql</a> <a href="/tags/python/" style="font-size: 18.57px;">python</a> <a href="/tags/sicp/" style="font-size: 10px;">sicp</a> <a href="/tags/socket/" style="font-size: 11.43px;">socket</a> <a href="/tags/soket/" style="font-size: 10px;">soket</a> <a href="/tags/spider/" style="font-size: 14.29px;">spider</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archieven</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recente berichten</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/03/effective-C/">effective_C++</a>
          </li>
        
          <li>
            <a href="/2017/04/01/traceback/">异常处理</a>
          </li>
        
          <li>
            <a href="/2017/04/01/logging/">打印日志</a>
          </li>
        
          <li>
            <a href="/2017/04/01/construct/">二进制数据处理</a>
          </li>
        
          <li>
            <a href="/2017/03/29/Csharp/">C#面向对象</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 HeRui<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>